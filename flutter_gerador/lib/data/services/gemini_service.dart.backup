import 'dart:async';
import 'dart:math';
import 'package:flutter/foundation.dart';
import 'package:dio/dio.dart';
import 'package:flutter_gerador/data/models/script_config.dart';
import 'package:flutter_gerador/data/models/script_result.dart';
import 'package:flutter_gerador/data/models/generation_progress.dart';
import 'package:flutter_gerador/data/models/localization_level.dart';
import 'package:flutter_gerador/data/services/name_generator_service.dart';
import 'package:flutter_gerador/data/models/debug_log.dart';

// üöÄ NOVOS M√ìDULOS DE PROMPTS (Refatora√ß√£o v2.0)
import 'package:flutter_gerador/data/services/prompts/base_rules.dart';
import 'package:flutter_gerador/data/services/prompts/character_rules.dart';
import 'package:flutter_gerador/data/services/prompts/structure_rules.dart';
import 'package:flutter_gerador/data/services/prompts/youtube_rules.dart';
import 'package:flutter_gerador/data/services/prompts/prompt_builder.dart';
import 'package:flutter_gerador/data/services/prompts/main_prompt_template.dart';

/// üìù Helper padronizado para logs (mant√©m emojis em debug, limpa em produ√ß√£o)
void _log(String message, {String level = 'info'}) {
  if (kDebugMode) {
    // Debug: mant√©m emojis e formata√ß√£o original
    debugPrint(message);
  } else if (level == 'error' || level == 'critical') {
    // Produ√ß√£o: apenas erros cr√≠ticos, sem emojis
    final cleaned = message
        .replaceAll(RegExp(r'[üö®üî•‚úÖ‚ùå‚ö†Ô∏èüí°üìäüéØüìùüîóüìö]'), '')
        .trim();
    debugPrint('[${level.toUpperCase()}] $cleaned');
  }
  // Produ√ß√£o: info/warning n√£o logam (evita spam)
}

/// üöÄ FUN√á√ÉO TOP-LEVEL para filtrar par√°grafos duplicados em Isolate
String _filterDuplicateParagraphsStatic(Map<String, dynamic> params) {
  final String existing = params['existing'] as String;
  final String addition = params['addition'] as String;

  if (addition.trim().isEmpty) return '';

  // Comparar apenas √∫ltimos ~5000 caracteres
  final recentText = existing.length > 5000
      ? existing.substring(existing.length - 5000)
      : existing;

  final existingSet = recentText
      .split(RegExp(r'\n{2,}'))
      .map((p) => p.trim())
      .where((p) => p.isNotEmpty)
      .toSet();

  final seen = <String>{};
  final buffer = <String>[];

  for (final rawParagraph in addition.split(RegExp(r'\n{2,}'))) {
    final paragraph = rawParagraph.trim();
    if (paragraph.isEmpty) continue;
    if (existingSet.contains(paragraph)) continue;
    if (!seen.add(paragraph)) continue;
    buffer.add(paragraph);
  }

  return buffer.join('\n\n');
}

/// üöÄ FUN√á√ÉO TOP-LEVEL para execu√ß√£o em Isolate separado
/// Evita travar UI thread durante verifica√ß√£o de repeti√ß√£o
Map<String, dynamic> _isTooSimilarInIsolate(Map<String, dynamic> params) {
  final String newBlock = params['newBlock'] as String;
  final String previousContent = params['previousContent'] as String;
  final double threshold = params['threshold'] as double;

  if (previousContent.isEmpty) {
    return {'isSimilar': false, 'reason': 'No previous content'};
  }

  // üî• PRIORIDADE 1: Verificar duplica√ß√£o literal de blocos grandes
  final hasLiteral = _hasLiteralDuplicationStatic(newBlock, previousContent);
  if (hasLiteral) {
    return {'isSimilar': true, 'reason': 'Literal duplication detected'};
  }

  // üöÄ OTIMIZA√á√ÉO: Limitar contexto anterior para compara√ß√£o
  final limitedPrevious = previousContent.length > 12000
      ? previousContent.substring(previousContent.length - 12000)
      : previousContent;

  // Dividir conte√∫do anterior em par√°grafos
  final paragraphs = limitedPrevious
      .split('\n\n')
      .where((p) => p.trim().isNotEmpty)
      .toList();

  // üöÄ OTIMIZA√á√ÉO CR√çTICA: Limitar a 10 √∫ltimos par√°grafos
  final recentParagraphs = paragraphs.length > 10
      ? paragraphs.sublist(paragraphs.length - 10)
      : paragraphs;

  // Dividir novo bloco em par√°grafos
  final newParagraphs = newBlock
      .split('\n\n')
      .where((p) => p.trim().isNotEmpty)
      .toList();

  // üéØ AJUSTE FINO: Verificar cada par√°grafo novo contra os RECENTES
  int highSimilarityCount = 0;

  for (final newPara in newParagraphs) {
    // üî• AJUSTE: Detectar par√°grafos de 50+ palavras (era 100)
    final wordCount = newPara.trim().split(RegExp(r'\s+')).length;
    if (wordCount < 50) continue; // Ignorar par√°grafos muito curtos

    if (highSimilarityCount >= 2) break;

    for (final oldPara in recentParagraphs) {
      final oldWordCount = oldPara.trim().split(RegExp(r'\s+')).length;
      if (oldWordCount < 50) continue; // Ignorar par√°grafos muito curtos

      final similarity = _calculateSimilarityStatic(newPara, oldPara);

      // üî• AJUSTE: Threshold reduzido de 85% para 80%
      if (similarity >= threshold) {
        highSimilarityCount++;

        if (highSimilarityCount >= 2) {
          return {
            'isSimilar': true,
            'reason':
                '$highSimilarityCount paragraphs with ${(similarity * 100).toStringAsFixed(1)}% similarity',
          };
        }
        break;
      }
    }
  }

  return {'isSimilar': false, 'reason': 'Content is unique'};
}

/// Vers√£o est√°tica de _hasLiteralDuplication para usar em Isolate
/// üî• FORTALECIDO: Detecta duplica√ß√µes literais com mais agressividade
bool _hasLiteralDuplicationStatic(String newBlock, String previousContent) {
  if (previousContent.length < 500) {
    return false; // üî• REDUZIDO: Era 1000, agora 500
  }

  // üÜï NOVO: Verificar par√°grafos completos duplicados (para transi√ß√µes de se√ß√£o)
  final newParagraphs = newBlock
      .split('\n\n')
      .where(
        (p) =>
            p.trim().isNotEmpty && p.trim().split(RegExp(r'\s+')).length > 30,
      )
      .map((p) => p.trim().toLowerCase())
      .toList();

  final prevParagraphs = previousContent
      .split('\n\n')
      .where(
        (p) =>
            p.trim().isNotEmpty && p.trim().split(RegExp(r'\s+')).length > 30,
      )
      .map((p) => p.trim().toLowerCase())
      .toList();

  // üî• CR√çTICO: Detectar par√°grafos id√™nticos (problema do Quit√©ria)
  for (final newPara in newParagraphs) {
    for (final prevPara in prevParagraphs) {
      // Similaridade exata ou muito pr√≥xima (95%+)
      if (newPara == prevPara) {
        return true; // Par√°grafo duplicado exato
      }

      // üÜï Verificar similaridade estrutural (mesmas primeiras 50 palavras)
      final newWords = newPara.split(RegExp(r'\s+'));
      final prevWords = prevPara.split(RegExp(r'\s+'));

      if (newWords.length > 50 && prevWords.length > 50) {
        final newStart = newWords.take(50).join(' ');
        final prevStart = prevWords.take(50).join(' ');

        if (newStart == prevStart) {
          return true; // In√≠cio id√™ntico em par√°grafo longo
        }
      }
    }
  }

  // üî• Verifica√ß√£o de sequ√™ncias de palavras (original)
  final newWords = newBlock.split(RegExp(r'\s+'));
  if (newWords.length < 150) return false; // üî• REDUZIDO: Era 200, agora 150

  final prevWords = previousContent.split(RegExp(r'\s+'));
  if (prevWords.length < 150) return false; // üî• REDUZIDO: Era 200, agora 150

  // üî• OTIMIZADO: Verificar sequ√™ncias menores (150 palavras em vez de 200)
  for (int i = 0; i <= newWords.length - 150; i++) {
    final newSequence = newWords.sublist(i, i + 150).join(' ').toLowerCase();

    for (int j = 0; j <= prevWords.length - 150; j++) {
      final prevSequence = prevWords
          .sublist(j, j + 150)
          .join(' ')
          .toLowerCase();

      if (newSequence == prevSequence) {
        return true;
      }
    }
  }

  return false;
}

/// Vers√£o est√°tica de _calculateSimilarity para usar em Isolate
double _calculateSimilarityStatic(String text1, String text2) {
  if (text1.isEmpty || text2.isEmpty) return 0.0;

  final normalized1 = text1.toLowerCase().trim().replaceAll(
    RegExp(r'\s+'),
    ' ',
  );
  final normalized2 = text2.toLowerCase().trim().replaceAll(
    RegExp(r'\s+'),
    ' ',
  );

  if (normalized1 == normalized2) return 1.0;

  const nGramSize = 8;
  final words1 = normalized1.split(' ');
  final words2 = normalized2.split(' ');

  if (words1.length < nGramSize || words2.length < nGramSize) {
    final commonWords = words1.toSet().intersection(words2.toSet()).length;
    return commonWords / max(words1.length, words2.length);
  }

  final ngrams1 = <String>{};
  for (int i = 0; i <= words1.length - nGramSize; i++) {
    ngrams1.add(words1.sublist(i, i + nGramSize).join(' '));
  }

  final ngrams2 = <String>{};
  for (int i = 0; i <= words2.length - nGramSize; i++) {
    ngrams2.add(words2.sublist(i, i + nGramSize).join(' '));
  }

  final intersection = ngrams1.intersection(ngrams2).length;
  final union = ngrams1.union(ngrams2).length;

  return union > 0 ? intersection / union : 0.0;
}

/// Implementa√ß√£o consolidada limpa do GeminiService
class GeminiService {
  final Dio _dio;
  final String _instanceId;
  bool _isCancelled = false;

  // Debug Logger
  final _debugLogger = DebugLogManager();

  // üÜï SISTEMA DE RASTREAMENTO DE NOMES - v4 (SOLU√á√ÉO T√âCNICA)
  // Armazena todos os nomes usados na hist√≥ria atual para prevenir duplica√ß√µes
  final Set<String> _namesUsedInCurrentStory = {};

  // Circuit breaker
  bool _isCircuitOpen = false;
  int _failureCount = 0;
  DateTime? _lastFailureTime;
  static const int _maxFailures = 5; // Aumentado de 3 para 5
  static const Duration _circuitResetTime = Duration(
    seconds: 30,
  ); // Reduzido de 2 min para 30s

  // ===== RATE LIMITING GLOBAL OTIMIZADO PARA GEMINI BILLING =====
  // OTIMIZADO: Configura√ß√£o mais agressiva baseada nos limites reais do Gemini
  static int _globalRequestCount = 0;
  static DateTime _globalLastRequestTime = DateTime.now();
  static const Duration _rateLimitWindow = Duration(
    seconds: 60,
  ); // AUMENTADO: Era 10s, agora 60s
  static const int _maxRequestsPerWindow =
      50; // AUMENTADO: Era 8, agora 50 (mais pr√É¬≥ximo dos limites reais)
  static bool _rateLimitBusy = false;

  // Watchdog
  Timer? _watchdogTimer;
  bool _isOperationRunning = false;
  static const Duration _maxOperationTime = Duration(
    minutes: 30,
  ); // Aumentado para 30 min para idiomas complexos (russo, chin√™s)

  GeminiService({String? instanceId})
    : _instanceId = instanceId ?? _genId(),
      _dio = Dio(
        BaseOptions(
          connectTimeout: const Duration(
            seconds: 45,
          ), // AUMENTADO: Era 30s, agora 45s
          receiveTimeout: const Duration(
            minutes: 5,
          ), // AUMENTADO: Era 3min, agora 5min (para contextos grandes)
          sendTimeout: const Duration(
            seconds: 45,
          ), // AUMENTADO: Era 30s, agora 45s
        ),
      ) {
    _dio.interceptors.add(
      InterceptorsWrapper(
        onRequest: (o, h) {
          if (kDebugMode) debugPrint('[$_instanceId] -> ${o.method} ${o.path}');
          h.next(o);
        },
        onResponse: (r, h) {
          if (kDebugMode) debugPrint('[$_instanceId] <- ${r.statusCode}');
          _resetCircuit();
          h.next(r);
        },
        onError: (e, h) {
          if (kDebugMode) debugPrint('[$_instanceId] ERROR: ${e.message}');
          _registerFailure();
          h.next(e);
        },
      ),
    );
  }

  // ===================== API P√É≈°BLICA =====================
  Future<ScriptResult> generateScript(
    ScriptConfig config,
    void Function(GenerationProgress) onProgress,
  ) async {
    // üî• CORRE√á√ÉO CR√çTICA: Resetar vari√°veis globais ANTES de verificar rate limit
    // Isso garante que cada nova gera√ß√£o comece do zero
    _resetGlobalRateLimit();

    // üÜï v4: Resetar rastreador de nomes para nova hist√≥ria
    _resetNameTracker();

    if (!_canMakeRequest()) {
      return ScriptResult.error(
        errorMessage:
            'Servi√É¬ßo temporariamente indispon√É¬≠vel. Tente mais tarde.',
      );
    }

    // CORRE√É‚Ä°√É∆íO: Reset completo do estado para nova gera√É¬ß√É¬£o
    resetState();

    // Tracker global alimentado com os nomes definidos pelo usu√É¬°rio/contexto
    final persistentTracker = _CharacterTracker();
    _bootstrapCharacterTracker(persistentTracker, config);

    _startWatchdog();
    final start = DateTime.now();
    try {
      final totalBlocks = _calculateTotalBlocks(config);
      var acc = '';

      for (var block = 1; block <= totalBlocks && !_isCancelled; block++) {
        // üéØ YIELD CR√çTICO: Liberar UI thread completamente antes de cada bloco
        // Aumentado de 5ms ‚Üí 100ms para garantir anima√ß√µes suaves
        await Future.delayed(const Duration(milliseconds: 100));

        // üêõ DEBUG: Log in√≠cio de bloco
        _debugLogger.block(
          block,
          "Iniciando gera√ß√£o",
          metadata: {
            'totalBlocos': totalBlocks,
            'contextoAtual': acc.length,
            'palavrasGeradas': _countWords(acc),
          },
        );

        final phaseIdx = _getPhaseIndexFromProgress(block / totalBlocks);
        final phase = _phases[phaseIdx];
        final progress = block / totalBlocks;
        final elapsed = DateTime.now().difference(start);
        final estTotal = progress > 0
            ? Duration(
                milliseconds: (elapsed.inMilliseconds / progress).round(),
              )
            : Duration.zero;
        final remaining = estTotal - elapsed;
        final logs = _generateBlockLogs(phase, block, totalBlocks, config);

        // üöÄ OTIMIZA√á√ÉO CR√çTICA: Reduzir frequ√™ncia de onProgress ap√≥s 50%
        // Isso evita sobrecarga da UI quando contexto fica grande
        final shouldUpdateProgress = progress <= 0.5 || block % 2 == 0;

        if (shouldUpdateProgress) {
          onProgress(
            GenerationProgress(
              percentage: progress,
              currentPhase: phase,
              phaseIndex: phaseIdx,
              totalPhases: _phases.length,
              currentBlock: block,
              totalBlocks: totalBlocks,
              estimatedTimeRemaining: remaining,
              logs: logs,
              wordsGenerated: _countWords(acc),
            ),
          );

          // üéØ YIELD MASSIVO: 50ms ‚Üí 150ms para UI respirar completamente
          // Indicador precisa de tempo para animar entre updates
          await Future.delayed(
            Duration(milliseconds: progress > 0.5 ? 200 : 150),
          );
        }

        final targetForBlock = _calculateTargetForBlock(
          block,
          totalBlocks,
          config,
        );
        var added = await _retryOnRateLimit(
          () => _generateBlockContent(
            acc,
            targetForBlock,
            phase,
            config,
            persistentTracker,
            block,
            totalBlocks,
          ),
        );

        // üéØ YIELD P√ìS-API: Dar tempo para UI processar resultado antes de valida√ß√µes
        await Future.delayed(const Duration(milliseconds: 100));

        // üî• RETRY PARA BLOCOS VAZIOS: Se bloco retornou vazio, tentar novamente at√© 3 vezes
        if (added.trim().isEmpty && acc.isNotEmpty) {
          if (kDebugMode) {
            debugPrint(
              '‚ö†Ô∏è BLOCO $block VAZIO! Iniciando tentativas de retry...',
            );
          }

          for (int retry = 1; retry <= 3; retry++) {
            if (kDebugMode) {
              debugPrint('üîÑ Retry $retry/3 para bloco $block...');
            }

            // Aguardar 2 segundos antes de retry
            await Future.delayed(Duration(seconds: 2));

            // üî• AUMENTADO: Contexto de 3000 para 8000 chars para manter nomes em mem√≥ria
            final contextForRetry = retry > 1 && acc.length > 8000
                ? acc.substring(acc.length - 8000)
                : acc;

            added = await _retryOnRateLimit(
              () => _generateBlockContent(
                contextForRetry,
                targetForBlock,
                phase,
                config,
                persistentTracker,
                block,
                totalBlocks,
              ),
            );

            if (added.trim().isNotEmpty) {
              if (kDebugMode) {
                debugPrint('‚úÖ Retry $retry bem-sucedido! Bloco $block gerado.');
              }
              break;
            }
          }

          // üî• CORRE√á√ÉO CR√çTICA: Se ap√≥s 3 tentativas ainda estiver vazio, ABORTAR gera√ß√£o
          if (added.trim().isEmpty) {
            _log(
              '‚ùå ERRO CR√çTICO: Bloco $block permaneceu vazio ap√≥s 3 retries!',
              level: 'critical',
            );
            _log(
              'üî¥ ABORTANDO GERA√á√ÉO: N√£o √© poss√≠vel continuar com blocos vazios.',
              level: 'critical',
            );
            _log(
              'üí° SOLU√á√ÉO: Aguarde alguns minutos e tente novamente. O servidor Gemini pode estar temporariamente indispon√≠vel.',
              level: 'critical',
            );

            // üî• RETORNAR ERRO em vez de continuar
            return ScriptResult.error(
              errorMessage:
                  'üî¥ ERRO: Bloco $block falhou ap√≥s m√∫ltiplas tentativas.\n\n'
                  'O servidor Gemini pode estar temporariamente indispon√≠vel.\n'
                  'Aguarde alguns minutos e tente novamente.\n\n'
                  'Progresso: ${_countWords(acc)} palavras geradas (bloco $block de $totalBlocks).',
            );
          }
        }

        // üéØ YIELD: Liberar UI thread antes de valida√ß√£o pesada
        await Future.delayed(const Duration(milliseconds: 10));

        // ÔøΩ VALIDA√á√ÉO ANTI-REPETI√á√ÉO EM ISOLATE: Verificar sem travar UI
        if (added.trim().isNotEmpty && acc.length > 500) {
          // Executar em isolate separado para n√£o bloquear UI thread
          final result = await compute(_isTooSimilarInIsolate, {
            'newBlock': added,
            'previousContent': acc,
            'threshold':
                0.80, // üî• AJUSTADO: Era 0.85, agora 0.80 para maior sensibilidade
          });

          final isSimilar = result['isSimilar'] as bool;

          if (isSimilar) {
            // üêõ DEBUG: Log repeti√ß√£o detectada
            _debugLogger.warning(
              "Repeti√ß√£o detectada no bloco $block",
              details: result['reason'] as String,
              metadata: {
                'bloco': block,
                'tamanho': _countWords(added),
                'threshold': 0.80,
              },
            );

            if (kDebugMode) {
              debugPrint(
                '‚ùå BLOCO $block REJEITADO: Muito similar ao conte√∫do anterior!',
              );
              debugPrint(
                '   üìä Tamanho do bloco: ${_countWords(added)} palavras',
              );
              debugPrint('   üîç Motivo: ${result['reason']}');
              debugPrint(
                '   üîÑ Regenerando com aviso expl√≠cito contra repeti√ß√£o...',
              );
            }

            // üî• TENTATIVA 1: Regenerar com prompt espec√≠fico contra repeti√ß√£o
            final regenerated = await _retryOnRateLimit(
              () => _generateBlockContent(
                acc,
                targetForBlock,
                phase,
                config,
                persistentTracker,
                block,
                totalBlocks,
                avoidRepetition: true, // Flag especial
              ),
            );

            // Verificar novamente com threshold ainda mais alto (90%)
            final retryResult = await compute(_isTooSimilarInIsolate, {
              'newBlock': regenerated,
              'previousContent': acc,
              'threshold': 0.85, // üî• AJUSTADO: Era 0.90, agora 0.85
            });

            final stillSimilar = retryResult['isSimilar'] as bool;

            if (stillSimilar) {
              if (kDebugMode) {
                debugPrint(
                  '‚ö†Ô∏è TENTATIVA 1 FALHOU: Ainda h√° similaridade alta!',
                );
                debugPrint(
                  '   üîÑ TENTATIVA 2: Regenerando novamente com contexto reduzido...',
                );
              }

              // üî• AUMENTADO: Contexto de 3000 para 8000 chars para manter nomes em mem√≥ria
              final contextoPrevioReduzido = acc.length > 8000
                  ? acc.substring(acc.length - 8000)
                  : acc;

              final regenerated2 = await _retryOnRateLimit(
                () => _generateBlockContent(
                  contextoPrevioReduzido,
                  targetForBlock,
                  phase,
                  config,
                  persistentTracker,
                  block,
                  totalBlocks,
                  avoidRepetition: true,
                ),
              );

              final stillSimilar2 = _isTooSimilar(
                regenerated2,
                acc,
                threshold: 0.90,
              );

              if (stillSimilar2) {
                if (kDebugMode) {
                  debugPrint('‚ö†Ô∏è TENTATIVA 2 FALHOU: Similaridade persiste!');
                  debugPrint(
                    '   ‚ö†Ô∏è DECIS√ÉO: Usando vers√£o menos similar (tentativa 1)',
                  );
                }
                acc +=
                    regenerated; // Usar primeira tentativa (menos similar que original)
              } else {
                if (kDebugMode) {
                  debugPrint('‚úÖ TENTATIVA 2 BEM-SUCEDIDA: Bloco √∫nico gerado!');
                }
                acc += regenerated2;
              }
            } else {
              if (kDebugMode) {
                debugPrint('‚úÖ REGENERA√á√ÉO BEM-SUCEDIDA: Bloco agora √© √∫nico!');
              }
              acc += regenerated;
            }
          } else {
            // ‚úÖ Bloco passou na valida√ß√£o anti-repeti√ß√£o
            acc += added; // Usar vers√£o original
          }
        } else {
          // ‚úÖ Primeiro bloco ou contexto pequeno - adicionar direto
          acc += added;
        }

        if (added.trim().isNotEmpty) {
          // üö® VALIDA√á√ÉO CR√çTICA 1: Verificar se nome da protagonista mudou
          _validateProtagonistName(added, config, block);

          // üö® VALIDA√á√ÉO CR√çTICA 2: Verificar se algum nome foi reutilizado
          _validateNameReuse(added, persistentTracker, block);

          // üÜï v4: EXTRA√á√ÉO E RASTREAMENTO DE NOMES
          final duplicatedNames = _validateNamesInText(
            added,
            _namesUsedInCurrentStory,
          );
          if (duplicatedNames.isNotEmpty) {
            if (kDebugMode) {
              debugPrint(
                'üö® ALERTA: Nomes duplicados detectados no Bloco $block!',
              );
              debugPrint('   Nomes: ${duplicatedNames.join(", ")}');
              debugPrint(
                '   ‚ö†Ô∏è Isso pode indicar personagens com mesmo nome em pap√©is diferentes!',
              );
            }
            _debugLogger.warning(
              "Poss√≠vel duplica√ß√£o de nomes no bloco $block",
              details: "Nomes: ${duplicatedNames.join(", ")}",
              metadata: {'bloco': block, 'nomes': duplicatedNames},
            );
          }
          _addNamesToTracker(added);

          // üÜï VALIDA√á√ÉO CR√çTICA 3: Verificar inconsist√™ncias em rela√ß√µes familiares
          _validateFamilyRelations(added, block);

          // üêõ DEBUG: Log bloco completado com sucesso
          _debugLogger.success(
            "Bloco $block completado",
            details: "Tamanho: ${_countWords(added)} palavras",
            metadata: {
              'bloco': block,
              'palavrasNoBloco': _countWords(added),
              'contextoTotal': acc.length + added.length,
            },
          );

          _updateTrackerFromContextSnippet(persistentTracker, config, added);

          // üîí TRACKING APRIMORADO: Extrair TODOS os nomes ap√≥s cada bloco
          // Isso captura personagens secund√°rios que aparecem em blocos distantes (ex: S√¥nia no bloco 5, depois bloco 15)
          final allNamesInBlock = _extractNamesFromSnippet(added);
          for (final entry in allNamesInBlock.entries) {
            final name = entry.key;
            final count = entry.value;
            // Threshold mais baixo (1+) para personagens secund√°rios
            if (count >= 1) {
              // üî• BLOQUEIO DE REUSO: Se nome j√° existe, n√£o adicionar novamente
              if (persistentTracker.hasName(name)) {
                if (kDebugMode && count >= 2) {
                  debugPrint(
                    '‚úÖ CONFIRMA√á√ÉO: "$name" reapareceu $count vez(es) no bloco $block',
                  );
                }
                continue; // J√° rastreado, pular
              }

              // Verificar se n√£o √© stopword ou localiza√ß√£o
              final normalized = name.toLowerCase();
              if (!_nameStopwords.contains(normalized) &&
                  normalized != config.localizacao.trim().toLowerCase()) {
                // üî• VALIDA√á√ÉO EXTRA: Verificar se nome est√° no banco curado
                if (NameGeneratorService.isValidName(name)) {
                  // üÜï CORRE√á√ÉO BUG ALBERTO: Extrair papel ANTES de adicionar
                  final role = _extractRoleForName(name, added);

                  if (role != null) {
                    // üìö Adicionar com papel identificado
                    persistentTracker.addName(
                      name,
                      role: role,
                      blockNumber: block,
                    );

                    if (kDebugMode) {
                      debugPrint(
                        'üîí TRACKING COM PAPEL (bloco $block): "$name" = "$role" ($count vez(es))',
                      );
                    }
                  } else {
                    // ‚ö†Ô∏è Papel n√£o detectado - marcar como indefinido
                    persistentTracker.addName(
                      name,
                      role: 'indefinido',
                      blockNumber: block,
                    );

                    if (kDebugMode) {
                      debugPrint(
                        'üîí TRACKING SEM PAPEL (bloco $block): "$name" (papel indefinido - $count vez(es))',
                      );
                    }
                  }

                  // üêõ DEBUG: Log personagem detectado
                  _debugLogger.character(
                    name,
                    "Personagem detectado",
                    blockNumber: block,
                    metadata: {
                      'frequencia': count,
                      'primeiraAparicao': block,
                      'papel': role ?? 'indefinido',
                    },
                  );
                } else if (kDebugMode) {
                  debugPrint(
                    '‚ö†Ô∏è NOME IGNORADO (n√£o est√° no banco): "$name" (bloco $block)',
                  );
                }
              }
            }
          }
        }

        // OTIMIZADO: Checkpoint de estabilidade mais r√É¬°pido para Gemini Billing
        await Future.delayed(
          const Duration(milliseconds: 150),
        ); // REDUZIDO: Era 300ms, agora 150ms

        // Verificacao de sanidade do resultado
        if (added.trim().isEmpty) {
          if (kDebugMode) {
            debugPrint(
              '[$_instanceId] AVISO: Bloco $block retornou vazio - tentando RETRY',
            );
          }

          // üî• RETRY AUTOM√ÅTICO: Tentar novamente at√© 3x quando bloco vazio
          // AUMENTADO: Era 2, agora 3 retries para dar mais chance de sucesso
          int retryCount = 0;
          const maxRetries = 3;

          while (retryCount < maxRetries && added.trim().isEmpty) {
            retryCount++;
            if (kDebugMode) {
              debugPrint(
                '[$_instanceId] üîÑ Retry autom√°tico $retryCount/$maxRetries para bloco $block',
              );
            }

            // Aguardar antes de retry (exponential backoff: 4s, 8s, 12s)
            await Future.delayed(Duration(seconds: 4 * retryCount));

            // Tentar gerar novamente
            try {
              added = await _retryOnRateLimit(
                () => _generateBlockContent(
                  acc,
                  targetForBlock,
                  phase,
                  config,
                  persistentTracker,
                  block,
                  totalBlocks,
                ),
              );

              if (added.trim().isNotEmpty) {
                if (kDebugMode) {
                  debugPrint(
                    '[$_instanceId] ‚úÖ Retry autom√°tico bem-sucedido! Bloco $block gerado.',
                  );
                }
                break; // Sucesso, sair do loop de retry
              }
            } catch (e) {
              if (kDebugMode) {
                debugPrint(
                  '[$_instanceId] ‚ùå Retry autom√°tico $retryCount falhou: $e',
                );
              }
            }
          }

          // üî• CORRE√á√ÉO CR√çTICA: Se ainda vazio ap√≥s retries, ABORTAR em vez de continuar
          if (added.trim().isEmpty) {
            if (kDebugMode) {
              debugPrint(
                '[$_instanceId] ‚ùå ERRO CR√çTICO: Bloco $block falhou ap√≥s $maxRetries retries - ABORTANDO',
              );
            }

            return ScriptResult.error(
              errorMessage:
                  'üî¥ ERRO CR√çTICO: Bloco $block permaneceu vazio ap√≥s m√∫ltiplas tentativas.\n\n'
                  'O servidor Gemini pode estar temporariamente indispon√≠vel.\n'
                  'Aguarde alguns minutos e tente novamente.\n\n'
                  'Progresso salvo: ${_countWords(acc)} palavras geradas de ${config.quantity} (bloco $block de $totalBlocks).',
            );
          }
        }

        // Limpeza de mem√É¬≥ria otimizada
        if (kDebugMode) {
          debugPrint(
            '[$_instanceId] Checkpoint bloco $block - Limpeza mem√É¬≥ria',
          );
        }
        await Future.delayed(
          const Duration(milliseconds: 50),
        ); // REDUZIDO: Era 100ms, agora 50ms

        // Delay adicional entre blocos para evitar sobrecarga
        await Future.delayed(
          Duration(milliseconds: _getBlockDelay(block, totalBlocks)),
        );
      }

      // √∞≈∏≈°¬´ EXPANS√É∆íO FOR√É‚Ä°ADA DESATIVADA
      // Sistema de expans√É¬£o removido para evitar m√É¬∫ltiplos finais empilhados.
      // A meta de caracteres deve ser atingida atrav√É¬©s do ajuste dos blocos iniciais,
      // n√É¬£o for√É¬ßando continua√É¬ß√É¬µes ap√É¬≥s a hist√É¬≥ria j√É¬° ter conclu√É¬≠do naturalmente.
      // Isso preserva a qualidade narrativa e evita finais duplicados.

      if (!_isCancelled && !_checkTargetMet(acc, config)) {
        final needed = config.measureType == 'caracteres'
            ? (config.quantity - acc.length)
            : (config.quantity - _countWords(acc));

        if (kDebugMode) {
          debugPrint(
            '[$_instanceId] √¢≈°¬†√Ø¬∏¬è Meta n√É¬£o atingida - Faltam $needed ${config.measureType}',
          );
          debugPrint(
            '[$_instanceId] √Ø¬ø¬Ω DICA: Aumente o tamanho dos blocos iniciais para atingir a meta',
          );
        }
      }

      if (_isCancelled) {
        return ScriptResult.error(errorMessage: 'Gera√ß√£o cancelada');
      }

      _stopWatchdog();

      // üìä LOG FINAL: Resumo de personagens rastreados
      if (kDebugMode && persistentTracker.confirmedNames.isNotEmpty) {
        debugPrint('üìä RESUMO FINAL DE PERSONAGENS:');
        debugPrint(
          '   Total rastreado: ${persistentTracker.confirmedNames.length} personagem(ns)',
        );
        debugPrint('   Nomes: ${persistentTracker.confirmedNames.join(", ")}');
      }

      // üßπ LIMPAR MARCADORES DE DEBUG DO TEXTO FINAL
      final cleanedAcc = acc.replaceAll(
        RegExp(r'PERSONAGEM MENCIONADO:\s*'),
        '',
      );

      // üîç DETEC√á√ÉO FINAL: Verificar se h√° par√°grafos duplicados (apenas LOG, n√£o remove)
      if (kDebugMode) {
        _detectDuplicateParagraphsInFinalScript(cleanedAcc);
      }

      // üêõ DEBUG: Log estat√≠sticas finais
      final stats = _debugLogger.getStatistics();
      _debugLogger.success(
        "Gera√ß√£o completa!",
        details:
            "Roteiro finalizado com sucesso\n"
            "- Palavras: ${_countWords(cleanedAcc)}\n"
            "- Caracteres: ${cleanedAcc.length}\n"
            "- Personagens: ${persistentTracker.confirmedNames.length}\n"
            "- Logs gerados: ${stats['total']}",
        metadata: {
          'palavras': _countWords(cleanedAcc),
          'caracteres': cleanedAcc.length,
          'personagens': persistentTracker.confirmedNames.length,
          'logsTotal': stats['total'],
          'erros': stats['error'],
          'avisos': stats['warning'],
        },
      );

      return ScriptResult(
        scriptText: cleanedAcc,
        wordCount: _countWords(cleanedAcc),
        charCount: cleanedAcc.length,
        paragraphCount: cleanedAcc.split('\n').length,
        readingTime: (_countWords(cleanedAcc) / 150).ceil(),
      );
    } catch (e) {
      _stopWatchdog();
      if (_isCancelled) {
        return ScriptResult.error(errorMessage: 'Gera√ß√£o cancelada');
      }
      return ScriptResult.error(errorMessage: 'Erro: $e');
    }
  }

  void cancelGeneration() {
    if (kDebugMode) debugPrint('[$_instanceId] Cancelando gera√É¬ß√É¬£o...');
    _isCancelled = true;
    _stopWatchdog();

    // CORRE√á√ÉO: N√£o fechar o Dio aqui, pois pode ser reutilizado
    // Apenas marcar como cancelado e limpar estado se necess√°rio
    if (kDebugMode) {
      debugPrint('[$_instanceId] Gera√ß√£o cancelada pelo usu√°rio');
    }
  }

  // M√©todo para limpar recursos quando o service n√£o for mais usado
  void dispose() {
    if (kDebugMode) debugPrint('[$_instanceId] Fazendo dispose do service...');
    _isCancelled = true;
    _stopWatchdog();
    try {
      _dio.close(force: true);
    } catch (e) {
      if (kDebugMode) debugPrint('[$_instanceId] Erro ao fechar Dio: $e');
    }
  }

  // CORRE√É‚Ä°√É∆íO: M√É¬©todo para resetar completamente o estado interno
  void resetState() {
    if (kDebugMode) debugPrint('[$_instanceId] Resetando estado interno...');
    _isCancelled = false;
    _isOperationRunning = false;
    _failureCount = 0;
    _isCircuitOpen = false;
    _lastFailureTime = null;
    _stopWatchdog();

    // üîß NOVO: Resetar vari√°veis static tamb√©m (rate limiting global)
    _resetGlobalRateLimit();

    if (kDebugMode) {
      debugPrint(
        '[$_instanceId] ‚úÖ Estado completamente resetado (incluindo rate limit global)',
      );
    }
  }

  // üîß NOVO: M√©todo para resetar rate limiting global entre gera√ß√µes
  static void _resetGlobalRateLimit() {
    _globalRequestCount = 0;
    _globalLastRequestTime = DateTime.now();
    _rateLimitBusy = false;
  }

  Future<String> generateText(String prompt) async {
    try {
      final response = await _dio.post(
        'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent',
        queryParameters: {'key': 'demo_key'},
        data: {
          'contents': [
            {
              'parts': [
                {'text': prompt},
              ],
            },
          ],
          'generationConfig': {
            'temperature': 0.8,
            'topK': 40,
            'topP': 0.95,
            'maxOutputTokens': 1000,
          },
        },
      );

      return response
              .data['candidates']?[0]?['content']?['parts']?[0]?['text'] ??
          '';
    } catch (e) {
      if (kDebugMode) debugPrint('Erro na gera√É¬ß√É¬£o de texto: $e');
      return '';
    }
  }

  void cancel() {
    cancelGeneration();
  }

  // ===================== Infra =====================
  static String _genId() =>
      'gemini_${DateTime.now().millisecondsSinceEpoch}_${Random().nextInt(999)}';
  void _resetCircuit() {
    _isCircuitOpen = false;
    _failureCount = 0;
    _lastFailureTime = null;
  }

  void _registerFailure() {
    _failureCount++;
    _lastFailureTime = DateTime.now();
    if (_failureCount >= _maxFailures) {
      _isCircuitOpen = true;
      if (kDebugMode) debugPrint('[$_instanceId] Circuit aberto');
    }
  }

  bool _canMakeRequest() {
    if (!_isCircuitOpen) return true;
    if (_lastFailureTime != null &&
        DateTime.now().difference(_lastFailureTime!) > _circuitResetTime) {
      _resetCircuit();
      return true;
    }
    return false;
  }

  void _startWatchdog() {
    _stopWatchdog();
    _isOperationRunning = true;
    if (kDebugMode) {
      debugPrint(
        '[$_instanceId] Iniciando watchdog (${_maxOperationTime.inMinutes} min)',
      );
    }

    _watchdogTimer = Timer(_maxOperationTime, () {
      if (_isOperationRunning && !_isCancelled) {
        if (kDebugMode) {
          debugPrint(
            '[$_instanceId] Watchdog timeout - cancelando opera√É¬ß√É¬£o ap√É¬≥s ${_maxOperationTime.inMinutes} min',
          );
        }
        _isCancelled = true;
      }
    });
  }

  void _stopWatchdog() {
    if (_watchdogTimer != null) {
      _watchdogTimer!.cancel();
      if (kDebugMode && _isOperationRunning) {
        debugPrint('[$_instanceId] Parando watchdog');
      }
    }
    _isOperationRunning = false;
  }

  Future<void> _ensureRateLimit() async {
    // CR√É¬çTICO: Rate limiting global para m√É¬∫ltiplas inst√É¬¢ncias/workspaces
    // Tentativa com timeout para evitar deadlocks
    int attempts = 0;
    const maxAttempts = 100; // 5 segundos m√É¬°ximo de espera

    while (_rateLimitBusy && attempts < maxAttempts) {
      await Future.delayed(const Duration(milliseconds: 50));
      attempts++;
    }

    if (attempts >= maxAttempts) {
      if (kDebugMode) {
        debugPrint('[$_instanceId] Rate limit timeout, proceeding anyway');
      }
      return; // Evita deadlock total
    }

    _rateLimitBusy = true;

    try {
      final now = DateTime.now();
      final diff = now.difference(_globalLastRequestTime);

      if (kDebugMode) {
        debugPrint(
          '[$_instanceId] Rate limit check: $_globalRequestCount/$_maxRequestsPerWindow requests in window',
        );
      }

      // Reset contador se passou da janela de rate limit
      if (diff > _rateLimitWindow) {
        _globalRequestCount = 0;
        if (kDebugMode) debugPrint('[$_instanceId] Rate limit window reset');
      }

      // Se atingiu limite, aguarda at√É¬© o fim da janela
      if (_globalRequestCount >= _maxRequestsPerWindow) {
        final wait = _rateLimitWindow - diff;
        if (wait > Duration.zero && wait < Duration(seconds: 30)) {
          // M√É¬°ximo 30s de espera
          if (kDebugMode) {
            debugPrint(
              '[$_instanceId] Rate limit hit, waiting ${wait.inSeconds}s',
            );
          }
          _rateLimitBusy = false; // Libera antes de aguardar
          await Future.delayed(wait);

          // Tenta reaquirir lock com timeout
          attempts = 0;
          while (_rateLimitBusy && attempts < 20) {
            await Future.delayed(const Duration(milliseconds: 50));
            attempts++;
          }

          if (attempts < 20) {
            _rateLimitBusy = true; // Reaquire lock apenas se conseguiu
            _globalRequestCount = 0;
          } else {
            if (kDebugMode) {
              debugPrint(
                '[$_instanceId] Could not reacquire rate limit lock, proceeding',
              );
            }
            return;
          }
        }
      }

      _globalRequestCount++;
      _globalLastRequestTime = now;

      if (kDebugMode) {
        debugPrint(
          '[$_instanceId] Request $_globalRequestCount/$_maxRequestsPerWindow approved for instance',
        );
      }
    } finally {
      _rateLimitBusy = false;
    }
  }

  Future<T> _retryOnRateLimit<T>(
    Future<T> Function() op, {
    int maxRetries = 6,
  }) async {
    // üî• AUMENTADO: Era 4, agora 6 para erro 503 (servidor indispon√≠vel)
    // RATIONALE: Erro 503 √© transit√≥rio, servidor pode voltar em 30-60s
    for (var attempt = 0; attempt < maxRetries; attempt++) {
      try {
        if (_isCancelled) {
          throw Exception('Opera√É¬ß√É¬£o cancelada');
        }

        await _ensureRateLimit();

        if (_isCancelled) {
          throw Exception('Opera√É¬ß√É¬£o cancelada');
        }

        return await op();
      } catch (e) {
        if (_isCancelled) {
          throw Exception('Opera√É¬ß√É¬£o cancelada');
        }

        final errorStr = e.toString().toLowerCase();

        // üî• CORRE√á√ÉO CR√çTICA: Tratar erro 503 (servidor indispon√≠vel) especificamente
        // Erro 503 = "Service Unavailable" (transit√≥rio, n√£o √© rate limit)
        if (errorStr.contains('503') ||
            errorStr.contains('server error') ||
            errorStr.contains('service unavailable')) {
          if (attempt < maxRetries - 1) {
            // üî• DELAY PROGRESSIVO: 10s, 20s, 30s, 40s, 50s, 60s
            final delay = Duration(seconds: (attempt + 1) * 10);
            if (kDebugMode) {
              debugPrint(
                '[$_instanceId] üî¥ ERRO 503 (Servidor Indispon√≠vel) - Aguardando ${delay.inSeconds}s antes de tentar novamente (tentativa ${attempt + 1}/$maxRetries)',
              );
            }
            await Future.delayed(delay);
            continue;
          } else {
            // üî• AP√ìS 6 TENTATIVAS (total ~210 segundos), desistir
            throw Exception(
              'üî¥ ERRO CR√çTICO: Servidor do Gemini permanece indispon√≠vel ap√≥s ${maxRetries} tentativas (${(maxRetries * (maxRetries + 1) * 5)} segundos). Verifique sua conex√£o e tente novamente em alguns minutos.',
            );
          }
        }

        // CORRE√É‚Ä°√É∆íO: Falha r√É¬°pida para evitar travamentos
        if ((errorStr.contains('429') ||
                errorStr.contains('timeout') ||
                errorStr.contains('connection')) &&
            attempt < maxRetries - 1) {
          final delay = Duration(
            seconds: (attempt + 1) * 2,
          ); // REDUZIDO: Era 3, agora 2 segundos
          if (kDebugMode) {
            debugPrint(
              '[$_instanceId] Retry r√É¬°pido (attempt ${attempt + 1}/$maxRetries): $e',
            );
          }
          await Future.delayed(delay);
          continue;
        }

        if (kDebugMode) {
          debugPrint(
            '[$_instanceId] Erro final ap√É¬≥s $maxRetries tentativas: $e',
          );
        }
        rethrow;
      }
    }
    throw Exception(
      'Limite de tentativas excedido ap√É¬≥s $maxRetries tentativas',
    );
  }

  // ===================== Narrativa =====================
  final List<String> _phases = const [
    'Prepara√ß√£o',
    'Introdu√ß√£o',
    'Desenvolvimento',
    'Cl√≠max',
    'Resolu√ß√£o',
    'Finaliza√ß√£o',
  ];

  int _getPhaseIndexFromProgress(double p) {
    if (p <= 0.15) return 0;
    if (p <= 0.30) return 1;
    if (p <= 0.65) return 2;
    if (p <= 0.80) return 3;
    if (p <= 0.95) return 4;
    return 5;
  }

  List<String> _generateBlockLogs(
    String phase,
    int block,
    int total,
    ScriptConfig c,
  ) {
    return [
      'Fase: $phase',
      'Bloco $block/$total',
      'Meta: ${c.quantity} ${c.measureType}',
    ];
  }

  int _getBlockDelay(int block, int total) {
    final p = block / total;
    // OTIMIZADO: Delays m√≠nimos para maximizar velocidade (sem afetar qualidade)
    if (p <= 0.15) return 50; // Reduzido de 100ms para 50ms
    if (p <= 0.30) return 75; // Reduzido de 150ms para 75ms
    if (p <= 0.65) return 100; // Reduzido de 200ms para 100ms
    if (p <= 0.80) return 125; // Reduzido de 250ms para 125ms
    if (p <= 0.95) return 75; // Reduzido de 150ms para 75ms
    return 50; // Reduzido de 100ms para 50ms
  }

  bool _checkTargetMet(String text, ScriptConfig c) {
    if (c.measureType == 'caracteres') {
      // TOLER√É‚ÄöNCIA ZERO: S√É¬≥ aceita se atingir pelo menos 99.5% da meta
      final tol = max(
        50,
        (c.quantity * 0.005).round(),
      ); // M√É¬°ximo 0.5% ou 50 chars, o que for maior
      return text.length >= (c.quantity - tol);
    }
    final wc = _countWords(text);
    // TOLER√É‚ÄöNCIA ZERO: S√É¬≥ aceita se atingir pelo menos 99% da meta
    final tol = max(
      10,
      (c.quantity * 0.01).round(),
    ); // M√É¬°ximo 1% ou 10 palavras, o que for maior
    return wc >= (c.quantity - tol);
  }

  int _calculateTotalBlocks(ScriptConfig c) {
    // üéØ NORMALIZA√á√ÉO: Converter tudo para palavras equivalentes (5.5 chars = 1 palavra)
    // Isso garante que quantidades equivalentes de conte√∫do recebam blocos similares
    // ‚ö†Ô∏è IMPORTANTE: N√ÉO aplicar multiplicador de idioma aqui!
    //    O multiplicador √© aplicado por bloco, n√£o no total de blocos.
    //    Caso contr√°rio, ingl√™s (1.05x) geraria blocos extras desnecess√°rios.
    int wordsEquivalent = c.measureType == 'caracteres'
        ? (c.quantity / 5.5)
              .round() // Convers√£o: chars ‚Üí palavras
        : c.quantity;

    // üåç AJUSTE AUTOM√ÅTICO PARA IDIOMAS COM ALFABETOS PESADOS
    // IMPORTANTE: Este ajuste s√≥ deve ser aplicado para medida em CARACTERES!
    // Para medida em PALAVRAS, n√£o aplicar redu√ß√£o (o multiplicador 1.20 j√° compensa)
    // Diferentes alfabetos ocupam diferentes quantidades de bytes em UTF-8
    // Ajustamos palavras equivalentes para evitar timeout de contexto em roteiros longos

    // üî¥ N√çVEL 2: Cir√≠lico e Alfabetos Pesados - 2-3 bytes/char ‚Üí Redu√ß√£o de 12%
    final cyrillicLanguages = [
      'Russo', 'B√∫lgaro', 'S√©rvio', // Cir√≠lico
    ];

    // üî¥ N√çVEL 2B: Outros N√£o-Latinos - 2-3 bytes/char ‚Üí Redu√ß√£o de 15%
    final otherNonLatinLanguages = [
      'Hebraico', 'Grego', 'Tailand√™s', // Sem√≠ticos e outros
    ];

    // üü° N√çVEL 1: Latinos com Diacr√≠ticos Pesados - 1.2-1.5 bytes/char ‚Üí Redu√ß√£o de 8%
    final heavyDiacriticLanguages = [
      'Turco',
      'Polon√™s',
      'Tcheco',
      'Vietnamita',
      'H√∫ngaro',
    ];

    // üîß CORRE√á√ÉO: Aplicar ajuste SOMENTE para 'caracteres', nunca para 'palavras'
    // Motivo: O problema de timeout s√≥ ocorre com caracteres (tokens UTF-8)
    // Para palavras, o multiplicador 1.20 j√° √© suficiente para compensar varia√ß√£o
    if (c.measureType == 'caracteres' && wordsEquivalent > 6000) {
      double adjustmentFactor = 1.0;
      String adjustmentLevel = '';

      if (cyrillicLanguages.contains(c.language)) {
        adjustmentFactor = 0.88; // -12% (AJUSTADO: era -20%)
        adjustmentLevel = 'CIR√çLICO';
      } else if (otherNonLatinLanguages.contains(c.language)) {
        adjustmentFactor = 0.85; // -15%
        adjustmentLevel = 'N√ÉO-LATINO';
      } else if (heavyDiacriticLanguages.contains(c.language)) {
        adjustmentFactor = 0.92; // -8% (AJUSTADO: era -10%)
        adjustmentLevel = 'DIACR√çTICOS';
      }

      if (adjustmentFactor < 1.0) {
        final originalWords = wordsEquivalent;
        wordsEquivalent = (wordsEquivalent * adjustmentFactor).round();
        if (kDebugMode) {
          debugPrint('üåç AJUSTE $adjustmentLevel (CARACTERES): ${c.language}');
          debugPrint(
            '   $originalWords ‚Üí $wordsEquivalent palavras equiv. (${(adjustmentFactor * 100).toInt()}%)',
          );
        }
      }
    }

    // üìä C√ÅLCULO OTIMIZADO: Blocos maiores = mais r√°pido, mas deve completar meta
    // Sistema TESTADO e VALIDADO - N√ÉO aumentar blocos sem testes extensivos!
    //
    // üî• v6.1: AJUSTE PARA PORTUGU√äS - Blocos m√©dios para equilibrar 503 vs meta
    // Portugu√™s gera ~30% mais tokens que ingl√™s para mesmo conte√∫do
    // SOLU√á√ÉO: Aumentar QUANTIDADE de blocos moderadamente (compensar redu√ß√£o de TAMANHO)

    final isPortuguese = c.language.toLowerCase().contains('portugu');

    // üáßüá∑ PORTUGU√äS: Mais blocos (tamanho m√©dio) para evitar 503 e atingir meta
    if (isPortuguese) {
      if (wordsEquivalent <= 1000) return 3; // ~333 palavras/bloco
      if (wordsEquivalent <= 3000)
        return 5; // ~600 palavras/bloco (era 4‚Üí6, agora 5)
      if (wordsEquivalent <= 6000)
        return 7; // ~857 palavras/bloco (era 5‚Üí8, agora 7)
      if (wordsEquivalent <= 10000)
        return 14; // ~714 palavras/bloco (v6.5: 12‚Üí14 para evitar 503)
      if (wordsEquivalent <= 15000)
        return 18; // ~833 palavras/bloco (v6.5: 16‚Üí18)
      if (wordsEquivalent <= 20000)
        return 22; // ~909 palavras/bloco (v6.5: 20‚Üí22)
      if (wordsEquivalent <= 25000)
        return 26; // ~961 palavras/bloco (v6.5: 24‚Üí26)
      return 30; // M√°ximo 30 blocos para portugu√™s (v6.5: 28‚Üí30)
    }

    // üåç OUTROS IDIOMAS: Blocos padr√£o (maiores, mais eficientes)
    if (wordsEquivalent <= 1000) return 3; // ~333 palavras/bloco
    if (wordsEquivalent <= 3000) return 4; // ~750 palavras/bloco
    if (wordsEquivalent <= 6000) return 5; // ~1200 palavras/bloco
    if (wordsEquivalent <= 10000) {
      return 10; // ~1000 palavras/bloco (AJUSTADO: era 8, agora 10 para garantir meta)
    }
    if (wordsEquivalent <= 15000) return 12; // ~1250 palavras/bloco
    if (wordsEquivalent <= 20000) return 14; // ~1428 palavras/bloco
    if (wordsEquivalent <= 25000) return 16; // ~1562 palavras/bloco
    return 18; // M√°ximo 18 blocos para textos enormes
  }

  int _calculateTargetForBlock(int current, int total, ScriptConfig c) {
    // üîß CALIBRA√á√ÉO AJUSTADA: Multiplicador reduzido de 1.20 para 0.95 (95%)
    // PROBLEMA DETECTADO: Roteiros saindo 30% maiores (Wanessa +28%, Quit√©ria +30%)
    // AN√ÅLISE: Gemini est√° gerando MAIS do que o pedido, n√£o menos
    // SOLU√á√ÉO: Reduzir multiplicador para evitar sobre-gera√ß√£o
    // Target: Ficar entre -5% e +10% do alvo (¬±10% aceit√°vel)

    // üîß CORRE√á√ÉO: Usar a mesma l√≥gica de normaliza√ß√£o que _calculateTotalBlocks
    int targetQuantity = c.measureType == 'caracteres'
        ? (c.quantity / 5.5)
              .round() // Convers√£o: chars ‚Üí palavras
        : c.quantity;

    // üåç Aplicar os mesmos ajustes de idioma que em _calculateTotalBlocks
    // IMPORTANTE: S√≥ aplicar para 'caracteres', nunca para 'palavras'
    if (c.measureType == 'caracteres' && targetQuantity > 6000) {
      final cyrillicLanguages = ['Russo', 'B√∫lgaro', 'S√©rvio'];
      final otherNonLatinLanguages = ['Hebraico', 'Grego', 'Tailand√™s'];
      final heavyDiacriticLanguages = [
        'Turco',
        'Polon√™s',
        'Tcheco',
        'Vietnamita',
        'H√∫ngaro',
      ];

      if (cyrillicLanguages.contains(c.language)) {
        targetQuantity = (targetQuantity * 0.88).round();
      } else if (otherNonLatinLanguages.contains(c.language)) {
        targetQuantity = (targetQuantity * 0.85).round();
      } else if (heavyDiacriticLanguages.contains(c.language)) {
        targetQuantity = (targetQuantity * 0.92).round();
      }
    }

    // üî• AJUSTE CR√çTICO: Multiplicador calibrado por idioma
    // HIST√ìRICO:
    //   v1: 1.05 ‚Üí Gerou 86.7% (d√©ficit de -13.3%) ‚ùå
    //   v2: 1.15 ‚Üí Gerou 116% (excesso de +16%) ‚ùå
    //   v3: 1.08 ‚Üí Gerou 112% (excesso de +12%) ‚ö†Ô∏è
    //   v4.1: 0.98 ‚Üí Esperado: 98-105% (ideal) ‚úÖ
    //   v5.0: 1.08 ‚Üí Gerava bem (100%+) MAS erro 503 (10 blocos grandes) ‚ùå
    //   v6.0: 0.85 ‚Üí N√£o d√° 503 MAS gera s√≥ 82% (8700/10600) ‚ùå
    //   v6.1: 0.95 ‚Üí Ainda baixo, gera s√≥ 87% (9200/10600) ‚ùå
    //   v6.2: 1.00 ‚Üí Melhorou mas ainda 91% (9600/10600) ‚ùå
    //   v6.3: 1.05 ‚Üí Melhor, mas ainda 100% (10600) ou 77% (8500) vari√°vel ‚ö†Ô∏è
    //   v6.4: 1.08 ‚Üí Volta ao valor do v5.0 MAS ainda d√° 503 com 12 blocos ‚ùå
    //   v6.5: 1.05 ‚Üí Reduz para 1.05 + AUMENTA blocos (12‚Üí14) = blocos 25% menores üéØ
    // SOLU√á√ÉO v6.5: Multiplicador 1.05 + 14 blocos (ao inv√©s de 12)
    // Portugu√™s: 1.05 com 14 blocos = ~760 palavras/bloco (vs 950 do v6.4)
    // Outros idiomas: 1.05 (mant√©m tamanho padr√£o)
    // RATIONALE: v6.4 dava 503 com 12 blocos √ó 1.08 = ~950 palavras/bloco
    //            v6.5 tem 14 blocos √ó 1.05 = ~760 palavras/bloco = 20% MAIS LEVE
    //            + Contexto reduzido (3 vs 4) = 25% menos contexto
    //            = Blocos MUITO mais leves, margem alta contra 503
    final multiplier = c.language.toLowerCase().contains('portugu')
        ? 1.05 // v6.5: Reduz para 1.05 (compensado por +2 blocos = 14 total)
        : 1.05;

    // Calcular target acumulado at√© este bloco (com margem ajustada)
    final cumulativeTarget = (targetQuantity * (current / total) * multiplier)
        .round();

    // Calcular target acumulado do bloco anterior
    final previousCumulativeTarget = current > 1
        ? (targetQuantity * ((current - 1) / total) * multiplier).round()
        : 0;

    // DELTA = palavras necess√°rias NESTE bloco espec√≠fico
    final baseTarget = cumulativeTarget - previousCumulativeTarget;

    // LIMITES por bloco individual (aumentado para evitar cortes)
    final maxBlockSize = c.measureType == 'caracteres' ? 15000 : 5000;

    // Para o √∫ltimo bloco, usar o multiplicador ajustado por idioma
    // Portugu√™s: 1.05 para compensar leve sub-gera√ß√£o (~105% do target)
    // Outros: 0.95 para evitar sobre-gera√ß√£o
    if (current == total) {
      final wordsPerBlock = (targetQuantity / total).ceil();
      return min((wordsPerBlock * multiplier).round(), maxBlockSize);
    }

    return baseTarget > maxBlockSize ? maxBlockSize : baseTarget;
  }

  // ===================== Gera√ß√£o de Blocos =====================

  /// üîÑ WRAPPER: Chama o novo m√≥dulo BaseRules
  String _getLanguageInstruction(String l) {
    return BaseRules.getLanguageInstruction(l);
  }

  /// üîÑ WRAPPER: Chama o novo m√≥dulo BaseRules
  String _getStartInstruction(
    String language, {
    required bool withTitle,
    String? title,
  }) {
    return BaseRules.getStartInstruction(language, withTitle: withTitle, title: title);
  }

  /// üîÑ WRAPPER: Chama o novo m√≥dulo BaseRules
  String _getContinueInstruction(String language) {
    return BaseRules.getContinueInstruction(language);
  }

  /// üåç Traduz labels de metadados (TEMA, SUBTEMA, etc) para o idioma selecionado
  /// üîÑ WRAPPER: Chama o novo m√≥dulo BaseRules
  Map<String, String> _getMetadataLabels(String language) {
    return BaseRules.getMetadataLabels(language);
  }

  /// üîÑ WRAPPER: Chama o novo m√≥dulo BaseRules
  String _buildLocalizationGuidance(ScriptConfig config) {
    return BaseRules.buildLocalizationGuidance(config);
  }

  void _bootstrapCharacterTracker(
    _CharacterTracker tracker,
    ScriptConfig config,
  ) {
    final names = <String>{};
    final fromProtagonist = <String>{};
    final fromSecondary = <String>{};
    final fromContext = <String>{};
    final fromTitle = <String>{};

    if (config.protagonistName.trim().isNotEmpty) {
      final name = config.protagonistName.trim();
      names.add(name);
      fromProtagonist.add(name);
    }
    if (config.secondaryCharacterName.trim().isNotEmpty) {
      final name = config.secondaryCharacterName.trim();
      names.add(name);
      fromSecondary.add(name);
    }

    // Context removido - n√£o h√° mais nomes para extrair do contexto manual

    // üéØ NOVO: Extrair g√™nero e rela√ß√µes de personagens do t√≠tulo
    final titleNames = _extractCharacterHintsFromTitle(config.title, '');
    names.addAll(titleNames);
    fromTitle.addAll(titleNames);

    // üÜï CORRE√á√ÉO BUG ALBERTO: Adicionar nomes COM pap√©is ao tracker
    for (final name in names) {
      // Context removido - papel n√£o pode mais ser extra√≠do do contexto manual

      // Para protagonista e secund√°rio, usar pap√©is expl√≠citos
      if (fromProtagonist.contains(name)) {
        tracker.addName(name, role: 'protagonista');
      } else if (fromSecondary.contains(name)) {
        tracker.addName(name, role: 'secund√°rio');
      } else {
        tracker.addName(name, role: 'indefinido');
      }
    }

    // üìä LOG DETALHADO: Mostrar origem de cada nome carregado
    if (kDebugMode && tracker.confirmedNames.isNotEmpty) {
      debugPrint(
        'üîê TRACKER BOOTSTRAP - ${tracker.confirmedNames.length} nome(s) carregado(s):',
      );
      if (fromProtagonist.isNotEmpty) {
        debugPrint('   üìå Protagonista: ${fromProtagonist.join(", ")}');
      }
      if (fromSecondary.isNotEmpty) {
        debugPrint('   üìå Secund√°rio: ${fromSecondary.join(", ")}');
      }
      if (fromContext.isNotEmpty) {
        debugPrint('   üìå Do contexto: ${fromContext.join(", ")}');
      }
      if (fromTitle.isNotEmpty) {
        debugPrint('   üìå Do t√≠tulo: ${fromTitle.join(", ")}');
      }
      debugPrint('   ‚úÖ Total: ${tracker.confirmedNames.join(", ")}');
    } else if (kDebugMode) {
      debugPrint(
        '‚ö†Ô∏è TRACKER BOOTSTRAP: Nenhum nome inicial fornecido (ser√° detectado no bloco 1)',
      );
    }
  }

  void _updateTrackerFromContextSnippet(
    _CharacterTracker tracker,
    ScriptConfig config,
    String snippet,
  ) {
    if (snippet.trim().isEmpty) return;

    final existingLower = tracker.confirmedNames
        .map((n) => n.toLowerCase())
        .toSet();
    final locationLower = config.localizacao.trim().toLowerCase();
    final candidateCounts = _extractNamesFromSnippet(snippet);

    candidateCounts.forEach((name, count) {
      final normalized = name.toLowerCase();
      if (existingLower.contains(normalized)) return;
      if (count < 2) return; // exige recorr√™ncia para evitar falsos positivos
      if (locationLower.isNotEmpty && normalized == locationLower) return;
      if (_nameStopwords.contains(normalized)) return;

      // üî• VALIDA√á√ÉO RIGOROSA: S√≥ adicionar se estiver no banco curado
      if (!NameGeneratorService.isValidName(name)) {
        if (kDebugMode) {
          debugPrint(
            '‚ö†Ô∏è Tracker REJEITOU nome n√£o validado: "$name" (n√£o est√° no banco curado)',
          );
        }
        return;
      }

      // üÜï CORRE√á√ÉO BUG ALBERTO: Extrair papel antes de adicionar
      final role = _extractRoleForName(name, snippet);

      if (role != null) {
        tracker.addName(name, role: role);
        if (kDebugMode) {
          debugPrint(
            'üîç Tracker adicionou personagem COM PAPEL: "$name" = "$role" (ocorr√™ncias: $count)',
          );
        }
      } else {
        tracker.addName(name, role: 'indefinido');
        if (kDebugMode) {
          debugPrint(
            'üîç Tracker adicionou personagem SEM PAPEL: "$name" (indefinido - ocorr√™ncias: $count)',
          );
        }
      }
      if (kDebugMode) {
        debugPrint(
          'üîç Tracker adicionou personagem detectado: $name (ocorr√™ncias: $count)',
        );
      }
    });
  }

  /// üåç Traduz termos de parentesco do portugu√™s para o idioma do roteiro
  /// üîÑ WRAPPER: Chama o novo m√≥dulo BaseRules
  String _translateFamilyTerms(String text, String language) {
    return BaseRules.translateFamilyTerms(language, text);
  }

  String _buildCharacterGuidance(
    ScriptConfig config,
    _CharacterTracker tracker,
  ) {
    final lines = <String>[];
    final baseNames = <String>{};

    final protagonist = config.protagonistName.trim();
    if (protagonist.isNotEmpty) {
      final translatedProtagonist = _translateFamilyTerms(
        protagonist,
        config.language,
      );
      lines.add(
        '- Protagonista: "$translatedProtagonist" ‚Äî mantenha exatamente este nome e sua fun√ß√£o.',
      );
      baseNames.add(protagonist.toLowerCase());
    }

    final secondary = config.secondaryCharacterName.trim();
    if (secondary.isNotEmpty) {
      final translatedSecondary = _translateFamilyTerms(
        secondary,
        config.language,
      );
      lines.add(
        '- Personagem secund√°rio: "$translatedSecondary" ‚Äî preserve o mesmo nome em todos os blocos.',
      );
      baseNames.add(secondary.toLowerCase());
    }

    final additional =
        tracker.confirmedNames
            .where((n) => !baseNames.contains(n.toLowerCase()))
            .toList()
          ..sort((a, b) => a.compareTo(b));

    for (final name in additional) {
      // üéØ CORRIGIDO: Adicionar personagens mencionados (n√£o s√£o hints de narrador)
      if (name.startsWith('PERSONAGEM MENCIONADO')) {
        // Remover marcador e traduzir termo familiar antes de adicionar ao prompt
        final cleanName = name.replaceFirst('PERSONAGEM MENCIONADO: ', '');
        final translatedName = _translateFamilyTerms(
          cleanName,
          config.language,
        );
        lines.add(
          '- Personagem mencionado: $translatedName (manter como refer√™ncia familiar)',
        );
      } else {
        final translatedName = _translateFamilyTerms(name, config.language);
        lines.add(
          '- Personagem estabelecido: "$translatedName" ‚Äî n√£o altere este nome nem invente apelidos.',
        );
      }
    }

    if (lines.isEmpty) return '';

    return 'PERSONAGENS ESTABELECIDOS:\n${lines.join('\n')}\nNunca substitua esses nomes por varia√ß√µes ou apelidos.\n';
  }

  // üéØ CORRIGIDO: Extrair hints de g√™nero/rela√ß√µes APENAS como contexto, N√ÉO como narrador
  // O t√≠tulo √© apenas o GANCHO da hist√≥ria, n√£o define quem narra!
  // Quem narra √© definido por: Perspectiva + Campo Protagonista + Contexto do usu√°rio
  Set<String> _extractCharacterHintsFromTitle(String title, String context) {
    final hints = <String>{};
    if (title.trim().isEmpty) return hints;

    final titleLower = title.toLowerCase();
    final contextLower = context.toLowerCase();

    // üéØ DETECTAR: 1) Rela√ß√µes familiares e 2) Nomes pr√≥prios mencionados no t√≠tulo

    // 1Ô∏è‚É£ RELA√á√ïES FAMILIARES
    final charactersInTitle = {
      'm√£e': 'PERSONAGEM MENCIONADO: M√£e',
      'pai': 'PERSONAGEM MENCIONADO: Pai',
      'filho': 'PERSONAGEM MENCIONADO: Filho',
      'filha': 'PERSONAGEM MENCIONADO: Filha',
      'esposa': 'PERSONAGEM MENCIONADO: Esposa',
      'marido': 'PERSONAGEM MENCIONADO: Marido',
      'irm√£': 'PERSONAGEM MENCIONADO: Irm√£',
      'irm√£o': 'PERSONAGEM MENCIONADO: Irm√£o',
      'av√≥': 'PERSONAGEM MENCIONADO: Av√≥',
      'av√¥': 'PERSONAGEM MENCIONADO: Av√¥',
      'tia': 'PERSONAGEM MENCIONADO: Tia',
      'tio': 'PERSONAGEM MENCIONADO: Tio',
    };

    for (final entry in charactersInTitle.entries) {
      if (titleLower.contains(entry.key) || contextLower.contains(entry.key)) {
        hints.add(entry.value);
        if (kDebugMode) {
          debugPrint(
            'üéØ Personagem detectado no t√≠tulo: ${entry.key} ‚Üí ${entry.value}',
          );
        }
      }
    }

    // 2Ô∏è‚É£ NOMES PR√ìPRIOS MENCIONADOS NO T√çTULO
    // Detectar padr√µes como: "Voc√™ √© Michael?" ou "chamado Jo√£o" ou "nome: Maria"
    final namePatterns = [
      RegExp(
        r'(?:√©|chamad[oa]|nome:|sou)\s+([A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]+(?:\s+[A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]+)?)',
        caseSensitive: false,
      ),
      RegExp(r'"([A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]+)"'), // Nomes entre aspas
      RegExp(
        r'protagonista\s+([A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]+)',
        caseSensitive: false,
      ),
    ];

    for (final pattern in namePatterns) {
      for (final match in pattern.allMatches(title)) {
        final name = match.group(1)?.trim() ?? '';
        if (_looksLikePersonName(name) && name.length >= 3) {
          hints.add('NOME MENCIONADO NO T√çTULO: $name');
          if (kDebugMode) {
            debugPrint('üéØ Nome pr√≥prio detectado no t√≠tulo: $name');
          }
        }
      }
    }

    return hints;
  }

  // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  // üé≠ SISTEMA DE ESTILOS NARRATIVOS
  // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

  /// Extrai ano de strings como "Ano 1890, Velho Oeste" ou "1920, Nova York"
  String _extractYear(String localizacao) {
    if (localizacao.trim().isEmpty) return '';

    // Padr√µes: "Ano 1890", "ano 1920", "Year 1850", "1776"
    final yearRegex = RegExp(r'(?:Ano|ano|Year|year)?\s*(\d{4})');
    final match = yearRegex.firstMatch(localizacao);

    if (match != null) {
      final year = match.group(1)!;
      final yearInt = int.tryParse(year);

      // Validar se √© um ano razo√°vel (1000-2100)
      if (yearInt != null && yearInt >= 1000 && yearInt <= 2100) {
        return year;
      }
    }

    return '';
  }

  /// Retorna lista de anacronismos a evitar baseado no ano
  List<String> _getAnachronismList(String year) {
    if (year.isEmpty) return [];

    final yearInt = int.tryParse(year);
    if (yearInt == null) return [];

    final anachronisms = <String>[];

    // Tecnologias por per√≠odo (data da inven√ß√£o/populariza√ß√£o)
    if (yearInt < 1876) anachronisms.add('Telefone (inventado em 1876)');
    if (yearInt < 1879) {
      anachronisms.add('L√¢mpada el√©trica (inventada em 1879)');
    }
    if (yearInt < 1886) {
      anachronisms.add('Autom√≥vel a gasolina (inventado em 1886)');
    }
    if (yearInt < 1895) anachronisms.add('Cinema (inventado em 1895)');
    if (yearInt < 1903) anachronisms.add('Avi√£o (inventado em 1903)');
    if (yearInt < 1920) {
      anachronisms.add('R√°dio comercial (popularizado em 1920)');
    }
    if (yearInt < 1927) anachronisms.add('Cinema sonoro (1927)');
    if (yearInt < 1936) anachronisms.add('Televis√£o comercial (1936)');
    if (yearInt < 1946) anachronisms.add('Computador eletr√¥nico (ENIAC 1946)');
    if (yearInt < 1950) anachronisms.add('Cart√£o de cr√©dito (1950)');
    if (yearInt < 1969) anachronisms.add('Internet/ARPANET (1969)');
    if (yearInt < 1973) anachronisms.add('Telefone celular (1973)');
    if (yearInt < 1981) anachronisms.add('Computador pessoal (IBM PC 1981)');
    if (yearInt < 1983) anachronisms.add('Internet comercial (1983)');
    if (yearInt < 1991) anachronisms.add('World Wide Web (1991)');
    if (yearInt < 2001) anachronisms.add('Wikipedia (2001)');
    if (yearInt < 2004) anachronisms.add('Facebook (2004)');
    if (yearInt < 2006) anachronisms.add('Twitter (2006)');
    if (yearInt < 2007) anachronisms.add('iPhone/Smartphone moderno (2007)');

    return anachronisms;
  }

  /// Retorna elementos de √©poca que DEVEM ser inclu√≠dos
  List<String> _getPeriodElements(String year, String? genre) {
    if (year.isEmpty) return [];

    final yearInt = int.tryParse(year);
    if (yearInt == null) return [];

    final elements = <String>[];

    // ‚öîÔ∏è WESTERN (1850-1900)
    if (genre == 'western' && yearInt >= 1850 && yearInt <= 1900) {
      elements.addAll([
        'Rev√≥lver (Colt Peacemaker comum ap√≥s 1873)',
        'Saloon com portas batentes',
        'Cavalo como transporte principal',
        'Dilig√™ncia (stagecoach)',
        'Xerife e delegados',
        'Lei do mais r√°pido',
      ]);

      if (yearInt >= 1869) {
        elements.add('Ferrovia transcontinental (completada em 1869)');
      }
      if (yearInt >= 1844) {
        elements.add('Tel√©grafo para comunica√ß√£o √† dist√¢ncia');
      }
    }

    // üìú ELEMENTOS GERAIS POR PER√çODO
    if (yearInt < 1850) {
      // Era pr√©-industrial
      elements.addAll([
        'Ilumina√ß√£o a vela ou lampi√£o a √≥leo',
        'Transporte por carro√ßa ou cavalo',
        'Cartas entregues por mensageiro',
        'Vestimentas formais e conservadoras',
        'Sociedade rigidamente hier√°rquica',
      ]);
    } else if (yearInt >= 1850 && yearInt < 1900) {
      // Era vitoriana/industrial
      elements.addAll([
        'Ilumina√ß√£o a g√°s nas cidades',
        'Trem a vapor (ferrovias em expans√£o)',
        'Tel√©grafo para comunica√ß√£o',
        'Fotografia (daguerre√≥tipo)',
        'Jornais impressos',
      ]);
    } else if (yearInt >= 1900 && yearInt < 1920) {
      // Belle √âpoque / Era Eduardiana
      elements.addAll([
        'Primeiros autom√≥veis (ainda raros)',
        'Telefone fixo (casas ricas)',
        'Cinema mudo',
        'Ilumina√ß√£o el√©trica nas cidades',
        'Fon√≥grafo (m√∫sica gravada)',
      ]);
    } else if (yearInt >= 1920 && yearInt < 1945) {
      // Entre-guerras
      elements.addAll([
        'R√°dio como principal entretenimento',
        'Cinema sonoro (ap√≥s 1927)',
        'Autom√≥veis mais comuns',
        'Telefone residencial',
        'Avi√µes comerciais (raros)',
      ]);
    } else if (yearInt >= 1945 && yearInt < 1970) {
      // P√≥s-guerra / Era de ouro
      elements.addAll([
        'Televis√£o em preto e branco',
        'Autom√≥vel como padr√£o',
        'Eletrodom√©sticos modernos',
        'Cinema em cores',
        'Discos de vinil',
      ]);
    } else if (yearInt >= 1970 && yearInt < 1990) {
      // Era moderna
      elements.addAll([
        'Televis√£o em cores',
        'Telefone residencial fixo',
        'Fitas cassete e VHS',
        'Primeiros computadores pessoais (ap√≥s 1981)',
        'Walkman (m√∫sica port√°til)',
      ]);
    } else if (yearInt >= 1990 && yearInt < 2007) {
      // Era digital inicial
      elements.addAll([
        'Internet discada/banda larga',
        'Celular b√°sico (sem smartphone)',
        'E-mail',
        'CDs e DVDs',
        'Computadores pessoais comuns',
      ]);
    } else if (yearInt >= 2007 && yearInt <= 2025) {
      // Era dos smartphones
      elements.addAll([
        'Smartphone touchscreen',
        'Redes sociais (Facebook, Twitter, Instagram)',
        'Wi-Fi ub√≠quo',
        'Streaming de v√≠deo/m√∫sica',
        'Apps para tudo',
      ]);
    }

    return elements;
  }

  /// Gera orienta√ß√£o de estilo narrativo baseado na configura√ß√£o
  String _getNarrativeStyleGuidance(ScriptConfig config) {
    final style = config.narrativeStyle;

    switch (style) {
      case 'reflexivo_memorias':
        return '''
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üé≠ ESTILO NARRATIVO: REFLEXIVO (MEM√ìRIAS)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**Tom:** Nost√°lgico, pausado, introspectivo, suave
**Ritmo:** Lento e contemplativo, com pausas naturais
**Perspectiva emocional:** Olhar do presente para o passado com sabedoria

**ESTRUTURA NARRATIVA:**
1. Come√ßar com gatilhos de mem√≥ria: "Eu me lembro...", "Naquele tempo...", "Era uma √©poca em que..."
2. Intercalar presente e passado sutilmente
3. Usar pausas reflexivas (retic√™ncias, sil√™ncios)
4. Incluir detalhes sensoriais: cheiro, textura, luz, sons
5. Mencionar pequenas coisas que marcam √©poca (objetos, costumes)

**VOCABUL√ÅRIO:**
- Palavras suaves: "gentil", "singelo", "sutil", "delicado"
- Express√µes temporais: "naqueles dias", "antigamente", "costumava"
- Verbos no imperfeito: "era", "tinha", "fazia", "lembrava"

**T√âCNICAS:**
- Digress√µes naturais (como algu√©m contando hist√≥ria oral)
- Compara√ß√µes passado √ó presente
- Admitir falhas de mem√≥ria: "Se n√£o me engano...", "Creio que..."
- Tom de sabedoria adquirida com o tempo

**EXEMPLO DE NARRA√á√ÉO:**
"Eu me lembro... O cheiro do caf√© coado na manh√£, ainda quente na caneca de porcelana.
As m√£os da minha av√≥, calejadas mas gentis, preparando o p√£o caseiro.
Naquela √©poca, as coisas eram mais simples. N√£o t√≠nhamos pressa.
O tempo... ah, o tempo parecia se mover de outra forma.
Hoje, quando sinto o aroma de caf√©, sou transportada de volta √†queles dias..."

**EVITE:**
‚ùå A√ß√£o fren√©tica ou tens√£o extrema
‚ùå Vocabul√°rio t√©cnico ou moderno demais
‚ùå Narrativa onisciente (manter ponto de vista pessoal)
‚ùå Tom jovial ou energia excessiva
‚ùå Certezas absolutas (mem√≥rias s√£o fluidas)
''';

      case 'epico_periodo':
        final year = _extractYear(config.localizacao);
        final anachronisms = _getAnachronismList(year);
        final periodElements = _getPeriodElements(year, config.genre);

        String anachronismSection = '';
        if (anachronisms.isNotEmpty) {
          anachronismSection =
              '''

**üö® ANACRONISMOS A EVITAR (N√£o existiam em $year):**
${anachronisms.map((a) => '  ‚ùå $a').join('\n')}
''';
        }

        String periodSection = '';
        if (periodElements.isNotEmpty) {
          periodSection =
              '''

**‚úÖ ELEMENTOS DO PER√çODO A INCLUIR (Existiam em $year):**
${periodElements.map((e) => '  ‚úì $e').join('\n')}
''';
        }

        return '''
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚öîÔ∏è ESTILO NARRATIVO: √âPICO DE PER√çODO${year.isNotEmpty ? ' (Ano: $year)' : ''}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**Tom:** Grandioso, formal, heroico, majestoso
**Ritmo:** Cadenciado e majestoso, com constru√ß√£o dram√°tica
**Perspectiva:** Narrador que conhece a import√¢ncia hist√≥rica dos eventos

**ESTRUTURA NARRATIVA:**
1. Descri√ß√µes detalhadas e v√≠vidas do per√≠odo hist√≥rico
2. Di√°logos formais e apropriados √† √©poca (sem g√≠rias modernas)
3. Enfatizar valores, honra e c√≥digos morais da √©poca
4. Usar linguagem elevada mas compreens√≠vel
5. Construir tens√£o com descri√ß√µes atmosf√©ricas

**VOCABUL√ÅRIO:**
- Palavras de peso: "honra", "destino", "coragem", "sacrif√≠cio"
- Descri√ß√µes grandiosas: "sob o sol escaldante", "nas sombras da hist√≥ria"
- Evitar contra√ß√µes: "n√£o havia" em vez de "n√£o tinha"

**T√âCNICAS:**
- Come√ßar com estabelecimento de √©poca e lugar
- Usar marcos hist√≥ricos reais quando poss√≠vel
- Descrever vestimentas, armas, tecnologia da √©poca
- Criar senso de inevitabilidade hist√≥rica
- Pausas dram√°ticas antes de momentos cruciais$anachronismSection$periodSection

**EXEMPLO DE NARRA√á√ÉO:**
"${year.isNotEmpty ? 'No ano de $year' : 'Naquele tempo'}, sob o sol escaldante do Velho Oeste,
Jake ajustou o rev√≥lver no coldre de couro gasto. O duelo seria ao meio-dia.
A cidade inteira observava em sil√™ncio das janelas empoeiradas,
sabendo que a justi√ßa seria feita pela lei do mais r√°pido.
O vento quente soprava pela rua deserta, levantando nuvens de poeira vermelha.
Dois homens. Um c√≥digo. Um destino."

**EVITE:**
‚ùå Anacronismos (tecnologias que n√£o existiam na √©poca)
‚ùå G√≠rias modernas ou linguagem informal
‚ùå Refer√™ncias contempor√¢neas
‚ùå Tom humor√≠stico ou irreverente
‚ùå Ritmo apressado (√©pico requer peso)
''';

      case 'educativo_curioso':
        return '''
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîç ESTILO NARRATIVO: EDUCATIVO (CURIOSIDADES)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**Tom:** Entusiasta, acess√≠vel, did√°tico, fascinante
**Ritmo:** Moderado, com pausas para absor√ß√£o de conceitos
**Perspectiva:** Guia amig√°vel que revela conhecimento surpreendente

**ESTRUTURA NARRATIVA (Framework de 4 Passos):**
1. **PERGUNTA INTRIGANTE:** Despertar curiosidade
2. **FATO SURPREENDENTE:** Resposta que causa "Uau!"
3. **EXPLICA√á√ÉO COM CONTEXTO:** Como/Por que funciona
4. **IMPACTO/APLICA√á√ÉO:** Por que isso importa

**FRASES-GATILHO (Use frequentemente):**
- "Voc√™ sabia que...?"
- "Mas aqui est√° o fascinante..."
- "E √© por isso que..."
- "Isso explica por que..."
- "Surpreendentemente..."
- "O interessante √© que..."
- "Aqui est√° a parte incr√≠vel..."

**T√âCNICAS DE ENGAJAMENTO:**
- Fazer perguntas ret√≥ricas para o espectador
- Usar analogias com coisas do cotidiano
- Compara√ß√µes de escala (tamanho, tempo, dist√¢ncia)
- Fatos num√©ricos impressionantes
- Conex√µes inesperadas entre conceitos

**VOCABUL√ÅRIO:**
- Palavras de descoberta: "revelador", "surpreendente", "fascinante"
- Verbos ativos: "descobrir", "revelar", "transformar", "conectar"
- Evitar jarg√£o t√©cnico SEM explica√ß√£o simples

**EXEMPLO DE NARRA√á√ÉO:**
"Voc√™ sabia que o c√©u √© azul por causa de um fen√¥meno chamado espalhamento de Rayleigh?

Mas aqui est√° o fascinante: quando a luz solar entra na atmosfera,
ela colide com mol√©culas min√∫sculas de ar. A luz √© composta de diferentes cores,
cada uma com seu pr√≥prio comprimento de onda.

A luz azul tem ondas menores e mais curtas, ent√£o ela se espalha mais facilmente
ao colidir com as mol√©culas. √â como jogar bolinhas de diferentes tamanhos
atrav√©s de uma peneira - as menores ricocheteiam mais!

E √© por isso que vemos azul durante o dia, mas laranja e vermelho no p√¥r do sol.
No final do dia, a luz precisa atravessar MUITO mais atmosfera,
ent√£o at√© as ondas maiores (vermelhas e laranjas) come√ßam a se espalhar."

**EVITE:**
‚ùå Jarg√£o t√©cnico sem explica√ß√£o
‚ùå Tom professoral ou autorit√°rio ("voc√™s DEVEM saber...")
‚ùå Exemplos muito abstratos ou acad√™micos
‚ùå Informa√ß√£o sem contexto pr√°tico
‚ùå Monotonia (variar ritmo e entusiasmo)
''';

      case 'acao_rapida':
        return '''
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö° ESTILO NARRATIVO: A√á√ÉO R√ÅPIDA
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**Tom:** Urgente, intenso, visceral, adrenalina pura
**Ritmo:** FREN√âTICO - frases curtas e impactantes
**Perspectiva:** Imers√£o total no momento presente

**ESTRUTURA NARRATIVA:**
1. Frases CURTAS (5-10 palavras m√°ximo)
2. Verbos de a√ß√£o fortes e diretos
3. Tempo presente para imediatismo
4. Elimina√ß√£o de adjetivos desnecess√°rios
5. Foco em MOVIMENTO e IMPACTO

**T√âCNICA DE ESCRITA:**
- Cortar conjun√ß√µes: "Jake corre. Pula. Rola." (n√£o "Jake corre, pula e rola")
- Um verbo forte por frase
- Frases fragmentadas para urg√™ncia
- Pontua√ß√£o agressiva: ponto final, n√£o v√≠rgula
- Onomatopeias quando apropriado: BAM! CRASH! BANG!

**VERBOS PREFERIDOS:**
- Movimento: corre, salta, mergulha, voa, derrapa
- Impacto: explode, estilha√ßa, rompe, perfura, esmaga
- Combate: ataca, esquiva, bloqueia, contra-ataca, elimina

**EXEMPLO DE NARRA√á√ÉO:**
"O tiro ecoa. Jake rola. Esquiva.
Vidro explode atr√°s dele. CRASH!
Levanta. Corre. Tr√™s passos.
Mira. Dispara. BAM!
O oponente cambaleia. Cai.
Sil√™ncio.
Vit√≥ria."

**T√âCNICAS AVAN√áADAS:**
- Frases de uma palavra para picos: "Agora." "Fogo!" "Corre!"
- Eliminar artigos: "Bala rasga ar" (n√£o "A bala rasga o ar")
- Usar presente simples: "Ele ataca" (n√£o "Ele est√° atacando")
- Staccato verbal: ritmo de metralhadora

**ESTRUTURA DE CENA DE A√á√ÉO:**
1. Estabelecer perigo (2 frases)
2. Rea√ß√£o instintiva (3-4 frases ultra-curtas)
3. Escalada (mais movimento, mais perigo)
4. Cl√≠max (1-2 frases de impacto)
5. Resolu√ß√£o (1 frase de al√≠vio)

**EVITE:**
‚ùå Descri√ß√µes longas de cen√°rio
‚ùå Reflex√µes filos√≥ficas ou emocionais
‚ùå Di√°logos extensos (m√°ximo 3-4 palavras)
‚ùå Adjetivos m√∫ltiplos ("a bela e majestosa espada" ‚Üí "a espada")
‚ùå Subordinadas complexas
‚ùå Explica√ß√µes de motiva√ß√£o (a√ß√£o pura)
''';

      case 'lirico_poetico':
        return '''
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üå∏ ESTILO NARRATIVO: L√çRICO PO√âTICO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**Tom:** Melanc√≥lico, suave, contemplativo, et√©reo
**Ritmo:** Cadenciado e musical, quase como versos livres
**Perspectiva:** Olhar art√≠stico que transforma realidade em poesia

**ESTRUTURA NARRATIVA:**
1. Imagens sensoriais ricas e sinest√©sicas
2. Met√°foras da natureza e elementos
3. Ritmo quase musical (aten√ß√£o √† sonoridade)
4. Simbolismo em vez de descri√ß√£o direta
5. Repeti√ß√µes para √™nfase emocional

**RECURSOS PO√âTICOS:**

**Met√°foras:**
- Comparar emo√ß√µes com natureza: "dor como tempestade", "alegria como aurora"
- Personificar elementos: "o vento sussurra", "a noite abra√ßa"
- Transformar concreto em abstrato: "olhos eram janelas de alma"

**Sinestesia (Misturar Sentidos):**
- "Som aveludado da voz"
- "Sil√™ncio pesado"
- "Luz quente das palavras"
- "Sabor amargo da saudade"

**Alitera√ß√£o e Asson√¢ncia:**
- "Suave som do sil√™ncio sussurra"
- "Lua l√¢nguida lamenta"
- Aten√ß√£o ao ritmo das palavras

**VOCABUL√ÅRIO:**
- Palavras suaves: "et√©reo", "ef√™mero", "sublime", "t√™nue"
- Natureza: "aurora", "crep√∫sculo", "orvalho", "brisa"
- Emo√ß√£o profunda: "melancolia", "nostalgia", "anseio", "enlevo"

**EXEMPLO DE NARRA√á√ÉO:**
"A lua, p√°lida testemunha da noite eterna,
derramava sua luz prateada sobre os campos adormecidos.
O vento, esse mensageiro de segredos antigos,
sussurrava entre as folhas trementes das √°rvores.

E o tempo, esse eterno viajante sem repouso,
seguia seu curso inexor√°vel,
levando consigo os momentos como p√©talas ao vento,
enquanto as estrelas bordavam seus poemas silenciosos
no vasto manto azul do infinito."

**T√âCNICAS AVAN√áADAS:**
- Repeti√ß√£o para √™nfase: "Esperava. Sempre esperava. Como se esperar fosse seu destino."
- Frases longas e fluidas (contr√°rio da a√ß√£o r√°pida)
- Usar v√≠rgulas para criar ritmo de respira√ß√£o
- Imagens visuais como pinturas
- Deixar espa√ßo para interpreta√ß√£o (n√£o explicar tudo)

**ESTRUTURA EMOCIONAL:**
- Come√ßar com imagem sensorial
- Construir camadas de significado
- Cl√≠max emocional (n√£o de a√ß√£o)
- Resolu√ß√£o contemplativa ou em aberto

**EVITE:**
‚ùå Linguagem t√©cnica ou prosaica
‚ùå A√ß√£o fren√©tica ou viol√™ncia expl√≠cita
‚ùå Di√°logos diretos e funcionais
‚ùå Explica√ß√µes literais
‚ùå Ritmo apressado ou urgente
‚ùå Jarg√£o ou coloquialismo
''';

      default: // ficcional_livre
        return '''
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìñ ESTILO NARRATIVO: FIC√á√ÉO LIVRE (SEM RESTRI√á√ïES)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**Tom:** Flex√≠vel - adapta-se ao tema e g√™nero
**Ritmo:** Balanceado - varia conforme necessidade
**Perspectiva:** Liberdade criativa total

**ORIENTA√á√ïES GERAIS:**
‚úì Misturar estilos conforme necess√°rio (a√ß√£o + reflex√£o + descri√ß√£o)
‚úì Adaptar tom ao tema escolhido (drama, com√©dia, suspense, etc.)
‚úì Usar t√©cnicas narrativas variadas
‚úì Focar em contar uma boa hist√≥ria sem restri√ß√µes formais
‚úì Priorizar engajamento e fluidez

**ESTRUTURA SUGERIDA:**
1. Estabelecimento (contexto e personagens)
2. Desenvolvimento (conflito e progress√£o)
3. Cl√≠max (momento de maior tens√£o)
4. Resolu√ß√£o (desfecho satisfat√≥rio)

**FLEXIBILIDADE:**
- Pode usar di√°logos extensos ou ausentes
- Pode alternar entre a√ß√£o e contempla√ß√£o
- Pode misturar tempos verbais se necess√°rio
- Pode variar entre formal e coloquial

**DICA:** Use os elementos dos outros estilos conforme a cena:
- Momentos intensos? T√©cnicas de "A√ß√£o R√°pida"
- Momentos emotivos? Toques de "L√≠rico Po√©tico"
- Flashbacks? Elementos de "Reflexivo Mem√≥rias"
- Per√≠odo hist√≥rico? Cuidado com anacronismos do "√âpico"
- Explicar algo? Clareza do "Educativo"
''';
    }
  }

  Map<String, int> _extractNamesFromSnippet(String snippet) {
    final counts = <String, int>{};
    final regex = RegExp(
      r'\b([A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]+(?:\s+[A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]+)*)\b',
    );

    for (final match in regex.allMatches(snippet)) {
      final candidate = match.group(1)?.trim() ?? '';
      if (!_looksLikePersonName(candidate)) continue;
      final normalized = candidate.replaceAll(RegExp(r'\s+'), ' ');
      counts[normalized] = (counts[normalized] ?? 0) + 1;
    }

    return counts;
  }

  // üî• EXECUTAR EM ISOLATE para n√£o travar UI
  Future<String> _filterDuplicateParagraphs(
    String existing,
    String addition,
  ) async {
    if (addition.trim().isEmpty) return '';

    // Para textos pequenos, executar direto (mais r√°pido que spawn isolate)
    if (existing.length < 3000 && addition.length < 1000) {
      return _filterDuplicateParagraphsSync(existing, addition);
    }

    // Textos grandes: processar em isolate separado
    return await compute(_filterDuplicateParagraphsStatic, {
      'existing': existing,
      'addition': addition,
    });
  }

  // Vers√£o s√≠ncrona para casos r√°pidos
  String _filterDuplicateParagraphsSync(String existing, String addition) {
    if (addition.trim().isEmpty) return '';

    // üöÄ OTIMIZA√á√ÉO CR√çTICA: Comparar apenas √∫ltimos ~5000 caracteres
    final recentText = existing.length > 5000
        ? existing.substring(existing.length - 5000)
        : existing;

    final existingSet = recentText
        .split(RegExp(r'\n{2,}'))
        .map((p) => p.trim())
        .where((p) => p.isNotEmpty)
        .toSet();

    final seen = <String>{};
    final buffer = <String>[];

    for (final rawParagraph in addition.split(RegExp(r'\n{2,}'))) {
      final paragraph = rawParagraph.trim();
      if (paragraph.isEmpty) {
        continue;
      }

      if (existingSet.contains(paragraph)) {
        continue;
      }

      if (!seen.add(paragraph)) {
        continue;
      }

      buffer.add(paragraph);
    }

    return buffer.join('\n\n');
  }

  /// üîç Detecta par√°grafos duplicados no roteiro final (apenas para LOG)
  /// N√ÉO remove nada, apenas alerta no console para debugging
  void _detectDuplicateParagraphsInFinalScript(String fullScript) {
    final paragraphs = fullScript
        .split(RegExp(r'\n{2,}'))
        .map((p) => p.trim())
        .where((p) => p.isNotEmpty)
        .toList();

    final seen = <String, int>{};
    var duplicateCount = 0;

    for (var i = 0; i < paragraphs.length; i++) {
      final paragraph = paragraphs[i];

      if (seen.containsKey(paragraph)) {
        duplicateCount++;
        final firstIndex = seen[paragraph]!;
        final preview = paragraph.length > 80
            ? '${paragraph.substring(0, 80)}...'
            : paragraph;

        debugPrint('‚ö†Ô∏è DUPLICA√á√ÉO DETECTADA:');
        debugPrint(
          '   üìç Par√°grafo #${firstIndex + 1} repetido no par√°grafo #${i + 1}',
        );
        debugPrint('   üìù Pr√©via: "$preview"');
      } else {
        seen[paragraph] = i;
      }
    }

    if (duplicateCount > 0) {
      debugPrint(
        'üö® TOTAL: $duplicateCount par√°grafo(s) duplicado(s) encontrado(s) no roteiro final!',
      );
      debugPrint(
        '   üí° DICA: Fortale√ßa as instru√ß√µes anti-repeti√ß√£o no prompt',
      );
    } else {
      debugPrint(
        '‚úÖ VERIFICA√á√ÉO: Nenhuma duplica√ß√£o de par√°grafo detectada no roteiro final',
      );
    }
  }

  /// üö® VALIDA√á√ÉO CR√çTICA: Detecta reutiliza√ß√£o de nomes de personagens
  /// Cada personagem deve ter apenas 1 nome √∫nico
  void _validateProtagonistName(
    String generatedText,
    ScriptConfig config,
    int blockNumber,
  ) {
    final protagonistName = config.protagonistName.trim();
    if (protagonistName.isEmpty) return;

    // üî• PARTE 1: Validar protagonista espec√≠fica
    final suspiciousNames = [
      'Wanessa',
      'Carla',
      'Beatriz',
      'Fernanda',
      'Juliana',
      'Mariana',
      'Patr√≠cia',
      'Roberta',
      'Silvia',
      'Tatiana',
      'Carlos',
      'Eduardo',
      'Fernando',
      'Gustavo',
      'Henrique',
      'Leonardo',
      'Marcelo',
      'Rafael',
      'Rodrigo',
      'Thiago',
    ];

    final hasProtagonist = generatedText.contains(protagonistName);

    for (final suspiciousName in suspiciousNames) {
      if (suspiciousName.toLowerCase() == protagonistName.toLowerCase()) {
        continue;
      }

      if (generatedText.contains(suspiciousName)) {
        // üêõ DEBUG: Log erro cr√≠tico de nome
        _debugLogger.error(
          "Troca de nome detectada: '$suspiciousName'",
          blockNumber: blockNumber,
          details:
              "Protagonista deveria ser '$protagonistName' mas encontrei '$suspiciousName'",
          metadata: {
            'protagonista': protagonistName,
            'nomeEncontrado': suspiciousName,
          },
        );

        _log(
          'üö® ERRO CR√çTICO DETECTADO NO BLOCO $blockNumber:',
          level: 'critical',
        );
        _log(
          '   ‚ùå Protagonista deveria ser: "$protagonistName"',
          level: 'critical',
        );
        _log(
          '   ‚ùå Mas encontrei nome suspeito: "$suspiciousName"',
          level: 'critical',
        );
        _log(
          '   ‚ö†Ô∏è POSS√çVEL TROCA DE NOME DA PROTAGONISTA!',
          level: 'critical',
        );
        break;
      }
    }

    if (!hasProtagonist && blockNumber <= 2) {
      // üêõ DEBUG: Log aviso de protagonista ausente
      _debugLogger.warning(
        "Protagonista ausente",
        details: "'$protagonistName' n√£o apareceu no bloco $blockNumber",
        metadata: {'bloco': blockNumber, 'protagonista': protagonistName},
      );

      debugPrint(
        '‚ö†Ô∏è AVISO: Protagonista "$protagonistName" n√£o apareceu no bloco $blockNumber',
      );
    } else if (hasProtagonist) {
      // üêõ DEBUG: Log valida√ß√£o bem-sucedida
      _debugLogger.validation(
        "Protagonista validada",
        blockNumber: blockNumber,
        details: "'$protagonistName' presente no bloco",
        metadata: {'protagonista': protagonistName},
      );
    }
  }

  /// üÜï EXTRA√á√ÉO DE PAPEL: Identifica o papel/rela√ß√£o de um nome em um texto
  /// Retorna o primeiro papel encontrado ou null se n√£o detectar nenhum
  String? _extractRoleForName(String name, String text) {
    // Padr√µes para detectar rela√ß√µes familiares e sociais
    final rolePatterns = {
      'marido': RegExp(
        r'(?:meu|seu|nosso|o)\s+(?:marido|esposo)(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'esposa': RegExp(
        r'(?:minha|sua|nossa|a)\s+(?:esposa|mulher)(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'pai': RegExp(
        r'(?:meu|seu|nosso|o)\s+[Pp]ai(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'm√£e': RegExp(
        r'(?:minha|sua|nossa|a)\s+[Mm]√£e(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'filho': RegExp(
        r'(?:meu|seu|nosso|o)\s+[Ff]ilho(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'filha': RegExp(
        r'(?:minha|sua|nossa|a)\s+[Ff]ilha(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'irm√£o': RegExp(
        r'(?:meu|seu|nosso|o)\s+(?:irm√£o|irmao)(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'irm√£': RegExp(
        r'(?:minha|sua|nossa|a)\s+(?:irm√£|irma)(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'sogro': RegExp(
        r'(?:meu|seu|nosso|o)\s+sogro(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'sogra': RegExp(
        r'(?:minha|sua|nossa|a)\s+sogra(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'cunhado': RegExp(
        r'(?:meu|seu|nosso|o)\s+cunhado(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'cunhada': RegExp(
        r'(?:minha|sua|nossa|a)\s+cunhada(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'nora': RegExp(
        r'(?:minha|sua|nossa|a)\s+nora(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'genro': RegExp(
        r'(?:meu|seu|nosso|o)\s+genro(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'amigo': RegExp(
        r'(?:meu|seu|nosso|o)\s+amigo(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'amiga': RegExp(
        r'(?:minha|sua|nossa|a)\s+amiga(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'vizinho': RegExp(
        r'(?:o|um)\s+vizinho(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'vizinha': RegExp(
        r'(?:a|uma)\s+vizinha(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'tio': RegExp(
        r'(?:meu|seu|o)\s+[Tt]io(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'tia': RegExp(
        r'(?:minha|sua|a)\s+[Tt]ia(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'av√¥': RegExp(
        r'(?:meu|seu|o)\s+av√¥(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'av√≥': RegExp(
        r'(?:minha|sua|a)\s+av√≥(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'neto': RegExp(
        r'(?:meu|seu|o)\s+neto(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'neta': RegExp(
        r'(?:minha|sua|a)\s+neta(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'primo': RegExp(
        r'(?:meu|seu|o)\s+primo(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
      'prima': RegExp(
        r'(?:minha|sua|a)\s+prima(?:[^.]{0,30}\b' +
            name +
            r'\b|(?:,)?\s+' +
            name +
            r')',
        caseSensitive: false,
      ),
    };

    // Retornar primeiro papel encontrado
    for (final entry in rolePatterns.entries) {
      if (entry.value.hasMatch(text)) {
        return entry.key;
      }
    }

    return null; // Nenhum papel detectado
  }

  /// üÜï VALIDA√á√ÉO FORTALECIDA: Detecta quando um nome √© reutilizado para outro personagem
  /// Exemplo: "Regina" sendo usada para sogra E amiga, "Marta" para irm√£ de A e irm√£ de B
  void _validateNameReuse(
    String generatedText,
    _CharacterTracker tracker,
    int blockNumber,
  ) {
    // Extrair todos os nomes do texto gerado
    final namePattern = RegExp(r'\b([A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]{2,})\b');
    final foundNames = <String>{};

    for (final match in namePattern.allMatches(generatedText)) {
      final name = match.group(1)?.trim();
      if (name != null && _looksLikePersonName(name)) {
        foundNames.add(name);
      }
    }

    // Verificar se algum nome encontrado J√Å existe no tracker com papel diferente
    for (final name in foundNames) {
      if (tracker.hasName(name)) {
        final existingRole = tracker.getRole(name);

        // üî• NOVO: Detectar pap√©is/rela√ß√µes no texto atual (padr√µes expandidos)
        final currentRoles = <String>[];

        // PADR√ÉO 1: "meu/minha [rela√ß√£o] Nome" ou "Nome, [rela√ß√£o]" ou "a/o [rela√ß√£o], Nome"
        final relationPatterns = {
          'pai': RegExp(
            r'(?:meu|seu|nosso|o)\s+[Pp]ai(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:o\s+)?pai|(?:o|um)\s+pai(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'm√£e': RegExp(
            r'(?:minha|sua|nossa|a)\s+[Mm]√£e(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:a\s+)?m[√£a]e|(?:a|uma)\s+m[√£a]e(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'marido': RegExp(
            r'(?:meu|seu|nosso|o)\s+(?:marido|esposo)(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:o\s+)?(?:marido|esposo)|(?:o|um)\s+(?:marido|esposo)(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'esposa': RegExp(
            r'(?:minha|sua|nossa|a)\s+(?:esposa|mulher)(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:a\s+)?(?:esposa|mulher)|(?:a|uma)\s+(?:esposa|mulher)(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'filho': RegExp(
            r'(?:meu|seu|nosso|o)\s+[Ff]ilho(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:o\s+)?filho|(?:o|um)\s+filho(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'filha': RegExp(
            r'(?:minha|sua|nossa|a)\s+[Ff]ilha(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:a\s+)?filha|(?:a|uma)\s+filha(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'irm√£o': RegExp(
            r'(?:meu|seu|nosso|o)\s+(?:irm√£o|irmao)(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:o\s+)?(?:irm√£o|irmao)|(?:o|um)\s+(?:irm√£o|irmao)(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'irm√£': RegExp(
            r'(?:minha|sua|nossa|a)\s+(?:irm√£|irma)(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:a\s+)?(?:irm√£|irma)|(?:a|uma)\s+(?:irm√£|irma)(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'sogro': RegExp(
            r'(?:meu|seu|nosso|o)\s+sogro(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:o\s+)?sogro|(?:a|o)\s+sogro(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'sogra': RegExp(
            r'(?:minha|sua|nossa|a)\s+sogra(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:a\s+)?sogra|(?:a|uma)\s+sogra(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'amigo': RegExp(
            r'(?:meu|seu|nosso|o)\s+amigo(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:um\s+)?amigo|(?:o|um)\s+amigo(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'amiga': RegExp(
            r'(?:minha|sua|nossa|a)\s+amiga(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:uma\s+)?amiga|(?:a|uma)\s+amiga(?:,)?\s+' +
                name,
            caseSensitive: false,
          ),
          'vizinho': RegExp(
            r'(?:o|um)\s+vizinho(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:o\s+)?vizinho',
            caseSensitive: false,
          ),
          'vizinha': RegExp(
            r'(?:a|uma)\s+vizinha(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:a\s+)?vizinha',
            caseSensitive: false,
          ),
          'professor': RegExp(
            r'(?:o|um)\s+professor(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:um\s+)?professor',
            caseSensitive: false,
          ),
          'professora': RegExp(
            r'(?:a|uma)\s+professora(?:,)?\s+' +
                name +
                r'|' +
                name +
                r'(?:,)?\s+(?:uma\s+)?professora',
            caseSensitive: false,
          ),
        };

        for (final entry in relationPatterns.entries) {
          if (entry.value.hasMatch(generatedText)) {
            currentRoles.add(entry.key);
          }
        }

        // PADR√ÉO 2: "Nome, [rela√ß√£o] de [outra pessoa]"
        final contexts = [
          'irm√£ de',
          'irm√£o de',
          'filho de',
          'filha de',
          'pai de',
          'm√£e de',
          'esposa de',
          'esposo de',
          'marido de',
          'neto de',
          'neta de',
          'tio de',
          'tia de',
          'primo de',
          'prima de',
          'av√¥ de',
          'av√≥ de',
          'amiga de',
          'amigo de',
          'vizinha de',
          'vizinho de',
        ];

        for (final context in contexts) {
          final pattern = RegExp(
            name +
                r',?\s+' +
                context +
                r'\s+([A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]+)',
            caseSensitive: false,
          );
          final match = pattern.firstMatch(generatedText);

          if (match != null) {
            final relatedPerson = match.group(1);
            currentRoles.add('$context $relatedPerson');
          }
        }

        // üö® DETEC√á√ÉO: Se encontrou pap√©is no texto atual
        if (currentRoles.isNotEmpty) {
          final currentRolesStr = currentRoles.join(', ');

          // üî• CORRE√á√ÉO BUG ALBERTO: Validar mesmo se existingRole √© null
          if (existingRole == null || existingRole == 'indefinido') {
            // ‚ö†Ô∏è Nome existia SEM papel definido, agora tem papel
            debugPrint(
              '‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ALERTA: NOME SEM PAPEL ANTERIOR - BLOCO $blockNumber ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è',
            );
            debugPrint(
              '   üìù Nome "$name" estava no tracker SEM papel definido',
            );
            debugPrint('   üîç Pap√©is detectados AGORA: $currentRolesStr');

            // üö® CR√çTICO: Verificar se h√° m√∫ltiplos pap√©is CONFLITANTES no texto atual
            if (currentRoles.length > 1) {
              _debugLogger.error(
                "M√∫ltiplos pap√©is para '$name' no mesmo bloco",
                blockNumber: blockNumber,
                details:
                    "Nome '$name' aparece com pap√©is conflitantes no mesmo bloco:\n"
                    "- Pap√©is detectados: $currentRolesStr",
                metadata: {'nome': name, 'papeis': currentRoles},
              );

              debugPrint(
                'üö®üö®üö® ERRO CR√çTICO: M√öLTIPLOS PAP√âIS NO MESMO BLOCO üö®üö®üö®',
              );
              debugPrint('   ‚ùå Nome "$name" com M√öLTIPLOS pap√©is diferentes:');
              for (final role in currentRoles) {
                debugPrint('      - $role');
              }
              debugPrint(
                '   üí° SOLU√á√ÉO: Verificar se s√£o realmente a mesma pessoa!',
              );
              debugPrint(
                '   üí° Exemplo: "Alberto" como marido E como cunhado = ERRO!',
              );
              debugPrint('üö®üö®üö® FIM DO ALERTA üö®üö®üö®');
            } else {
              debugPrint('   ‚ÑπÔ∏è √önico papel detectado: ${currentRoles.first}');
              debugPrint('   ‚úÖ Atualizando papel no tracker...');
            }
            debugPrint('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FIM DO ALERTA ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è');
          } else {
            // Papel anterior existe - verificar CONFLITO
            var hasConflict = false;

            // Conflito se: nenhum papel atual aparece no papel existente
            if (!currentRoles.any(
              (role) => existingRole.toLowerCase().contains(role.toLowerCase()),
            )) {
              hasConflict = true;
            }

            if (hasConflict) {
              // üêõ DEBUG: Log erro cr√≠tico de reutiliza√ß√£o
              _debugLogger.error(
                "Reutiliza√ß√£o de nome: '$name'",
                blockNumber: blockNumber,
                details:
                    "Nome '$name' usado em m√∫ltiplos pap√©is diferentes:\n"
                    "- Papel anterior: $existingRole\n"
                    "- Pap√©is novos: $currentRolesStr",
                metadata: {
                  'nome': name,
                  'papelAnterior': existingRole,
                  'papeisNovos': currentRoles,
                },
              );

              debugPrint(
                'üö®üö®üö® ERRO CR√çTICO DE REUTILIZA√á√ÉO DE NOME - BLOCO $blockNumber üö®üö®üö®',
              );
              debugPrint(
                '   ‚ùå Nome "$name" est√° sendo REUTILIZADO EM PAP√âIS DIFERENTES!',
              );
              debugPrint('   üìã Papel anterior: "$name" como $existingRole');
              debugPrint('   ‚ö†Ô∏è Pap√©is novos detectados: $currentRolesStr');
              debugPrint(
                '   üí° SOLU√á√ÉO: Cada personagem precisa de nome √öNICO!',
              );
              debugPrint(
                '   üí° Exemplo: "Regina" n√£o pode ser sogra E amiga ao mesmo tempo',
              );
              debugPrint(
                '   üí° Sugest√£o: Trocar segundo "$name" por outro nome diferente',
              );
              debugPrint('üö®üö®üö® FIM DO ALERTA DE REUTILIZA√á√ÉO üö®üö®üö®');
            }
          }
        }
      }
    }

    // üêõ DEBUG: Log valida√ß√£o de nomes completa
    _debugLogger.validation(
      "Valida√ß√£o de reutiliza√ß√£o completa",
      blockNumber: blockNumber,
      details: "${foundNames.length} nomes verificados",
      metadata: {'nomesVerificados': foundNames.length},
    );
  }

  /// üÜï NOVA VALIDA√á√ÉO: Detecta inconsist√™ncias em rela√ß√µes familiares
  /// Exemplo: "meu Pai Francisco" vs "meu marido Francisco" = CONFUS√ÉO
  void _validateFamilyRelations(String generatedText, int blockNumber) {
    // Extrair nomes mencionados no texto
    final namePattern = RegExp(r'\b([A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]{2,})\b');
    final names = <String>{};

    for (final match in namePattern.allMatches(generatedText)) {
      final name = match.group(1)?.trim();
      if (name != null && _looksLikePersonName(name)) {
        names.add(name);
      }
    }

    // Para cada nome, verificar se aparece com m√∫ltiplas rela√ß√µes conflitantes
    for (final name in names) {
      final relations = <String>[];

      // Padr√µes de rela√ß√µes familiares
      final relationPatterns = {
        'pai': RegExp(
          '(?:meu|seu|nosso|o)\\s+[Pp]ai(?:,)?\\s+$name',
          caseSensitive: false,
        ),
        'm√£e': RegExp(
          '(?:minha|sua|nossa|a)\\s+[Mm]√£e(?:,)?\\s+$name',
          caseSensitive: false,
        ),
        'marido': RegExp(
          '(?:meu|seu|nosso|o)\\s+(?:marido|esposo)(?:,)?\\s+$name',
          caseSensitive: false,
        ),
        'esposa': RegExp(
          '(?:minha|sua|nossa|a)\\s+(?:esposa|mulher)(?:,)?\\s+$name',
          caseSensitive: false,
        ),
        'filho': RegExp(
          '(?:meu|seu|nosso|o)\\s+[Ff]ilho(?:,)?\\s+$name',
          caseSensitive: false,
        ),
        'filha': RegExp(
          '(?:minha|sua|nossa|a)\\s+[Ff]ilha(?:,)?\\s+$name',
          caseSensitive: false,
        ),
        'irm√£o': RegExp(
          '(?:meu|seu|nosso|o)\\s+(?:irm√£o|irmao)(?:,)?\\s+$name',
          caseSensitive: false,
        ),
        'irm√£': RegExp(
          '(?:minha|sua|nossa|a)\\s+(?:irm√£|irma)(?:,)?\\s+$name',
          caseSensitive: false,
        ),
      };

      // Verificar quais rela√ß√µes aparecem para este nome
      for (final entry in relationPatterns.entries) {
        if (entry.value.hasMatch(generatedText)) {
          relations.add(entry.key);
        }
      }

      // üö® DETECTAR CONFLITOS: Mesmo nome com rela√ß√µes incompat√≠veis
      final conflicts = _detectRelationConflicts(relations);

      if (conflicts.isNotEmpty) {
        _debugLogger.error(
          "Confus√£o em rela√ß√£o familiar: '$name'",
          blockNumber: blockNumber,
          details:
              "Nome '$name' aparece como: ${relations.join(', ')}\n"
              "Conflito: ${conflicts.join(', ')}",
          metadata: {
            'nome': name,
            'relacoes': relations,
            'conflitos': conflicts,
          },
        );

        debugPrint(
          'üö®üö®üö® ERRO CR√çTICO DE RELA√á√ÉO FAMILIAR - BLOCO $blockNumber üö®üö®üö®',
        );
        debugPrint('   ‚ùå Nome "$name" tem rela√ß√µes conflitantes!');
        debugPrint('   üìã Rela√ß√µes encontradas: ${relations.join(", ")}');
        debugPrint('   ‚ö†Ô∏è Conflitos: ${conflicts.join(", ")}');
        debugPrint(
          '   üí° SOLU√á√ÉO: Definir claramente se √© pai, marido, filho, etc.',
        );
        debugPrint('üö®üö®üö® FIM DO ALERTA DE RELA√á√ÉO FAMILIAR üö®üö®üö®');
      }
    }
  }

  /// Detecta conflitos entre rela√ß√µes familiares
  /// Retorna lista de descri√ß√µes de conflitos encontrados
  List<String> _detectRelationConflicts(List<String> relations) {
    final conflicts = <String>[];

    if (relations.length < 2) {
      return conflicts; // Sem conflito se h√° apenas 1 rela√ß√£o
    }

    // Grupos de rela√ß√µes mutuamente exclusivas
    final exclusiveGroups = [
      {'pai', 'marido', 'filho', 'irm√£o'}, // Rela√ß√µes masculinas diferentes
      {'m√£e', 'esposa', 'filha', 'irm√£'}, // Rela√ß√µes femininas diferentes
      {'pai', 'm√£e'}, // Pais n√£o podem ser a mesma pessoa
      {'marido', 'esposa'}, // C√¥njuges n√£o podem ser a mesma pessoa
      {'filho', 'pai'}, // Filho n√£o pode ser pai do narrador
      {'filha', 'm√£e'}, // Filha n√£o pode ser m√£e do narrador
    ];

    for (final group in exclusiveGroups) {
      final found = relations.where((r) => group.contains(r)).toList();
      if (found.length > 1) {
        conflicts.add('${found.join(" + ")} s√£o incompat√≠veis');
      }
    }

    return conflicts;
  }

  bool _looksLikePersonName(String value) {
    final cleaned = value.trim();
    if (cleaned.isEmpty) return false;

    // üî• VALIDA√á√ÉO RIGOROSA E DEFINITIVA:
    // üéØ APENAS aceitar nomes que est√£o no banco de dados curado do NameGeneratorService
    // Isso elimina TODOS os falsos positivos (verbos, adv√©rbios, palavras comuns)

    // Verificar se est√° no banco curado
    if (NameGeneratorService.isValidName(cleaned)) {
      return true; // ‚úÖ Nome 100% confirmado no banco de dados curado
    }

    // üö´ Se N√ÉO est√° no banco curado, REJEITAR imediatamente
    // N√ÉO vamos mais aceitar "nomes" que a AI inventou
    if (kDebugMode) {
      debugPrint('‚ö†Ô∏è NOME REJEITADO (n√£o est√° no banco curado): "$cleaned"');
    }
    return false;
  }

  static final Set<String> _nameStopwords = {
    // Plataformas/sites
    'youtube',
    'internet',
    'instagram',
    'facebook',
    'whatsapp',
    'tiktok',
    'google',
    'cta',

    // Pa√≠ses/lugares
    'brasil', 'portugal', 'portugues',

    // Pronomes e palavras comuns capitalizadas no in√≠cio de frases
    'ele',
    'ela',
    'eles',
    'elas',
    'nao',
    'sim',
    'mas',
    'mais',
    'cada',
    'todo',
    'toda',
    'todos',
    'meu',
    'minha',
    'meus',
    'minhas',
    'seu',
    'sua',
    'seus',
    'suas',
    'nosso',
    'nossa',
    'esse',
    'essa',
    'esses',
    'essas',
    'aquele',
    'aquela',
    'aquilo',
    'isto',
    'isso',
    'tudo',
    'nada',
    'algo',
    'alguem',
    'ninguem',
    'qualquer',
    'outro',
    'outra',
    'mesmo',
    'mesma',
    'esta', 'este', 'estes', 'estas',

    // Substantivos comuns que podem ser capitalizados
    'filho',
    'filha',
    'filhos',
    'pai',
    'mae',
    'pais',
    'irmao',
    'irma',
    'tio',
    'tia',
    'avo', 'neto', 'neta', 'marido', 'esposa', 'noivo', 'noiva',
    'amigo', 'amiga', 'primo', 'prima', 'sobrinho', 'sobrinha',
    'senhor',
    'senhora',
    'doutor',
    'doutora',
    'cliente',
    'pessoa',
    'pessoas',
    'gente',
    'familia', 'casa', 'mundo', 'vida', 'tempo', 'dia', 'noite', 'momento',

    // Adv√©rbios/conjun√ß√µes/preposi√ß√µes comuns no in√≠cio de frase
    'entao',
    'depois',
    'antes',
    'agora',
    'hoje',
    'ontem',
    'amanha',
    'sempre',
    'nunca',
    'talvez',
    'porem',
    'contudo',
    'entretanto',
    'portanto',
    'enquanto',
    'quando',
    'onde',
    'havia', 'houve', 'tinha', 'foram', 'eram', 'estava', 'estavam',
    'dentro',
    'fora',
    'acima',
    'abaixo',
    'perto',
    'longe',
    'aqui',
    'ali',
    'alem',
    'apenas',
    'somente',
    'tambem',
    'inclusive',
    'ate',
    'ainda',
    'logo',
    'ja',
    'nem',

    // Preposi√ß√µes e artigos (raramente, mas podem aparecer)
    'com', 'sem', 'sobre', 'para', 'pela', 'pelo', 'uma', 'umas', 'uns', 'por',

    // üî• FIX CR√çTICO: Palavras que a AI usou como NOMES FANTASMA (do roteiro analisado)
    'lagrimas',
    'l√°grimas',
    'justica',
    'justi√ßa',
    'ponto',
    'semanas',
    'aconteceu',
    'todas', 'ajuda', 'consolo', 'vamos', 'conhe√ßo', 'conheco', 'lembra',

    // Verbos comuns no in√≠cio de frase (EXPANDIDO)
    'era', 'foi', 'seria', 'pode', 'podia', 'deve', 'devia',
    'senti', 'sentiu', 'pensei', 'pensou', 'vi', 'viu', 'ouvi', 'ouviu',
    'fiz', 'fez', 'disse', 'falou', 'quis', 'pude', 'p√¥de',
    'tive',
    'teve',
    'sabia',
    'soube',
    'imaginei',
    'imaginou',
    'acreditei',
    'acreditou',
    'percebi', 'percebeu', 'notei', 'notou', 'lembrei', 'lembrou',
    'passei', 'abri', 'olhei', 'escrevo', 'escreveu', 'podes',
    'queria', 'quer', 'tenho', 'tem',
    'levei', 'levou', 'trouxe', 'deixei', 'deixou', 'encontrei', 'encontrou',
    'cheguei', 'chegou', 'sai', 'saiu', 'entrei', 'entrou',
    'peguei',
    'pegou',
    'coloquei',
    'colocou',
    'tirei',
    'tirou',
    'guardei',
    'guardou',
    'voltei',
    'voltou',
    'segui',
    'seguiu',
    'comecei',
    'come√ßou',
    'terminei',
    'terminou',
  };

  static String perspectiveLabel(String perspective) {
    final perspectiveLower = perspective.toLowerCase();

    // üî• FIX: Detectar primeira pessoa em qualquer formato
    if (perspectiveLower.contains('primeira_pessoa') ||
        perspectiveLower == 'first') {
      if (perspectiveLower.contains('mulher_idosa')) {
        return 'Primeira pessoa - Mulher Idosa';
      }
      if (perspectiveLower.contains('mulher_jovem')) {
        return 'Primeira pessoa - Mulher Jovem';
      }
      if (perspectiveLower.contains('homem_idoso')) {
        return 'Primeira pessoa - Homem Idoso';
      }
      if (perspectiveLower.contains('homem_jovem')) {
        return 'Primeira pessoa - Homem Jovem';
      }
      return 'Primeira pessoa';
    }

    // Terceira pessoa (padr√£o)
    return 'Terceira pessoa';
  }

  // üéØ CORRIGIDO: Instru√ß√£o CLARA de perspectiva com contexto do protagonista
  String _getPerspectiveInstruction(String perspective, ScriptConfig config) {
    final protagonistInfo = config.protagonistName.trim().isNotEmpty
        ? ' O protagonista √© "${config.protagonistName}".'
        : '';

    // üî• FIX: Aceitar valores reais da interface (primeira_pessoa_*, terceira_pessoa)
    final perspectiveLower = perspective.toLowerCase();

    // üö® DETECTAR G√äNERO DO NARRADOR BASEADO NA PERSPECTIVA
    if (perspectiveLower.contains('mulher')) {
      // FEMININO (ela)
    } else if (perspectiveLower.contains('homem')) {
      // MASCULINO (ele)
    }

    // Detectar primeira pessoa (qualquer varia√ß√£o)
    if (perspectiveLower.contains('primeira_pessoa') ||
        perspectiveLower == 'first') {
      // Definir pronomes baseado no tipo de primeira pessoa
      String pronomes = 'EU, MEU, MINHA, COMIGO';
      String exemplos =
          '"EU vendi a casa...", "MEU cora√ß√£o batia forte...", "COMIGO ela nunca foi honesta..."';
      String nomeInstrucao = '';

      if (perspectiveLower.contains('mulher')) {
        exemplos =
            '"EU vendi a casa...", "MINHA nora me traiu...", "COMIGO ela nunca foi honesta..."';
        nomeInstrucao = '''
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë üö® G√äNERO DO NARRADOR: FEMININO (MULHER) - LEIA ISTO ANTES DE GERAR! üö®      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è REGRA CR√çTICA SOBRE NOMES ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

1Ô∏è‚É£ SE O T√çTULO MENCIONAR UM NOME ESPEC√çFICO (ex: "Voc√™ √© Maria?"):
   ‚úÖ USE ESTE NOME para a protagonista
   ‚úÖ Exemplo: Se t√≠tulo diz "Maria", protagonista √© "Maria"

2Ô∏è‚É£ SE O T√çTULO N√ÉO MENCIONAR NENHUM NOME (ex: "Um milion√°rio me deu..."):
   ‚úÖ VOC√ä DEVE CRIAR um nome FEMININO apropriado
   ‚úÖ Exemplos de nomes femininos: Maria, Ana, Sofia, Helena, Clara, Beatriz, Julia, Laura
   ‚ùå PROIBIDO: Jo√£o, Pedro, Carlos, Michael, Roberto, Alberto, Paulo
   ‚ùå JAMAIS use nomes masculinos quando o narrador √© MULHER!

üéØ TESTE R√ÅPIDO ANTES DE GERAR:
‚ñ° O narrador √© MULHER? ‚Üí Nome deve ser FEMININO
‚ñ° O t√≠tulo menciona nome espec√≠fico? ‚Üí Use esse nome
‚ñ° T√≠tulo n√£o tem nome? ‚Üí Crie um nome FEMININO apropriado

''';
      } else if (perspectiveLower.contains('homem')) {
        exemplos =
            '"EU constru√≠ esse neg√≥cio...", "MEU filho me abandonou...", "COMIGO ele sempre foi desleal..."';
        nomeInstrucao = '''
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë üö® G√äNERO DO NARRADOR: MASCULINO (HOMEM) - LEIA ISTO ANTES DE GERAR! üö®      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è REGRA CR√çTICA SOBRE NOMES ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

1Ô∏è‚É£ SE O T√çTULO MENCIONAR UM NOME ESPEC√çFICO (ex: "Voc√™ √© Michael?"):
   ‚úÖ USE ESTE NOME para o protagonista
   ‚úÖ Exemplo: Se t√≠tulo diz "Michael", protagonista √© "Michael"

2Ô∏è‚É£ SE O T√çTULO N√ÉO MENCIONAR NENHUM NOME (ex: "Um milion√°rio me deu..."):
   ‚úÖ VOC√ä DEVE CRIAR um nome MASCULINO apropriado
   ‚úÖ Exemplos de nomes masculinos: Jo√£o, Pedro, Carlos, Roberto, Alberto, Paulo, Fernando, Ricardo
   ‚ùå PROIBIDO: Maria, Ana, Sofia, M√¥nica, Clara, Helena, Julia, Laura
   ‚ùå JAMAIS use nomes femininos quando o narrador √© HOMEM!

üéØ TESTE R√ÅPIDO ANTES DE GERAR:
‚ñ° O narrador √© HOMEM? ‚Üí Nome deve ser MASCULINO
‚ñ° O t√≠tulo menciona nome espec√≠fico? ‚Üí Use esse nome
‚ñ° T√≠tulo n√£o tem nome? ‚Üí Crie um nome MASCULINO apropriado

''';
      }

      return '''PERSPECTIVA NARRATIVA: PRIMEIRA PESSOA$protagonistInfo
$nomeInstrucao
‚ö†Ô∏è CR√çTICO: O PROTAGONISTA conta SUA PR√ìPRIA HIST√ìRIA usando "$pronomes".
üö´ PROIBIDO usar "ELE", "ELA", "DELE", "DELA" para o protagonista!
‚úÖ CORRETO: $exemplos
O protagonista √â o narrador. Ele/Ela est√° contando os eventos da SUA perspectiva em primeira pessoa.''';
    }

    // Terceira pessoa (padr√£o)
    return '''PERSPECTIVA NARRATIVA: TERCEIRA PESSOA$protagonistInfo
‚ö†Ô∏è IMPORTANTE: Um NARRADOR EXTERNO conta a hist√≥ria do protagonista usando "ELE", "ELA", "DELE", "DELA".
Exemplo: "ELA vendeu a casa...", "O cora√ß√£o DELE batia forte...", "COM ELA, ningu√©m foi honesto...".
O narrador observa e conta, mas N√ÉO √© o protagonista.''';
  }

  /// üöÄ OTIMIZA√á√ÉO: Limita contexto aos √∫ltimos blocos para evitar timeouts
  /// Mant√©m apenas os √∫ltimos N blocos + resumo inicial para continuidade
  String _buildLimitedContext(
    String fullContext,
    int currentBlock,
    int maxRecentBlocks,
  ) {
    if (fullContext.isEmpty || currentBlock <= maxRecentBlocks) {
      return fullContext; // Blocos iniciais usam tudo
    }

    // üî• LIMITE ABSOLUTO OTIMIZADO: Reduzido para evitar timeout em idiomas pesados
    // üö® CR√çTICO: 5.6k palavras causava timeout API 503 nos blocos 7-8
    // 3.5k palavras = ~21k caracteres cir√≠lico (mais seguro para Gemini)
    const maxContextWords = 3500; // REDUZIDO de 4500 para 3500
    final currentWords = _countWords(fullContext);

    if (currentWords <= maxContextWords) {
      return fullContext; // Contexto ainda est√° em tamanho seguro
    }

    // Separar em blocos (par√°grafos duplos ou mais)
    final blocks = fullContext.split(RegExp(r'\n{2,}'));
    if (blocks.length <= maxRecentBlocks + 5) {
      return fullContext; // Ainda n√£o tem muitos blocos
    }

    // Pegar resumo inicial (primeiros 3 par√°grafos - REDUZIDO de 5 para 3)
    final initialSummary = blocks.take(3).join('\n\n');

    // Pegar √∫ltimos N blocos completos (REDUZIDO multiplicador de 5 para 3)
    final recentBlocks = blocks
        .skip(max(0, blocks.length - maxRecentBlocks * 3))
        .join('\n\n');

    final result = '$initialSummary\n\n[...]\n\n$recentBlocks';

    // Verificar se ainda est√° muito grande
    if (_countWords(result) > maxContextWords) {
      // Reduzir ainda mais - s√≥ √∫ltimos blocos (REDUZIDO multiplicador de 3 para 2)
      return blocks
          .skip(max(0, blocks.length - maxRecentBlocks * 2))
          .join('\n\n');
    }

    return result;
  }

  // üåç MULTIPLICADORES DE VERBOSIDADE POR IDIOMA
  // Baseado em an√°lise de quantas palavras cada idioma precisa para expressar a mesma ideia
  // Portugu√™s = 1.0 (baseline) funciona perfeitamente
  double _getLanguageVerbosityMultiplier(String language) {
    final normalized = language.toLowerCase().trim();

    // üá≤üáΩ ESPANHOL: Tende a ser ~15-20% mais verboso que portugu√™s
    if (normalized.contains('espanhol') ||
        normalized.contains('spanish') ||
        normalized.contains('espa√±ol') ||
        normalized == 'es' ||
        normalized == 'es-mx') {
      return 0.85; // Pedir 15% menos para compensar
    }

    // üá¨üáß INGL√äS: Tende a ser ~15-20% mais CONCISO que portugu√™s
    // RAZ√ÉO: Ingl√™s usa menos palavras para expressar mesma ideia
    // EXEMPLO: "Eu estava pensando nisso" = 4 palavras ‚Üí "I was thinking" = 3 palavras
    // SOLU√á√ÉO: Pedir um pouco MAIS palavras para compensar a concis√£o
    // üîß AJUSTE: Reduzido de 1.18x ‚Üí 1.05x (estava gerando +21% a mais)
    if (normalized.contains('ingl√™s') ||
        normalized.contains('ingles') ||
        normalized.contains('english') ||
        normalized == 'en' ||
        normalized == 'en-us') {
      return 1.05; // Pedir 5% MAIS para compensar concis√£o
    }

    // üá´üá∑ FRANC√äS: Tende a ser ~10-15% mais verboso que portugu√™s
    if (normalized.contains('franc') ||
        normalized.contains('french') ||
        normalized == 'fr') {
      return 0.90; // Pedir 10% menos para compensar
    }

    // üáÆüáπ ITALIANO: Tende a ser ~10% mais verboso que portugu√™s
    if (normalized.contains('italia') ||
        normalized.contains('italian') ||
        normalized == 'it') {
      return 0.92; // Pedir 8% menos para compensar
    }

    // üá©üá™ ALEM√ÉO: Similar ao portugu√™s (palavras compostas compensam artigos)
    if (normalized.contains('alem') ||
        normalized.contains('german') ||
        normalized == 'de') {
      return 1.0; // Sem ajuste
    }

    // üá∑üá∫ RUSSO: Muito conciso (sem artigos, casos gramaticais)
    if (normalized.contains('russo') ||
        normalized.contains('russian') ||
        normalized == 'ru') {
      return 1.15; // Pedir 15% mais para compensar
    }

    // üáµüá± POLON√äS: Ligeiramente mais conciso que portugu√™s
    if (normalized.contains('polon') ||
        normalized.contains('polish') ||
        normalized == 'pl') {
      return 1.05; // Pedir 5% mais para compensar
    }

    // üáπüá∑ TURCO: Muito conciso (aglutina√ß√£o de palavras)
    if (normalized.contains('turco') ||
        normalized.contains('turk') ||
        normalized == 'tr') {
      return 1.20; // Pedir 20% mais para compensar
    }

    // üáßüá¨ B√öLGARO: Similar ao russo, conciso
    if (normalized.contains('b√∫lgar') ||
        normalized.contains('bulgar') ||
        normalized == 'bg') {
      return 1.12; // Pedir 12% mais para compensar
    }

    // üá≠üá∑ CROATA: Ligeiramente mais conciso
    if (normalized.contains('croat') ||
        normalized.contains('hrvat') ||
        normalized == 'hr') {
      return 1.08; // Pedir 8% mais para compensar
    }

    // üá∑üá¥ ROMENO: Similar ao portugu√™s (l√≠ngua latina)
    if (normalized.contains('romen') ||
        normalized.contains('roman') ||
        normalized == 'ro') {
      return 1.0; // Sem ajuste
    }

    // üáßüá∑ PORTUGU√äS ou OUTROS: Baseline perfeito
    return 1.0;
  }

  Future<String> _generateBlockContent(
    String previous,
    int target,
    String phase,
    ScriptConfig c,
    _CharacterTracker tracker,
    int blockNumber,
    int totalBlocks, {
    bool avoidRepetition =
        false, // üî• NOVO: Flag para regenera√ß√£o anti-repeti√ß√£o
  }) async {
    // üîß IMPORTANTE: target vem SEMPRE em PALAVRAS de _calculateTargetForBlock()
    // Mesmo quando measureType='caracteres', _calculateTargetForBlock j√° converteu caracteres‚Üípalavras
    // O Gemini trabalha melhor com contagem de PALAVRAS, ent√£o sempre pedimos palavras no prompt
    // Depois contamos caracteres no resultado final para validar se atingiu a meta do usu√°rio
    final needed = target;
    if (needed <= 0) return '';

    // üî• OTIMIZA√á√ÉO CR√çTICA: Limitar contexto aos √∫ltimos N blocos
    // v6.0: Portugu√™s usa MENOS contexto (3 blocos) para evitar erro 503
    // Outros idiomas: 4 blocos (padr√£o)
    // RATIONALE: Portugu√™s = mais tokens ‚Üí precisa contexto menor
    final isPortuguese = c.language.toLowerCase().contains('portugu');
    final maxContextBlocks = isPortuguese
        ? 3
        : 4; // PORTUGU√äS: 3 blocos (era 4)

    // Blocos iniciais (1-4): contexto completo
    // Blocos m√©dios/finais (5+): √∫ltimos N blocos apenas
    String contextoPrevio = previous.isEmpty
        ? ''
        : _buildLimitedContext(previous, blockNumber, maxContextBlocks);

    if (kDebugMode && previous.isNotEmpty) {
      final contextUsed = contextoPrevio.length;
      final contextType = blockNumber <= maxContextBlocks
          ? 'COMPLETO'
          : 'LIMITADO (√∫ltimos $maxContextBlocks blocos)';
      debugPrint(
        'üìö CONTEXTO $contextType: $contextUsed chars (${_countWords(contextoPrevio)} palavras)',
      );
      if (blockNumber > maxContextBlocks) {
        debugPrint(
          '   Original: ${previous.length} chars ‚Üí Reduzido: $contextUsed chars (${((1 - contextUsed / previous.length) * 100).toStringAsFixed(0)}% menor)',
        );
      }
    }

    // üî• SOLU√á√ÉO 3: Refor√ßar os nomes confirmados no prompt para manter consist√™ncia
    String trackerInfo = '';
    if (tracker.confirmedNames.isNotEmpty) {
      trackerInfo =
          '\n‚ö†Ô∏è MANTENHA estes nomes exatamente como definidos: ${tracker.confirmedNames.join(", ")}\n';
      // üî• NOVO: Adicionar mapeamento personagem-papel
      final mapping = tracker.getCharacterMapping();
      if (mapping.isNotEmpty) {
        trackerInfo += mapping;
        trackerInfo +=
            '‚ö†Ô∏è NUNCA confunda ou reutilize estes nomes! Cada nome = 1 personagem!\n';
      }
      if (kDebugMode) {
        debugPrint(
          'üî• Bloco $blockNumber - Nomes no tracker: ${tracker.confirmedNames.join(", ")}',
        );
        if (mapping.isNotEmpty) {
          debugPrint(
            'üé≠ Mapeamento: ${tracker.confirmedNames.map((n) => "$n=${tracker.getRole(n) ?? '?'}").join(", ")}',
          );
        }
      }
    }

    // üö® CORRE√á√ÉO CR√çTICA: SEMPRE injetar nome da protagonista, mesmo que n√£o esteja no tracker
    final protagonistName = c.protagonistName.trim();
    if (protagonistName.isNotEmpty && !trackerInfo.contains(protagonistName)) {
      trackerInfo +=
          '\nüî• ATEN√á√ÉO ABSOLUTA: O NOME DA PROTAGONISTA √â "$protagonistName"!\n';
      trackerInfo += '   ‚ùå NUNCA mude para outro nome (Wanessa, Carla, etc)\n';
      trackerInfo +=
          '   ‚úÖ SEMPRE use "$protagonistName" quando se referir √† protagonista!\n';
    }
    final characterGuidance = _buildCharacterGuidance(c, tracker);

    // üîß IMPORTANTE: Limitar palavras por bloco para estabilidade
    // O Gemini funciona melhor com targets de PALAVRAS, n√£o caracteres
    // Limite m√°ximo: 3500 palavras/bloco (‚âà 19.250 caracteres)
    final limitedNeeded = min(needed, 3500); // Sempre limitar em palavras

    // üìä SEMPRE pedir palavras no prompt (Gemini trabalha melhor assim)
    // O sistema converter√° caracteres‚Üípalavras antes de chegar aqui (_calculateTargetForBlock)
    // E validar√° caracteres no resultado final

    // üî• AJUSTE POR IDIOMA: Compensar verbosidade natural de cada idioma
    // Portugu√™s (baseline 1.0) funciona perfeitamente, outros ajustam proporcionalmente
    final languageMultiplier = _getLanguageVerbosityMultiplier(c.language);
    final adjustedTarget = (limitedNeeded * languageMultiplier).round();

    // Detectar se √© espanhol para mensagem espec√≠fica
    final isSpanish =
        c.language.toLowerCase().contains('espanhol') ||
        c.language.toLowerCase().contains('spanish') ||
        c.language.toLowerCase().contains('espa√±ol');

    // üéØ CONTROLE RIGOROSO DE CONTAGEM: ¬±8% aceit√°vel (ajustado de ¬±10%)
    // RAZ√ÉO: Multiplicador 1.08 deve manter resultado entre 92-108% da meta
    final minAcceptable = (adjustedTarget * 0.92).round();
    final maxAcceptable = (adjustedTarget * 1.08).round();

    final measure = isSpanish
        ? 'GERE EXATAMENTE $adjustedTarget palabras (M√çNIMO $minAcceptable, M√ÅXIMO $maxAcceptable). √â MELHOR ficar perto de $adjustedTarget do que muito abaixo!'
        : 'GERE EXATAMENTE $adjustedTarget palavras (M√çNIMO $minAcceptable, M√ÅXIMO $maxAcceptable). √â MELHOR ficar perto de $adjustedTarget do que muito abaixo!';
    final localizationGuidance = _buildLocalizationGuidance(c);
    final narrativeStyleGuidance = _getNarrativeStyleGuidance(c);

    // üîç DEBUG: Verificar se modo GLOBAL est√° sendo passado corretamente
    if (kDebugMode) {
      debugPrint('üåç MODO DE LOCALIZA√á√ÉO: ${c.localizationLevel.displayName}');
      if (c.localizationLevel == LocalizationLevel.global) {
        debugPrint(
          '‚úÖ MODO GLOBAL ATIVO - Prompt deve evitar nomes/comidas brasileiras',
        );
        debugPrint(
          'üìù Preview do prompt GLOBAL: ${localizationGuidance.substring(0, min(200, localizationGuidance.length))}...',
        );
      }
    }

    // üéØ INTEGRAR T√çTULO COMO HOOK IMPACTANTE NO IN√çCIO
    String instruction;
    if (previous.isEmpty) {
      if (c.startWithTitlePhrase && c.title.trim().isNotEmpty) {
        instruction = _getStartInstruction(
          c.language,
          withTitle: true,
          title: c.title,
        );
      } else {
        instruction = _getStartInstruction(c.language, withTitle: false);
      }
    } else {
      instruction = _getContinueInstruction(c.language);
    }

    // üêõ DEBUG: Verificar se genre est√° sendo passado
    if (kDebugMode) {
      debugPrint('üéØ GENRE RECEBIDO: ${c.genre}');
      debugPrint('üåç LANGUAGE RECEBIDO: ${c.language}');
    }

    // Gerar lista de nomes curados do banco de dados
    final nameList = NameGeneratorService.getNameListForPrompt(
      language: c.language,
      genre: c
          .genre, // NOVO: Usa genre do config (null = nomes do idioma, 'western' = nomes western)
      maxNamesPerCategory: 30,
    );

    // üêõ DEBUG: Verificar lista de nomes gerada
    if (kDebugMode) {
      debugPrint(
        'üìù PRIMEIROS 500 CHARS DA LISTA DE NOMES:\n${nameList.substring(0, nameList.length > 500 ? 500 : nameList.length)}',
      );
    }

    // üåç Obter labels traduzidos para os metadados
    final labels = _getMetadataLabels(c.language);

    //  Definir se inclui tema/subtema ou modo livre
    final temaSection = c.tema == 'Livre (Sem Tema)'
        ? '// Modo Livre: Desenvolva o roteiro baseado APENAS no t√≠tulo e contexto fornecidos\n'
        : '${labels['theme']}: ${c.tema}\n${labels['subtheme']}: ${c.subtema}\n';

    // üö´ CONSTRUIR LISTA DE NOMES PROIBIDOS (j√° usados nesta hist√≥ria)
    String forbiddenNamesWarning = '';
    if (tracker.confirmedNames.isNotEmpty) {
      final forbiddenList = tracker.confirmedNames.join(', ');
      forbiddenNamesWarning =
          'üö´üö´üö´ NOMES PROIBIDOS - N√ÉO USE ESTES NOMES! üö´üö´üö´\n'
          '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
          '‚õî Os seguintes nomes J√Å EST√ÉO EM USO nesta hist√≥ria:\n'
          '   ‚ùå $forbiddenList\n'
          '\n'
          'üö® REGRA ABSOLUTA:\n'
          '   ‚Ä¢ NUNCA reutilize os nomes acima!\n'
          '   ‚Ä¢ Cada nome = 1 personagem √∫nico\n'
          '   ‚Ä¢ Se precisar de novo personagem, escolha nome DIFERENTE\n'
          '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
          '\n';
    }

    // üéØ Adicionar informa√ß√µes espec√≠ficas de blocos (n√£o estava no template)
    final blockInfo =
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üìä INFORMA√á√ÉO DE BLOCOS (CR√çTICO PARA PLANEJAMENTO):\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '   ‚Ä¢ Total de blocos planejados: $totalBlocks\n'
        '   ‚Ä¢ Bloco atual: bloco n√∫mero $blockNumber de $totalBlocks\n'
        '   ${blockNumber < totalBlocks ? '‚Ä¢ Status: CONTINUA√á√ÉO - Este N√ÉO √© o √∫ltimo bloco!' : '‚Ä¢ Status: BLOCO FINAL - Conclua a hist√≥ria agora!'}\n'
        '\n'
        '${blockNumber < totalBlocks ? '‚ùå PROIBIDO NESTE BLOCO:\n   ‚Ä¢ N√ÉO finalize a hist√≥ria ainda!\n   ‚Ä¢ N√ÉO escreva "THE END" ou equivalente\n   ‚Ä¢ N√ÉO crie uma resolu√ß√£o completa e definitiva\n   ‚Ä¢ N√ÉO conclua todos os arcos narrativos\n   \n‚úÖ OBRIGAT√ìRIO NESTE BLOCO:\n   ‚Ä¢ CONTINUE desenvolvendo a trama\n   ‚Ä¢ Mantenha tens√£o e progress√£o narrativa\n   ‚Ä¢ Deixe ganchos para os pr√≥ximos blocos\n   ‚Ä¢ A hist√≥ria DEVE ter continua√ß√£o nos blocos seguintes\n   ‚Ä¢ Apenas desenvolva, N√ÉO conclua!\n' : '‚úÖ OBRIGAT√ìRIO NESTE BLOCO FINAL:\n   ‚Ä¢ AGORA SIM finalize completamente a hist√≥ria\n   ‚Ä¢ Resolva TODOS os conflitos pendentes\n   ‚Ä¢ D√™ fechamento a TODOS os personagens\n   ‚Ä¢ Este √© o √öLTIMO bloco - conclus√£o definitiva!\n'}\n'
        'ÔøΩ ATEN√á√ÉO ESPECIAL:\n'
        '   ‚Ä¢ Hist√≥rias longas precisam de TODOS os blocos planejados\n'
        '   ‚Ä¢ N√ÉO termine prematuramente s√≥ porque "parece completo"\n'
        '   ‚Ä¢ Cada bloco √© parte de um roteiro maior - respeite o planejamento\n'
        '   ‚Ä¢ Finais prematuros PREJUDICAM a qualidade e a experi√™ncia do ouvinte\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üéØ REGRA ABSOLUTA:\n'
        '   UMA HIST√ìRIA = UM CONFLITO CENTRAL = UM ARCO COMPLETO = UMA RESOLU√á√ÉO\n'
        '   PAR√ÅGRAFOS CURTOS = PAUSAS = DRAMATICIDADE = RETEN√á√ÉO ALTA\n'
        '   UM NOME = UM PERSONAGEM = NUNCA REUTILIZAR = VERIFICAR SEMPRE\n'
        '   DI√ÅLOGOS + MOTIVA√á√ïES + CLOSURE = HIST√ìRIA COMPLETA E SATISFAT√ìRIA\n'
        '\n'
        'üö´ NUNCA crie duas hist√≥rias separadas dentro do mesmo roteiro!\n'
        'üö´ NUNCA escreva par√°grafos com mais de 180 palavras!\n'
        'üö´ NUNCA reutilize nomes de personagens j√° mencionados!\n'
        'üö´ NUNCA deixe personagens importantes sem destino final!\n'
        'üö´ NUNCA fa√ßa trai√ß√µes/conflitos sem motiva√ß√£o clara!\n'
        '${blockNumber < totalBlocks ? 'üö´ NUNCA finalize a hist√≥ria antes do bloco final ($totalBlocks)!\n' : ''}'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';

    // üî• NOVO: Combinar prompt do template + informa√ß√µes de bloco
    final prompt = MainPromptTemplate.buildMainPrompt(
      language: _getLanguageInstruction(c.language),
      instruction: instruction,
      temaSection: temaSection,
      localizacao: c.localizacao,
      localizationGuidance: localizationGuidance,
      narrativeStyleGuidance: narrativeStyleGuidance,
      customPrompt: c.customPrompt,
      useCustomPrompt: c.useCustomPrompt,
      nameList: nameList,
      trackerInfo: trackerInfo,
      measure: measure,
      isSpanish: isSpanish,
      adjustedTarget: adjustedTarget,
      minAcceptable: minAcceptable,
      maxAcceptable: maxAcceptable,
      limitedNeeded: limitedNeeded,
      contextoPrevio: contextoPrevio,
      avoidRepetition: avoidRepetition,
      characterGuidance: characterGuidance,
      forbiddenNamesWarning: forbiddenNamesWarning,
      labels: labels,
    ) +
        blockInfo;

    if (kDebugMode) {
      debugPrint(
        '[$_instanceId] Gerando bloco balanceado: $limitedNeeded ${c.measureType}',
      );
    }

    try {
        '   ‚Ä¢ 2 Antagonistas principais\n'
        '   ‚Ä¢ 3 Secund√°rios (aliados, v√≠timas)\n'
        '   ‚ùå PROIBIDO: Mais de 6 personagens (p√∫blico perde o fio!)\n'
        '   ‚ùå PROIBIDO: Adicionar pai, m√£e, irm√£o, tio, primo = muitos!\n'
        '   ‚úÖ CORRETO: Outros familiares = MEN√á√ÉO, n√£o personagem\n'
        '\n'
        'üö® REGRA #2: 5 GANCHOS OBRIGAT√ìRIOS (A CADA 1.000 PALAVRAS)\n'
        '   \n'
        '   üé£ GANCHO 1 (primeiras 200 palavras):\n'
        '   "[VIL√ÉO] me [A√á√ÉO TERR√çVEL]. Mas eles n√£o sabiam de [SEGREDO].\n'
        '   Esta √© a hist√≥ria de como [PROMESSA DE VINGAN√áA]..."\n'
        '   \n'
        '   üé£ GANCHO 2 (~1.200 palavras / 12%):\n'
        '   "Quando [A√á√ÉO], eu pensei ter encontrado [ITEM].\n'
        '   Mas [DETALHE INTRIGANTE]... Era [REVELA√á√ÉO PARCIAL].\n'
        '   Mas eu ainda n√£o sabia [NOVA PERGUNTA]..."\n'
        '   \n'
        '   üé£ GANCHO 3 (~3.000 palavras / 30%):\n'
        '   "Eu achava que tinha [SOLU√á√ÉO].\n'
        '   Mas quando [PESSOA] [A√á√ÉO]... seu rosto [REA√á√ÉO ESTRANHA].\n'
        '   [FRASE MISTERIOSA]. [PERGUNTA QUE COMPLICA]"\n'
        '   \n'
        '   üé£ GANCHO 4 (~5.000 palavras / 50%):\n'
        '   "Finalmente, eu tinha [ARMAS/PROVAS].\n'
        '   [VIL√ïES] n√£o faziam ideia do que estava vindo.\n'
        '   Em [TEMPO], eles estariam [DESTINO RUIM]...\n'
        '   Mas primeiro... eu precisava [A√á√ÉO FINAL]."\n'
        '   \n'
        '   üé£ GANCHO 5 (~6.500 palavras / 65%):\n'
        '   "[A√á√ÉO DE ENTRADA]. [VIL√ÉO] estava [A√á√ÉO TRANQUILA].\n'
        '   Quando me viu, [REA√á√ÉO].\n'
        '   [A√á√ÉO COM OBJETO/PROVA]. [palavra √∫nica], eu disse.\n'
        '   E [RESULTADO DRAM√ÅTICO]."\n'
        '\n'
        'üö® REGRA #3: √öLTIMOS 35% = QUEDA DETALHADA (1.500+ PALAVRAS)\n'
        '   \n'
        '   ‚ùå PROIBIDO: "Eles foram presos. Perderam tudo. Fim."\n'
        '   ‚úÖ OBRIGAT√ìRIO: 5 BEATS da queda (veja se√ß√£o espec√≠fica abaixo):\n'
        '   \n'
        '   Beat 1: Chegada da autoridade (150 pal) - sirenes, pol√≠cia, p√¢nico\n'
        '   Beat 2: Momento da pris√£o (200 pal) - algemas, gritos, desespero\n'
        '   Beat 3: Desmoronamento (250 pal) - clientes saem, m√≠dia ataca\n'
        '   Beat 4: Consequ√™ncias p√∫blicas (200 pal) - manchetes, clube cancela\n'
        '   Beat 5: Destino final (200 pal) - julgamento, pris√£o, ru√≠na total\n'
        '   \n'
        '   DEPOIS: Confronto final cara a cara (300 palavras)\n'
        '   "X meses depois, [VIL√ÉO] pediu para me ver...\n'
        '   Entrei. Ele estava destru√≠do.\n'
        '   [DI√ÅLOGO DE RECONHECIMENTO]"\n'
        '\n'
        'üö® REGRA #4: VIL√ÉO 95% MALVADO + 5% HUMANO NO FIM\n'
        '   ‚Ä¢ Ato 1: Vil√£o RI, ZOMBA, HUMILHA (sem piedade!)\n'
        '   ‚Ä¢ Ato 2: Vil√£o em PODER (ostentando, pisando em cima)\n'
        '   ‚Ä¢ Ato 3: Vil√£o CAI + 1 momento de arrependimento (50 palavras)\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚úÖ SE VOC√ä SEGUIR ESTAS 4 REGRAS = ROTEIRO PERFEITO PARA YOUTUBE!\n'
        '‚ùå SE IGNORAR = ROTEIRO SER√Å REJEITADO!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '$forbiddenNamesWarning' // ‚Üê üî• NOMES PROIBIDOS LOGO NO IN√çCIO!
        'üÜïüÜïüÜï IMPORTANTE - ESTE √â UM ROTEIRO NOVO! üÜïüÜïüÜï\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è ATEN√á√ÉO CR√çTICA: Voc√™ est√° come√ßando uma NOVA hist√≥ria!\n'
        '\n'
        'üîÑ RESET COMPLETO:\n'
        '   ‚Ä¢ IGNORE todos os nomes de roteiros anteriores\n'
        '   ‚Ä¢ IGNORE todos os personagens de hist√≥rias passadas\n'
        '   ‚Ä¢ COMECE com uma lista ZERADA de nomes\n'
        '   ‚Ä¢ Este roteiro N√ÉO tem rela√ß√£o com roteiros anteriores\n'
        '\n'
        '‚ùå PROIBIDO usar nomes de roteiros antigos:\n'
        '   ‚Ä¢ Se o roteiro anterior tinha "H√©lio" (advogado), ESQUE√áA!\n'
        '   ‚Ä¢ Se outro roteiro tinha "Alberto" (empres√°rio), ESQUE√áA!\n'
        '   ‚Ä¢ CADA roteiro come√ßa do ZERO com nomes NOVOS!\n'
        '\n'
        '‚úÖ CORRETO:\n'
        '   ‚Ä¢ Use APENAS a lista "NOMES DISPON√çVEIS" abaixo\n'
        '   ‚Ä¢ Escolha nomes adequados para ESTA hist√≥ria\n'
        '   ‚Ä¢ N√£o se preocupe com roteiros passados\n'
        '\n'
        'üéØ REGRA DE OURO:\n'
        '   Novo roteiro = Nova hist√≥ria = Novos personagens = Novos nomes!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '${contextoPrevio.isNotEmpty ? 'CONTEXTO:\n$contextoPrevio\n\n' : ''}'
        '${avoidRepetition ? '\nüö® AVISO URGENTE: O bloco anterior foi REJEITADO por repeti√ß√£o!\n‚ö†Ô∏è VOC√ä COPIOU PAR√ÅGRAFOS DO CONTEXTO! Isso √© PROIBIDO!\n‚úÖ AGORA: Escreva conte√∫do 100% NOVO, SEM copiar frases anteriores!\n   Use palavras DIFERENTES, estruturas DIFERENTES, avance a hist√≥ria!\n\n' : ''}'
        '${characterGuidance.isEmpty ? '' : characterGuidance}'
        '$instruction.\n' // ‚Üê T√≠tulo J√Å est√° na instruction se withTitle=true
        '$temaSection'
        '${c.localizacao.trim().isEmpty ? '${labels['location']}: ${labels['locationNotSpecified']}' : '${labels['location']}: ${c.localizacao}'}\n'
        '$localizationGuidance'
        '\n'
        'üéØ INTERPRETA√á√ÉO CORRETA DO TEMA - CR√çTICO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è ATEN√á√ÉO M√ÅXIMA: Leia o TEMA acima e interprete CORRETAMENTE!\n'
        '\n'
        'üö® PALAVRAS-CHAVE QUE EXIGEM RESOLU√á√ÉO:\n'
        '\n'
        '1Ô∏è‚É£ Se o tema cont√©m "REVIRAVOLTA":\n'
        '   ‚Üí Protagonista DEVE experimentar mudan√ßa CONCRETA de situa√ß√£o\n'
        '   ‚Üí N√ÉO basta "descobrir" algo, deve CONSEGUIR/REALIZAR algo\n'
        '   \n'
        '   Exemplos:\n'
        '   ‚Ä¢ "Heran√ßa Injusta com Reviravolta Milion√°ria"\n'
        '     ‚ùå ERRADO: Protagonista descobre pista de fortuna [PARA SEM PEGAR]\n'
        '     ‚úÖ CORRETO: Protagonista CONSEGUE a fortuna e fica rico\n'
        '   \n'
        '   ‚Ä¢ "Do Lixo ao Luxo"\n'
        '     ‚ùå ERRADO: Protagonista v√™ oportunidade de ficar rico [PARA SEM CONSEGUIR]\n'
        '     ‚úÖ CORRETO: Protagonista FICA RICO e vive no luxo\n'
        '\n'
        '2Ô∏è‚É£ Se o tema cont√©m "VINGAN√áA" ou "JUSTI√áA":\n'
        '   ‚Üí Protagonista DEVE executar a vingan√ßa/justi√ßa (n√£o apenas planejar)\n'
        '   ‚Üí Vil√£o DEVE sofrer consequ√™ncia vis√≠vel\n'
        '   \n'
        '   Exemplos:\n'
        '   ‚Ä¢ "Vingan√ßa do Tra√≠do"\n'
        '     ‚ùå ERRADO: Protagonista descobre trai√ß√£o e planeja vingan√ßa [PARA SEM EXECUTAR]\n'
        '     ‚úÖ CORRETO: Protagonista EXECUTA vingan√ßa, traidor sofre consequ√™ncias\n'
        '   \n'
        '   ‚Ä¢ "Justi√ßa Feita"\n'
        '     ‚ùå ERRADO: Protagonista re√∫ne provas [PARA SEM APRESENTAR]\n'
        '     ‚úÖ CORRETO: Protagonista APRESENTA provas, culpado √© condenado\n'
        '\n'
        '3Ô∏è‚É£ Se o tema cont√©m "MILION√ÅRIA/O", "RICA/O", "FORTUNA":\n'
        '   ‚Üí Protagonista DEVE conseguir dinheiro/riqueza de forma concreta\n'
        '   ‚Üí Hist√≥ria DEVE mostrar protagonista COM o dinheiro\n'
        '   \n'
        '   Exemplos:\n'
        '   ‚Ä¢ "Reviravolta Milion√°ria"\n'
        '     ‚ùå ERRADO: Protagonista encontra c√≥digo de conta banc√°ria [PARA SEM ACESSAR]\n'
        '     ‚úÖ CORRETO: Protagonista ACESSA conta, PEGA dinheiro, FICA RICO\n'
        '   \n'
        '   ‚Ä¢ "Heran√ßa Escondida"\n'
        '     ‚ùå ERRADO: Protagonista descobre localiza√ß√£o da heran√ßa [PARA SEM PEGAR]\n'
        '     ‚úÖ CORRETO: Protagonista ENCONTRA heran√ßa, DECIDE pegar ou n√£o, VIVE com consequ√™ncia\n'
        '\n'
        '4Ô∏è‚É£ Se o tema cont√©m "TRIUNFO", "VIT√ìRIA", "SUCESSO":\n'
        '   ‚Üí Protagonista DEVE vencer o desafio/antagonista\n'
        '   ‚Üí Final DEVE mostrar estado de vit√≥ria clara\n'
        '   \n'
        '   Exemplos:\n'
        '   ‚Ä¢ "Triunfo do Humilhado"\n'
        '     ‚ùå ERRADO: Protagonista planeja como humilhar de volta [PARA SEM EXECUTAR]\n'
        '     ‚úÖ CORRETO: Protagonista EXECUTA plano, antagonista √© humilhado publicamente\n'
        '\n'
        '5Ô∏è‚É£ Se o tema cont√©m "MUDAN√áA DE STATUS" (pobre‚Üírico, humilde‚Üípoderoso):\n'
        '   ‚Üí Protagonista DEVE alcan√ßar o novo status\n'
        '   ‚Üí Hist√≥ria DEVE mostrar vida DEPOIS da mudan√ßa\n'
        '   \n'
        '   Exemplos:\n'
        '   ‚Ä¢ "Do Nada ao Topo"\n'
        '     ‚ùå ERRADO: Protagonista tem chance de subir [PARA SEM SUBIR]\n'
        '     ‚úÖ CORRETO: Protagonista SOBE, alcan√ßa topo, mostra nova vida\n'
        '\n'
        'üìä M√âTODO DE INTERPRETA√á√ÉO:\n'
        '\n'
        '   PASSO 1: Leia o TEMA completo\n'
        '   PASSO 2: Identifique as palavras-chave (reviravolta, vingan√ßa, milion√°ria, etc.)\n'
        '   PASSO 3: Para CADA palavra-chave, defina O QUE DEVE ACONTECER:\n'
        '   \n'
        '   Exemplo com "Heran√ßa Injusta com Reviravolta Milion√°ria":\n'
        '   \n'
        '   Palavra-chave 1: "HERAN√áA INJUSTA"\n'
        '   ‚Üí Setup: Protagonista recebe pouco/nada, outros recebem muito\n'
        '   \n'
        '   Palavra-chave 2: "REVIRAVOLTA"\n'
        '   ‚Üí Meio: Protagonista descobre que heran√ßa dele tinha segredo\n'
        '   ‚Üí Fim: Protagonista USA o segredo para mudar situa√ß√£o\n'
        '   \n'
        '   Palavra-chave 3: "MILION√ÅRIA"\n'
        '   ‚Üí Fim: Protagonista CONSEGUE milh√µes (dinheiro, conta, heran√ßa real)\n'
        '   ‚Üí Mostra: Protagonista COM o dinheiro, decidindo o que fazer\n'
        '   \n'
        '   ESTRUTURA FINAL OBRIGAT√ìRIA:\n'
        '   ‚Ä¢ 0-25%: Setup da injusti√ßa\n'
        '   ‚Ä¢ 25-50%: Descoberta do segredo (reviravolta)\n'
        '   ‚Ä¢ 50-75%: Busca/acesso ao dinheiro\n'
        '   ‚Ä¢ 75-100%: CONSEGUE dinheiro + decis√£o + consequ√™ncia\n'
        '\n'
        'üö® REGRA ABSOLUTA:\n'
        '   Tema = PROMESSA ao espectador\n'
        '   "Reviravolta Milion√°ria" = PROMETE que protagonista ficar√° rico\n'
        '   Se voc√™ N√ÉO mostrar isso, voc√™ QUEBROU A PROMESSA!\n'
        '   \n'
        '   ‚ùå Descobrir = Insuficiente\n'
        '   ‚ùå Ir buscar = Insuficiente\n'
        '   ‚úÖ CONSEGUIR + mostrar resultado = CORRETO\n'
        '\n'
        'üí° CHECKLIST ANTES DE ESCREVER:\n'
        '   ‚ñ° Li o tema completamente?\n'
        '   ‚ñ° Identifiquei TODAS as palavras-chave de resultado?\n'
        '   ‚ñ° Defini O QUE deve acontecer para cada palavra-chave?\n'
        '   ‚ñ° Planejei estrutura que CAIBA tudo (incluindo resolu√ß√£o)?\n'
        '   ‚ñ° Reservei 35% do espa√ßo para MOSTRAR o resultado final?\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '$narrativeStyleGuidance'
        '\n'
        'üé® DIVERSIDADE DE MET√ÅFORAS E FIGURAS DE LINGUAGEM:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üö® REGRA CR√çTICA: VOCABUL√ÅRIO TEM√ÅTICO REPETITIVO\n'
        '\n'
        '‚ö†Ô∏è IMPORTANTE: Mesmo que a hist√≥ria se passe numa oficina/jardim/cozinha/hospital,\n'
        '   N√ÉO use palavras desse ambiente como MET√ÅFORAS L√çRICAS repetitivas!\n'
        '\n'
        'üìä LIMITE ABSOLUTO: M√°ximo 10 compara√ß√µes po√©ticas com tema central\n'
        '\n'
        '‚ùå EXEMPLOS RUINS - Hist√≥ria de Marceneiro:\n'
        '   ‚Ä¢ "lixando as arestas da dor" ‚Üí 5 vezes ‚ùå\n'
        '   ‚Ä¢ "envernizando mem√≥rias" ‚Üí 8 vezes ‚ùå\n'
        '   ‚Ä¢ "costurando/tecendo o passado" ‚Üí 12 vezes ‚ùå\n'
        '   ‚Ä¢ "madeira da vida/alma/cora√ß√£o" ‚Üí 15 vezes ‚ùå\n'
        '   ‚Ä¢ Resultado: 40 met√°foras tem√°ticas = REPROVADO!\n'
        '\n'
        '‚ùå EXEMPLOS RUINS - Hist√≥ria de Costureira:\n'
        '   ‚Ä¢ "alinhavando esperan√ßa" ‚Üí 16 vezes ‚ùå\n'
        '   ‚Ä¢ "bordando sentimentos" ‚Üí 15 vezes ‚ùå\n'
        '   ‚Ä¢ "tecendo/costurando mem√≥rias" ‚Üí 23 vezes ‚ùå\n'
        '   ‚Ä¢ Resultado: 54 met√°foras tem√°ticas = REPROVADO!\n'
        '\n'
        '‚úÖ FA√áA ASSIM - Hist√≥ria de Marceneiro:\n'
        '   DESCRI√á√ÉO LITERAL (permitido):\n'
        '   ‚Ä¢ "trabalhei a madeira" ‚Üí OK (a√ß√£o concreta)\n'
        '   ‚Ä¢ "cheiro de madeira no ar" ‚Üí OK (descri√ß√£o ambiente)\n'
        '   ‚Ä¢ "lixei a t√°bua" ‚Üí OK (trabalho real)\n'
        '\n'
        '   MET√ÅFORAS VARIADAS (incentivado):\n'
        '   ‚Ä¢ "construir algo a partir de ru√≠nas" ‚Üí 3 vezes ‚úì\n'
        '   ‚Ä¢ "como um rio que encontra seu leito" ‚Üí 2 vezes ‚úì\n'
        '   ‚Ä¢ "forjado no fogo" ‚Üí 2 vezes ‚úì\n'
        '   ‚Ä¢ "fantasmas do passado" ‚Üí 3 vezes ‚úì\n'
        '   ‚Ä¢ Resultado: 10 met√°foras variadas = APROVADO!\n'
        '\n'
        'üéØ ESTRAT√âGIA DE VARIA√á√ÉO:\n'
        '   1. Descreva o trabalho/ambiente LITERALMENTE (sem poesia)\n'
        '   2. Use met√°foras VARIADAS para emo√ß√µes:\n'
        '      ‚Ä¢ √Ågua: rio, correnteza, lago, oceano\n'
        '      ‚Ä¢ Fogo: chama, cinzas, brasas, inc√™ndio\n'
        '      ‚Ä¢ Luz: sombra, brilho, escurid√£o, aurora\n'
        '      ‚Ä¢ Natureza: tempestade, vento, raiz, semente\n'
        '   3. Evite repetir a MESMA imagem mais de 3 vezes\n'
        '   4. Linguagem direta √© poderosa - nem tudo precisa ser met√°fora!\n'
        '\n'
        'üí° LEMBRE-SE: A repeti√ß√£o excessiva cansa o leitor.\n'
        '   Varie as imagens. Seja criativo. Use linguagem clara.\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        // üéØ SE√á√ÉO CUSTOMIZADA DO USU√ÅRIO (se habilitada)
        '${c.useCustomPrompt && c.customPrompt.trim().isNotEmpty ? '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë  üìù INSTRU√á√ïES PERSONALIZADAS DO USU√ÅRIO (PRIORIDADE ALTA)   ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\nüö® ATEN√á√ÉO: O usu√°rio forneceu instru√ß√µes espec√≠ficas abaixo.\n   Estas instru√ß√µes t√™m PRIORIDADE sobre as diretrizes padr√£o.\n   Siga-as rigorosamente ao criar o roteiro.\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n${c.customPrompt.trim()}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n‚úÖ IMPORTANTE: Combine as instru√ß√µes acima com as diretrizes\n   t√©cnicas (formato, extens√£o, nomes) j√° fornecidas.\n\n' : ''}'
        '$nameList\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üö® ATEN√á√ÉO: A lista de nomes acima √© sua √öNICA fonte de nomes!\n'
        '   COPIE os nomes EXATAMENTE daquela lista ao criar personagens.\n'
        '   Se voc√™ usar palavras como "Observei", "Quero", "Pergunte" como nomes,\n'
        '   voc√™ est√° FALHANDO nesta tarefa. Esses s√£o VERBOS, n√£o NOMES!\n'
        '\n'
        'üé≤ IMPORTANTE - VARIEDADE DE NOMES:\n'
        '   A lista de nomes est√° EMBARALHADA de forma aleat√≥ria.\n'
        '   ‚ö†Ô∏è N√ÉO escolha sempre os primeiros nomes da lista!\n'
        '   ‚úÖ VARIE sua escolha: use nomes do MEIO e do FIM da lista tamb√©m!\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üî¥üî¥üî¥ CONTROLE DE NOMES USADOS - LEIA COM ATEN√á√ÉO üî¥üî¥üî¥\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '$trackerInfo'
        '${trackerInfo.isNotEmpty ? '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüö´ REGRA ABSOLUTA: NUNCA REUTILIZE OS NOMES ACIMA!\n   Eles J√Å PERTENCEM a personagens espec√≠ficos desta hist√≥ria.\n   Se voc√™ precisar de um novo personagem, escolha um nome DIFERENTE\n   da lista de nomes dispon√≠veis (acima desta se√ß√£o).\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n' : ''}'
        '   ‚úÖ EXPLORE toda a lista antes de repetir qualquer nome!\n'
        '   Exemplo: Se h√° 30 nomes dispon√≠veis, use pelo menos 15-20 diferentes\n'
        '            antes de considerar reutilizar algum (em blocos muito distantes).\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üé¨ FORMATO: NOVELINHA YOUTUBE NARRADA (ATEN√á√ÉO AUDITIVA)\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è P√∫blico OUVE (n√£o l√™) enquanto dirige, limpa casa, trabalha\n'
        '   ‚Üí Precisa seguir a hist√≥ria SEM ver nada na tela!\n'
        '\n'
        'üö® LIMITE ABSOLUTO DE PERSONAGENS:\n'
        '   ‚Ä¢ Protagonista: 1 (sempre o narrador em 1¬™ pessoa)\n'
        '   ‚Ä¢ Antagonistas principais: M√ÅXIMO 2\n'
        '     Exemplo: esposa traidora + amante dela ‚úÖ\n'
        '     Exemplo: s√≥cio + irm√£o traidor ‚úÖ\n'
        '   ‚Ä¢ Personagens secund√°rios: M√ÅXIMO 3\n'
        '     Exemplo: aliado que ajuda + filho da protagonista + advogado\n'
        '   \n'
        '   TOTAL M√ÅXIMO: 6 personagens com nome\n'
        '   \n'
        '   ‚ùå PROIBIDO: Introduzir novo vil√£o ap√≥s 40% da hist√≥ria\n'
        '   ‚ùå PROIBIDO: Personagens que aparecem 1x e somem (use fun√ß√£o)\n'
        '   ‚ùå PROIBIDO: M√∫ltiplas gera√ß√µes (av√¥, pai, filho = confuso!)\n'
        '   \n'
        'üìä TESTE DE CLAREZA AUDITIVA:\n'
        '   "Se algu√©m perdeu 5 minutos de √°udio, consegue voltar e entender?"\n'
        '   ‚Üí Se N√ÉO = voc√™ tem personagens DEMAIS!\n'
        '   \n'
        'üéØ PADR√ÉO CAMPE√ÉO (canais com 1M+ subs):\n'
        '   ‚Ä¢ 1 Protagonista (narrador)\n'
        '   ‚Ä¢ 2 Vil√µes principais (quem causou a injusti√ßa)\n'
        '   ‚Ä¢ 1-2 Aliados (ajudam na vingan√ßa)\n'
        '   ‚Ä¢ 0-1 V√≠tima secund√°ria (opcional - ex: filho tamb√©m prejudicado)\n'
        '\n'
        '‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ATEN√á√ÉO ESPECIAL: TEMAS FAMILIARES ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üö® Se o tema √© "Vingan√ßa Familiar", "Heran√ßa Familiar", "Trai√ß√£o Familiar":\n'
        '\n'
        '   ‚ùå ERRO COMUM: Adicionar pai, m√£e, irm√£os, tios, primos = 10+ personagens\n'
        '   ‚úÖ CORRETO: Limite de 6 personagens AINDA VALE!\n'
        '\n'
        'üí° COMO FAZER VINGAN√áA FAMILIAR COM 6 PERSONAGENS:\n'
        '\n'
        '   OP√á√ÉO 1 - Irm√£os Traidores:\n'
        '   ‚Ä¢ Protagonista (narrador)\n'
        '   ‚Ä¢ Irm√£o 1 (vil√£o principal)\n'
        '   ‚Ä¢ Irm√£o 2 (vil√£o secund√°rio)\n'
        '   ‚Ä¢ Advogado (aliado)\n'
        '   ‚Ä¢ Pai/M√£e (APENAS MENCIONADO, n√£o personagem ativo)\n'
        '   Total: 4 personagens vivos ‚úÖ\n'
        '\n'
        '   OP√á√ÉO 2 - Trai√ß√£o de C√¥njuge + S√≥cio Familiar:\n'
        '   ‚Ä¢ Protagonista (narrador)\n'
        '   ‚Ä¢ Esposa (vil√£ 1)\n'
        '   ‚Ä¢ Cunhado/Primo (vil√£o 2 - trabalha com protagonista)\n'
        '   ‚Ä¢ Advogado (aliado)\n'
        '   Total: 4 personagens ‚úÖ\n'
        '\n'
        '   OP√á√ÉO 3 - Heran√ßa Injusta:\n'
        '   ‚Ä¢ Protagonista (narrador)\n'
        '   ‚Ä¢ Irm√£o favorito (vil√£o)\n'
        '   ‚Ä¢ Advogado corrupto (vil√£o 2)\n'
        '   ‚Ä¢ Investigador (aliado)\n'
        '   ‚Ä¢ Falecido (pai/m√£e que morreu - APENAS MENCIONADO)\n'
        '   Total: 4 personagens vivos ‚úÖ\n'
        '\n'
        'üéØ REGRA DE OURO PARA FAM√çLIAS:\n'
        '   ‚Ä¢ M√°ximo 2 membros da fam√≠lia do protagonista VIVOS E ATIVOS\n'
        '   ‚Ä¢ M√°ximo 2 membros da fam√≠lia rival VIVOS E ATIVOS\n'
        '   ‚Ä¢ Outros familiares: Use MEN√á√ÉO, n√£o personagem!\n'
        '\n'
        '‚ùå PROIBIDO em temas familiares:\n'
        '   ‚Ä¢ "O pai de Richard, Harold, tamb√©m se envolveu..."\n'
        '   ‚Ä¢ "A m√£e de Jessica, Martha, ligou para..."\n'
        '   ‚Ä¢ "O irm√£o de Thomas, Charles, descobriu que..."\n'
        '   ‚Ä¢ "O tio de Richard, Walter, era dono de..."\n'
        '   ‚Üí TODOS esses s√£o personagens EXTRAS que estouram o limite!\n'
        '\n'
        '‚úÖ PERMITIDO em temas familiares:\n'
        '   ‚Ä¢ "Meu pai sempre dizia..." (men√ß√£o, sem di√°logo)\n'
        '   ‚Ä¢ "Quando minha m√£e morreu, deixou..." (contexto)\n'
        '   ‚Ä¢ "Meu irm√£o mais novo estava na faculdade" (background)\n'
        '   ‚Üí Men√ß√µes SEM transformar em personagem ativo!\n'
        '\n'
        'üö® TESTE FINAL: Conte os personagens que T√äM DI√ÅLOGO ou A√á√ÉO:\n'
        '   Se > 6 personagens = VOC√ä FALHOU!\n'
        '   Volte e transforme personagens extras em MEN√á√ïES!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚ö†Ô∏è OBRIGAT√ìRIO: $measure - ESTE √â UM REQUISITO ABSOLUTO!\n'
        '\n'
        'üö® CONTROLE RIGOROSO DE EXTENS√ÉO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è A META DE PALAVRAS √â OBRIGAT√ìRIA E SER√Å VERIFICADA!\n'
        '\n'
        '‚ùå N√ÉO PARE MUITO ANTES DA META!\n'
        '   ‚Ä¢ Se a meta √© $adjustedTarget palavras, N√ÉO pare com ${(adjustedTarget * 0.85).round()} palavras!\n'
        '   ‚Ä¢ Continuar a narrativa at√© atingir pelo menos $minAcceptable palavras\n'
        '   ‚Ä¢ √â melhor chegar perto de $adjustedTarget do que ficar 15-20% abaixo!\n'
        '\n'
        '‚úÖ FAIXA ACEIT√ÅVEL: $minAcceptable a $maxAcceptable palavras\n'
        '   ‚Ä¢ IDEAL: Entre ${(adjustedTarget * 0.95).round()} e ${(adjustedTarget * 1.05).round()} palavras\n'
        '   ‚Ä¢ ACEIT√ÅVEL: $minAcceptable (m√≠nimo) at√© $maxAcceptable (m√°ximo)\n'
        '   ‚Ä¢ PROIBIDO: Menos de $minAcceptable palavras (ser√° rejeitado!)\n'
        '\n'
        'üìä ESTRAT√âGIA DE CONTAGEM:\n'
        '   1. Escreva naturalmente at√© ~${(adjustedTarget * 0.80).round()} palavras\n'
        '   2. Depois disso, conte periodicamente: "Quantas palavras j√° escrevi?"\n'
        '   3. Se estiver perto de $minAcceptable, CONTINUE at√© pelo menos $adjustedTarget!\n'
        '   4. Se passar de $maxAcceptable, est√° no limite - pode concluir naturalmente\n'
        '   5. NUNCA pare muito antes da meta s√≥ porque "parece completo"\n'
        '\n'
        'üí° LEMBRE-SE: Narrativas longas precisam de desenvolvimento!\n'
        '   ‚Ä¢ Detalhe mais as cenas e emo√ß√µes\n'
        '   ‚Ä¢ Adicione momentos de reflex√£o do narrador\n'
        '   ‚Ä¢ Desenvolva melhor as intera√ß√µes entre personagens\n'
        '   ‚Ä¢ Use descri√ß√µes sensoriais (sons, cheiros, texturas)\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '${isSpanish ? 'üö® ESPA√ëOL - CONTROL ESTRICTO DE EXTENSI√ìN:\n   ‚Ä¢ Tu bloque NO PUEDE superar las $limitedNeeded palabras\n   ‚Ä¢ Si generas m√°s de $limitedNeeded palabras, el bloque ser√° RECHAZADO\n   ‚Ä¢ Cuenta mentalmente mientras escribes y PARA cuando llegues al l√≠mite\n   ‚Ä¢ Es MEJOR terminar con $adjustedTarget palabras que pasarte del l√≠mite\n\n' : ''}'
        'FORMATO: ROTEIRO PARA NARRA√á√ÉO DE V√çDEO - apenas texto corrido para ser lido em voz alta.\n'
        'PROIBIDO: Emojis, s√≠mbolos, formata√ß√£o markdown (incluindo backticks `), t√≠tulos, bullets, calls-to-action, hashtags, elementos visuais.\n'
        'OBRIGAT√ìRIO: Texto limpo, narrativo, fluido, pronto para narra√ß√£o direta. NUNCA use backticks (`) ou qualquer marca√ß√£o ao redor de palavras.\n'
        '\n'
        'üéôÔ∏è OTIMIZA√á√ÉO PARA NARRA√á√ÉO DE YOUTUBE (V√çDEOS LONGOS 1h+):\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üìä ESTRUTURA PARA RETEN√á√ÉO DE AUDI√äNCIA:\n'
        '   ‚Ä¢ Crie momentos de tens√£o a cada 8-12 minutos (mini-cl√≠max)\n'
        '   ‚Ä¢ Varie o ritmo: alterne cenas de a√ß√£o com reflex√£o\n'
        '   ‚Ä¢ Use ganchos sutis antes de mudan√ßas de cena\n'
        '\n'
        'üö® ESTRUTURA DE 3 ATOS - OBRIGAT√ìRIA PARA HIST√ìRIAS COMPLETAS:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è ATEN√á√ÉO CR√çTICA: A hist√≥ria DEVE ter IN√çCIO, MEIO e FIM COMPLETOS!\n'
        '\n'
        'üö® DISTRIBUI√á√ÉO OBRIGAT√ìRIA DO ESPA√áO:\n'
        '   ‚Ä¢ ATO 1 - IN√çCIO (Setup): 25% do roteiro\n'
        '     ‚Üí Apresentar protagonista, conflito, mundo\n'
        '     ‚Üí Estabelecer o que est√° em jogo\n'
        '     ‚Üí Gancho que lan√ßa a hist√≥ria\n'
        '\n'
        '   ‚Ä¢ ATO 2 - MEIO (Desenvolvimento): 40% do roteiro ‚Üê üö® LIMITE M√ÅXIMO: 45%!\n'
        '     ‚Üí Protagonista age e enfrenta obst√°culos\n'
        '     ‚Üí Complica√ß√µes e reviravoltas\n'
        '     ‚Üí Tens√£o crescente at√© o cl√≠max\n'
        '     üõë HARD LIMIT: Se roteiro tem 10.000 palavras, Ato 2 = M√ÅXIMO 4.500 palavras!\n'
        '     üõë Se ultrapassar 45%, voc√™ EST√Å FALHANDO! Corte imediatamente!\n'
        '\n'
        '   ‚Ä¢ ATO 3 - FIM (Resolu√ß√£o): 35% do roteiro ‚Üê üö® N√ÉO NEGOCI√ÅVEL!\n'
        '     ‚Üí Cl√≠max final (confronto decisivo)\n'
        '     ‚Üí Resolu√ß√£o do conflito principal\n'
        '     ‚Üí Protagonista consegue ou perde objetivo\n'
        '     ‚Üí Desfecho emocional satisfat√≥rio\n'
        '     üõë HARD LIMIT: Se roteiro tem 10.000 palavras, Ato 3 = M√çNIMO 3.500 palavras!\n'
        '     üõë Se Ato 3 < 35%, voc√™ REPROVOU! Volte e corte Ato 2!\n'
        '\n'
        'üé¨ ESTRUTURA DETALHADA DO ATO 3 (35% FINAL) - OBRIGAT√ìRIO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è O ATO 3 √© o CL√çMAX e RESOLU√á√ÉO. Deve SEMPRE incluir TODAS as 3 partes:\n'
        '\n'
        'üìç PARTE 1: EXECU√á√ÉO DA VINGAN√áA/REVELA√á√ÉO (15% do roteiro)\n'
        '   ‚úÖ Protagonista USA a "arma" obtida no Ato 2\n'
        '   ‚úÖ Confronto direto OU revela√ß√£o p√∫blica acontece NA TELA\n'
        '   ‚úÖ Antagonistas DESCOBREM a verdade (mostre rea√ß√£o)\n'
        '   ‚úÖ Momento da virada: "tudo vem √† tona"\n'
        '\n'
        'üìç PARTE 2: QUEDA DOS ANTAGONISTAS (10% do roteiro) ‚Üê üö® MOSTRE, N√ÉO RESUMA!\n'
        '   ‚úÖ Consequ√™ncias IMEDIATAS e VIS√çVEIS mostradas EM CENA\n'
        '   ‚úÖ Perda de dinheiro/poder/reputa√ß√£o EXPLICITADA com detalhes\n'
        '   ‚úÖ Rea√ß√£o emocional dos antagonistas (choque, desespero, raiva) MOSTRADA\n'
        '   ‚úÖ Antagonistas em posi√ß√£o FINAL (pris√£o, fal√™ncia, humilha√ß√£o) DETALHADA\n'
        '   ‚ùå PROIBIDO: "Eles perderam tudo" sem MOSTRAR como perderam\n'
        '   ‚ùå PROIBIDO: "Foi um esc√¢ndalo" sem DESCREVER o esc√¢ndalo\n'
        '   ‚ùå PROIBIDO: "Foram presos" sem MOSTRAR a pris√£o acontecendo\n'
        '\n'
        'üìç PARTE 3: RESOLU√á√ÉO DO PROTAGONISTA (10% do roteiro) ‚Üê üö® CENA FINAL!\n'
        '   ‚úÖ Protagonista em posi√ß√£o final clara COM CENA DESCRITIVA\n'
        '   ‚úÖ Reflex√£o sobre jornada completada (n√£o apenas "aprendi X")\n'
        '   ‚úÖ Fechamento emocional satisfat√≥rio MOSTRADO, n√£o narrado\n'
        '   ‚úÖ Mensagem/li√ß√£o final transmitida atrav√©s de A√á√ÉO ou DI√ÅLOGO\n'
        '   ‚ùå PROIBIDO: Terminar com apenas "E assim aprendi que..."\n'
        '   ‚ùå PROIBIDO: Final apenas narrativo sem cena final memor√°vel\n'
        '\n'
        '‚úÖ EXEMPLOS DE FINAIS COMPLETOS (COPIE ESTE PADR√ÉO):\n'
        '   ‚Ä¢ "Fran√ßois foi preso por fraude. A empresa faliu. Quentin assumiu o controle"\n'
        '   ‚Ä¢ "Caroline viu Marc transformado no restaurante. Percebeu seu erro. Ele a recusou"\n'
        '   ‚Ä¢ "Paul foi exposto publicamente. As irm√£s perderam tudo. Adrien ofereceu apenas um bolo"\n'
        '   ‚Ä¢ "√âtienne perdeu ambos os projetos. Caroline o deixou. Marc assumiu a empresa"\n'
        '\n'
        '‚ùå FINAIS PROIBIDOS (NUNCA FA√áA ISSO):\n'
        '   ‚Ä¢ "Quentin tinha a arma em m√£os. Sorriu. A guerra come√ßava" ‚Üê SEM EXECU√á√ÉO\n'
        '   ‚Ä¢ "Marc convidou Caroline ao restaurante. Ela chegou. Ele se revelou" ‚Üê SEM RESOLU√á√ÉO\n'
        '   ‚Ä¢ "A vingan√ßa estava pronta para acontecer" ‚Üê SEM A√á√ÉO\n'
        '   ‚Ä¢ "Descobri a verdade sobre meu irm√£o. Agora posso agir" ‚Üê PAROU NO MEIO\n'
        '   ‚Ä¢ "Le scandale a √©t√© √©norme. Ils ont tout perdu." ‚Üê RESUMO, N√ÉO CENA! ‚ùå\n'
        '   ‚Ä¢ "Eles foram presos. A empresa faliu. Eu venci." ‚Üê OFF-SCREEN! ‚ùå\n'
        '   ‚Ä¢ "Semanas depois, tudo estava resolvido" ‚Üê NARRA√á√ÉO VAZIA! ‚ùå\n'
        '\n'
        'üé¨ ESTRUTURA OBRIGAT√ìRIA DE FINAL PARA YOUTUBE (35% FINAIS):\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üí∞ REGRA DE OURO: Satisfa√ß√£o Emocional = Reten√ß√£o = Monetiza√ß√£o\n'
        '\n'
        'üö® ERRO MORTAL #1: Final resumido\n'
        '   ‚ùå "Eles foram presos. Perderam tudo. Fim." (50 palavras)\n'
        '   ‚úÖ Cena completa de pris√£o + queda + confronto (1.500+ palavras)\n'
        '   \n'
        '   DIFEREN√áA: 50 vs 1.500 palavras = 30x mais satisfa√ß√£o!\n'
        '\n'
        'üìä DISTRIBUI√á√ÉO DOS √öLTIMOS 35%:\n'
        '\n'
        '‚ñ∏ PARTE 1: EXECU√á√ÉO DA VINGAN√áA (15% = 800-1.000 palavras)\n'
        '   \n'
        '   Dividir em 4 beats:\n'
        '   \n'
        '   Beat 1 - Prepara√ß√£o (100 palavras):\n'
        '   "No dia do confronto, vesti meu melhor terno..."\n'
        '   \n'
        '   Beat 2 - Revela√ß√£o (300 palavras):\n'
        '   "Entrei no escrit√≥rio. Coloquei a pasta na mesa.\n'
        '   Ele abriu. Viu as provas. Seu rosto empalideceu..."\n'
        '   \n'
        '   Beat 3 - Confronto Emocional (300 palavras):\n'
        '   "Voc√™ me chamou de fracassado, eu disse.\n'
        '   Mas quem est√° falido agora?\n'
        '   Mostrei a carta que provava sua fraude..."\n'
        '   \n'
        '   Beat 4 - Acionamento (200 palavras):\n'
        '   "Fiz uma liga√ß√£o. Delegado? As provas est√£o prontas.\n'
        '   Seu rosto virou p√¢nico puro..."\n'
        '\n'
        '‚ñ∏ PARTE 2: QUEDA DETALHADA (15% = 800-1.000 palavras)\n'
        '   \n'
        '   üö®üö®üö® OBRIGAT√ìRIO: P√∫blico PRECISA VER cada passo da queda! üö®üö®üö®\n'
        '   ‚ùå PROIBIDO: "Eles foram presos. Fim." (50 palavras)\n'
        '   ‚úÖ OBRIGAT√ìRIO: Escrever OS 5 BEATS abaixo (m√≠nimo 1.000 palavras)\n'
        '   \n'
        '   üé¨ Beat 1 - Chegada da Autoridade (M√çNIMO 150 palavras):\n'
        '   \n'
        '   EXEMPLO OBRIGAT√ìRIO (COPIE ESTA ESTRUTURA):\n'
        '   "Tr√™s minutos depois da minha liga√ß√£o, sirenes.\n'
        '   \n'
        '   Cinco viaturas da pol√≠cia cercaram o pr√©dio.\n'
        '   Oito policiais entraram pela porta principal.\n'
        '   \n'
        '   [VIL√ÉO] olhou pela janela. Seu rosto empalideceu.\n'
        '   \n'
        '   N√£o... isso n√£o pode estar acontecendo, ele sussurrou.\n'
        '   \n'
        '   Mas estava. A justi√ßa tinha chegado."\n'
        '   \n'
        '   ‚úÖ USE: N√∫meros concretos (5 viaturas, 8 policiais)\n'
        '   ‚úÖ USE: Rea√ß√£o do vil√£o (empalideceu, sussurrou)\n'
        '   ‚úÖ USE: M√≠nimo 150 palavras neste beat!\n'
        '   \n'
        '   üé¨ Beat 2 - Momento da Pris√£o (M√çNIMO 200 palavras):\n'
        '   \n'
        '   EXEMPLO OBRIGAT√ìRIO (COPIE ESTA ESTRUTURA):\n'
        '   "O delegado mostrou o mandado.\n'
        '   \n'
        '   [VIL√ÉO], voc√™ est√° preso por fraude, lavagem de dinheiro\n'
        '   e apropria√ß√£o ind√©bita.\n'
        '   \n'
        '   [VIL√ÉO] tentou sorrir, aquele sorriso confiante de sempre.\n'
        '   \n'
        '   H√° um engano. Eu sou [PROFISS√ÉO]. Voc√™s n√£o podem...\n'
        '   \n'
        '   Vire-se. M√£os atr√°s das costas.\n'
        '   \n'
        '   As algemas clicaram.\n'
        '   \n'
        '   O som ecoou pelo escrit√≥rio silencioso.\n'
        '   Todos os funcion√°rios observavam, im√≥veis.\n'
        '   \n'
        '   [VIL√ÉO2] gritou: [VIL√ÉO]! Fa√ßa alguma coisa!\n'
        '   \n'
        '   Mas n√£o havia nada a fazer.\n'
        '   O imp√©rio estava desmoronando."\n'
        '   \n'
        '   ‚úÖ USE: Di√°logo do vil√£o tentando se defender\n'
        '   ‚úÖ USE: Som das algemas\n'
        '   ‚úÖ USE: Rea√ß√£o de testemunhas\n'
        '   ‚úÖ USE: M√≠nimo 200 palavras neste beat!\n'
        '   \n'
        '   üé¨ Beat 3 - Desmoronamento Imediato (M√çNIMO 250 palavras):\n'
        '   \n'
        '   EXEMPLO OBRIGAT√ìRIO (COPIE ESTA ESTRUTURA):\n'
        '   "Enquanto [VIL√ÉO] era levado, seu celular come√ßou a explodir.\n'
        '   \n'
        '   [VIL√ÉO2] pegou o aparelho da mesa.\n'
        '   \n'
        '   47 notifica√ß√µes.\n'
        '   \n'
        '   Ela abriu a primeira: Cancelando o contrato.\n'
        '   A segunda: Retiramos todos os fundos.\n'
        '   A terceira: Nosso escrit√≥rio n√£o pode ser associado a fraude.\n'
        '   \n'
        '   Em 20 minutos, cinco clientes cancelaram.\n'
        '   Em uma hora, dez.\n'
        '   Em duas horas, todos os contratos estavam cancelados.\n'
        '   \n'
        '   O telefone do escrit√≥rio tocava sem parar.\n'
        '   \n'
        '   √â verdade que o Sr. [VIL√ÉO] foi preso?\n'
        '   Nosso dinheiro est√° seguro?\n'
        '   Queremos transferir imediatamente!\n'
        '   \n'
        '   O imp√©rio que eles constru√≠ram com MEU dinheiro\n'
        '   estava desmoronando diante dos olhos dela.\n'
        '   \n'
        '   E tudo que ela podia fazer era assistir."\n'
        '   \n'
        '   ‚úÖ USE: N√∫meros concretos (47 notifica√ß√µes, 5 clientes)\n'
        '   ‚úÖ USE: Timeline (20 min, 1 hora, 2 horas)\n'
        '   ‚úÖ USE: Di√°logos de clientes cancelando\n'
        '   ‚úÖ USE: M√≠nimo 250 palavras neste beat!\n'
        '   \n'
        '   üé¨ Beat 4 - Consequ√™ncias P√∫blicas (M√çNIMO 200 palavras):\n'
        '   \n'
        '   EXEMPLO OBRIGAT√ìRIO (COPIE ESTA ESTRUTURA):\n'
        '   "No dia seguinte, a manchete:\n'
        '   \n'
        '   [PROFISS√ÉO] PROEMINENTE PRESO POR FRAUDE MILION√ÅRIA\n'
        '   \n'
        '   O jornal local. O jornal nacional. A internet.\n'
        '   \n'
        '   O clube de [ESPORTE/LAZER] cancelou o membership de [VIL√ÉO].\n'
        '   N√£o podemos ter criminosos como s√≥cios.\n'
        '   \n'
        '   O restaurante favorito deles ligou:\n'
        '   Sua reserva permanente foi cancelada.\n'
        '   \n'
        '   Amigos pararam de atender.\n'
        '   \n'
        '   [VIL√ÉO2] tentou ir ao [LOCAL SOCIAL] de sempre.\n'
        '   As outras [PESSOAS] viraram as costas.\n'
        '   \n'
        '   Ela saiu correndo, com l√°grimas escorrendo.\n'
        '   \n'
        '   O banco bloqueou as contas.\n'
        '   A casa foi marcada para leil√£o.\n'
        '   Os carros de luxo foram rebocados.\n'
        '   \n'
        '   Em uma semana, eles passaram de elite para p√°rias."\n'
        '   \n'
        '   ‚úÖ USE: Manchete completa\n'
        '   ‚úÖ USE: M√∫ltiplas perdas (clube, restaurante, amigos)\n'
        '   ‚úÖ USE: Cena de humilha√ß√£o p√∫blica\n'
        '   ‚úÖ USE: M√≠nimo 200 palavras neste beat!\n'
        '   \n'
        '   üé¨ Beat 5 - Destino Final (M√çNIMO 200 palavras):\n'
        '   \n'
        '   EXEMPLO OBRIGAT√ìRIO (COPIE ESTA ESTRUTURA):\n'
        '   "Tr√™s meses depois, o julgamento.\n'
        '   \n'
        '   [VIL√ÉO] entrou no tribunal de uniforme laranja.\n'
        '   Ele estava 15 kg mais magro.\n'
        '   O cabelo estava bagun√ßado.\n'
        '   As m√£os tremiam.\n'
        '   \n'
        '   [VIL√ÉO2] n√£o estava na plateia.\n'
        '   Ela n√£o tinha dinheiro para gasolina.\n'
        '   \n'
        '   [X] anos em regime fechado, o juiz declarou.\n'
        '   \n'
        '   Sem express√£o. Sem piedade.\n'
        '   \n'
        '   [VIL√ÉO] olhou para o ch√£o.\n'
        '   \n'
        '   O homem que [CRIME], que destruiu vidas com um sorriso,\n'
        '   agora era apenas o prisioneiro n√∫mero [N√öMERO].\n'
        '   \n'
        '   A mans√£o foi leiloada por 60% do valor.\n'
        '   Os carros foram vendidos em leil√£o.\n'
        '   As roupas de grife foram para brech√≥.\n'
        '   \n'
        '   O nome [VIL√ÉO] virou sin√¥nimo de fraude.\n'
        '   \n'
        '   Esse era o legado dele."\n'
        '   \n'
        '   ‚úÖ USE: Descri√ß√£o f√≠sica da decad√™ncia\n'
        '   ‚úÖ USE: Senten√ßa do juiz\n'
        '   ‚úÖ USE: N√∫mero de prisioneiro\n'
        '   ‚úÖ USE: Lista de perdas materiais\n'
        '   ‚úÖ USE: M√≠nimo 200 palavras neste beat!\n'
        '   \n'
        '   üö® TOTAL DOS 5 BEATS: M√çNIMO 1.000 PALAVRAS!\n'
        '   Se voc√™ escreveu menos que 1.000 palavras = VOC√ä FALHOU!\n'
        '   Volte e EXPANDA cada beat at√© atingir o m√≠nimo!\n'
        '\n'
        '‚ñ∏ PARTE 3: CONFRONTO FINAL (5% = 300 palavras)\n'
        '   \n'
        '   üö® OBRIGAT√ìRIO: Protagonista e vil√£o, cara a cara!\n'
        '   \n'
        '   "Seis meses depois, ele pediu para me ver na pris√£o.\n'
        '   \n'
        '   Entrei. Ele estava destru√≠do.\n'
        '   \n'
        '   Voc√™. Foi tudo voc√™.\n'
        '   \n'
        '   Coloquei uma foto na mesa: minha nova vida.\n'
        '   \n'
        '   Voc√™ riu de mim. Agora eu rio de voc√™.\n'
        '   \n'
        '   Foi a √∫ltima vez que o vi."\n'
        '\n'
        '‚ñ∏ PARTE 4: RESOLU√á√ÉO EMOCIONAL (5% = 300 palavras)\n'
        '   \n'
        '   "Voltei para casa naquele dia.\n'
        '   \n'
        '   Abri minha pr√≥pria empresa. Pequena, mas minha.\n'
        '   \n'
        '   Todos os dias, olhando o p√¥r do sol,\n'
        '   eu entendia a li√ß√£o.\n'
        '   \n'
        '   Eles herdaram tudo e perderam tudo.\n'
        '   Eu perdi tudo e constru√≠ tudo.\n'
        '   \n'
        '   O verdadeiro tesouro nunca foi o dinheiro.\n'
        '   Foi a chance de recome√ßar.\n'
        '   \n'
        '   E pela primeira vez, eu estava em paz."\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üí∞ POR QUE ISSO FUNCIONA (dados reais de canais):\n'
        '\n'
        '‚úÖ Reten√ß√£o m√©dia: 75%+ (vs 40% em finais resumidos)\n'
        '‚úÖ Taxa de conclus√£o: 68%+ (vs 30% em finais off-screen)\n'
        '‚úÖ Coment√°rios: 85%+ mencionam "satisfa√ß√£o"\n'
        '‚úÖ Compartilhamentos: 3x mais\n'
        '\n'
        'üéØ F√ìRMULA: Satisfa√ß√£o = Tempo vendo vil√£o sofrer\n'
        '\n'
        '   Quanto mais detalhes da queda, mais satisfeito o ouvinte fica!\n'
        '   \n'
        '‚ùå PROIBIDO: "Eles foram presos. Fim."\n'
        '‚úÖ OBRIGAT√ìRIO: M√≠nimo 1.500 palavras mostrando queda completa\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö® REGRA DE OURO DO FINAL COMPLETO:\n'
        '   Se o leitor perguntar "E da√≠? O que aconteceu depois?"\n'
        '   ‚Üí O final est√° INCOMPLETO ‚ùå\n'
        '\n'
        '   Se o leitor sentir CATARSE e FECHAMENTO\n'
        '   ‚Üí O final est√° CORRETO ‚úÖ\n'
        '\n'
        'üí° CHECKLIST ANTES DE FINALIZAR (TODOS devem ser SIM):\n'
        '   ‚ñ° Mostrei o protagonista USANDO a arma/informa√ß√£o do Ato 2?\n'
        '   ‚ñ° Mostrei o confronto/revela√ß√£o ACONTECENDO?\n'
        '   ‚ñ° Mostrei os antagonistas DESCOBRINDO e REAGINDO?\n'
        '   ‚ñ° Mostrei as CONSEQU√äNCIAS para os antagonistas?\n'
        '   ‚ñ° Mostrei o protagonista em sua POSI√á√ÉO FINAL?\n'
        '   ‚ñ° A hist√≥ria TEM DESFECHO, n√£o promessa de desfecho?\n'
        '   ‚ñ° N√ÉO h√° frases tipo "foi um esc√¢ndalo" sem MOSTRAR o esc√¢ndalo?\n'
        '   ‚ñ° N√ÉO h√° finais OFF-SCREEN (fora da tela)?\n'
        '\n'
        'üé≠ CONFRONTO PROTAGONISTA vs ANTAGONISTA - OBRIGAT√ìRIO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è CR√çTICO: O protagonista DEVE ter um momento face-a-face com antagonista!\n'
        '\n'
        '‚ùå PROIBIDO: Antagonista cai sem nunca saber quem o destruiu\n'
        '   "Chamei a pol√≠cia. Nunca mais vi meus irm√£os. Fim."\n'
        '   ‚Üí Antagonista nunca reconheceu que protagonista venceu! ‚ùå\n'
        '\n'
        '‚úÖ OBRIGAT√ìRIO: Momento de reconhecimento\n'
        '   "Seis meses depois, visitei Philippe na pris√£o.\n'
        '   Ele me viu e seus olhos se arregalaram.\n'
        '   Voc√™, sussurrou. Voc√™ fez isso.\n'
        '   Sorri. A brouette do pai era mais valiosa que voc√™ imaginava.\n'
        '   Philippe baixou a cabe√ßa. Pela primeira vez, entendeu."\n'
        '   ‚Üí Antagonista SABE que perdeu e protagonista SABE que venceu! ‚úÖ\n'
        '\n'
        'üí° OP√á√ïES DE CONFRONTO:\n'
        '   1. Confronto direto: Protagonista revela tudo pessoalmente\n'
        '   2. Confronto indireto: Antagonista descobre e protagonista observa rea√ß√£o\n'
        '   3. Confronto final: Protagonista visita antagonista ap√≥s queda\n'
        '   4. Confronto telef√¥nico: Liga√ß√£o revelando a verdade\n'
        '\n'
        'üö® REGRA: Escolha UMA dessas op√ß√µes, mas NUNCA termine sem confronto!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üõë ERRO FATAL: TRANSFORMAR VINGAN√áA EM REDEN√á√ÉO\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è CR√çTICO: Se o tema √© "Heran√ßa Injusta", antagonistas DEVEM CAIR!\n'
        '\n'
        '‚ùå ERRO COMUM (N√ÉO FA√áA ISSO):\n'
        '   ‚Ä¢ Ato 2: Antagonistas s√£o cru√©is, zombam do protagonista\n'
        '   ‚Ä¢ Ato 3: Protagonista salva antagonistas, todos ficam amigos\n'
        '   ‚Üí Isso √© MUDAN√áA DE G√äNERO no meio da hist√≥ria! ‚ùå\n'
        '   ‚Üí Audi√™ncia esperava JUSTI√áA, recebeu PERD√ÉO! ‚ùå\n'
        '\n'
        '‚úÖ PADR√ÉO CORRETO PARA TEMAS DE VINGAN√áA/JUSTI√áA:\n'
        '   ‚Ä¢ Antagonistas foram CRU√âIS no in√≠cio?\n'
        '   ‚Üí Eles DEVEM pagar no final!\n'
        '   ‚Ä¢ Protagonista foi HUMILHADO?\n'
        '   ‚Üí Ele DEVE ter vit√≥ria satisfat√≥ria!\n'
        '   ‚Ä¢ Antagonistas ROUBARAM/ENGANARAM?\n'
        '   ‚Üí Eles DEVEM perder tudo!\n'
        '\n'
        '‚ùå PROIBIDO: Finais tipo "descobri que eles n√£o eram maus, apenas\n'
        '   mal-entendidos, e agora somos todos uma fam√≠lia feliz"\n'
        '   ‚Üí Se come√ßou como vingan√ßa, TERMINE como vingan√ßa!\n'
        '\n'
        '‚ùå PROIBIDO: Antagonistas salvos pelo protagonista no Ato 3\n'
        '   "Usei o ouro para salvar a empresa deles. Trabalhamos juntos."\n'
        '   ‚Üí ERRADO! Ouro deve ir para PROTAGONISTA, n√£o para ANTAGONISTAS!\n'
        '\n'
        '‚ùå PROIBIDO: "Todos ganharam no final"\n'
        '   ‚Üí Em temas de vingan√ßa, algu√©m DEVE perder!\n'
        '   ‚Üí Geralmente, quem perde s√£o os ANTAGONISTAS!\n'
        '\n'
        '‚úÖ EXEMPLOS CORRETOS DE PARTE 2 (QUEDA):\n'
        '   ‚Ä¢ "Philippe foi preso. Empresa faliu. Ele perdeu tudo."\n'
        '   ‚Ä¢ "Caroline viu Marc rico. Tentou voltar. Ele a rejeitou."\n'
        '   ‚Ä¢ "Fran√ßois foi exposto. Perdeu cargo. Quentin assumiu."\n'
        '   ‚Üí Antagonistas em posi√ß√£o PIOR que no in√≠cio!\n'
        '\n'
        'üéØ REGRA DE OURO PARA QUEDA:\n'
        '   Se no Ato 1 antagonista tinha: Poder, Dinheiro, Respeito\n'
        '   No final do Ato 3, ele deve ter: Nada, Nada, Nada\n'
        '   OU estar em posi√ß√£o claramente INFERIOR ao protagonista!\n'
        '\n'
        '‚ö†Ô∏è EXCE√á√ÉO: Temas expl√≠citos de "Perd√£o/Reconcilia√ß√£o"\n'
        '   Se o tema DIZ "perd√£o", "segunda chance", "fam√≠lia unida":\n'
        '   ‚Üí A√≠ sim, reden√ß√£o √© permitida\n'
        '   Mas se tema diz "injusti√ßa", "trai√ß√£o", "roubo":\n'
        '   ‚Üí Vingan√ßa/justi√ßa √© OBRIGAT√ìRIA!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üé≠ ANTAGONISTAS PARA NOVELINHA YOUTUBE:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è Novelinha ‚â† Literatura! Vil√£o pode ser MUITO vil√£o!\n'
        '\n'
        '‚úÖ P√∫blico AMA odiar vil√£o! N√£o segure a maldade!\n'
        '\n'
        'F√ìRMULA TESTADA (90% dos v√≠deos com 1M+ views):\n'
        '\n'
        'üìç ATO 1 (0-30%): Vil√£o PURO MALVADO\n'
        '   \n'
        '   ‚Üí Objetivo: Fazer p√∫blico ODIAR!\n'
        '   ‚Üí Sem economizar maldade!\n'
        '   \n'
        '   Exemplo:\n'
        '   "Ela riu quando assinei os pap√©is da fal√™ncia.\n'
        '   Voc√™ sempre foi um perdedor, disse ela.\n'
        '   Beijou meu ex-s√≥cio bem na minha frente.\n'
        '   Agora voc√™ n√£o tem NADA."\n'
        '   \n'
        '   ‚Üí P√∫blico: "Que pessoa HORR√çVEL!" ‚úÖ = Engajamento!\n'
        '\n'
        'üìç ATO 2 (30-65%): Vil√£o em PODER\n'
        '   \n'
        '   ‚Üí Objetivo: Aumentar raiva do p√∫blico!\n'
        '   ‚Üí Mostrar vil√£o ganhando, rindo, humilhando!\n'
        '   \n'
        '   Exemplo:\n'
        '   "Ela postou foto em Dubai: Lua de mel perfeita!\n'
        '   Com MEU dinheiro. Na conta que era MINHA.\n'
        '   2.000 likes. Casal perfeito!\n'
        '   \n'
        '   Eu estava dormindo no carro."\n'
        '   \n'
        '   ‚Üí P√∫blico: "Quando vai ter JUSTI√áA?!" ‚úÖ = Reten√ß√£o!\n'
        '\n'
        'üìç ATO 3 (65-85%): Vil√£o CAINDO + 1 Momento Humano\n'
        '   \n'
        '   ‚Üí Objetivo: Satisfa√ß√£o + Catarse!\n'
        '   ‚Üí Mostrar TUDO indo embora!\n'
        '   ‚Üí No fim, 1 cena de arrependimento (50 palavras)\n'
        '   \n'
        '   Exemplo COMPLETO:\n'
        '   \n'
        '   "Ela estava na cela. Uniforme laranja. Sem maquiagem.\n'
        '   \n'
        '   [800 PALAVRAS DETALHANDO A QUEDA]\n'
        '   \n'
        '   No final da visita, ela murmurou:\n'
        '   \n'
        '   Destru√≠ tudo. Nossa fam√≠lia. Seu neg√≥cio. Minha vida.\n'
        '   Por gan√¢ncia. E agora tenho nada.\n'
        '   \n'
        '   N√£o era desculpa. Era constata√ß√£o. Tarde demais."\n'
        '   \n'
        '   ‚Üí P√∫blico: "Ela mereceu! Mas √© triste ver algu√©m T√ÉO baixo.\n'
        '               Vingan√ßa completa!" ‚úÖ = Satisfa√ß√£o m√°xima!\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üéØ EQUIL√çBRIO PERFEITO:\n'
        '\n'
        '   95% vil√£o puro + 5% momento humano no final = OURO!\n'
        '   \n'
        '   Por qu√™?\n'
        '   ‚Ä¢ P√∫blico precisa ODIAR para sentir satisfa√ß√£o na queda\n'
        '   ‚Ä¢ Mas 1 momento de humanidade = catarse completa\n'
        '   ‚Ä¢ "Ela percebeu o que perdeu" = fechamento emocional\n'
        '\n'
        'üí¨ COMENT√ÅRIOS QUE VOC√ä QUER VER:\n'
        '\n'
        '   ‚úÖ "Chorei quando ela percebeu o que perdeu"\n'
        '   ‚úÖ "Ela mereceu cada segundo!"\n'
        '   ‚úÖ "Justi√ßa foi feita!"\n'
        '   \n'
        '   Os TR√äS juntos = Hist√≥ria PERFEITA para YouTube!\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚ö†Ô∏è ATEN√á√ÉO: Se voc√™ est√° com 45% do espa√ßo usado e ainda n√£o iniciou\n'
        '   a PARTE 1 (Execu√ß√£o do Ato 3), VOC√ä ULTRAPASSOU O LIMITE!\n'
        '   PARE IMEDIATAMENTE o desenvolvimento do Ato 2!\n'
        '   V√° DIRETO para o cl√≠max! Melhor um Ato 2 curto que UM FINAL INEXISTENTE!\n'
        '\n'
        'üö® LEMBRETE FINAL ANTES DE COME√áAR:\n'
        '   Meta total: [X] palavras\n'
        '   Ato 1: 25% = [0,25X] palavras\n'
        '   Ato 2: 40% = [0,40X] palavras ‚Üê M√ÅXIMO 45% = [0,45X]\n'
        '   Ato 3: 35% = [0,35X] palavras ‚Üê M√çNIMO ABSOLUTO!\n'
        '\n'
        '   Se seu Ato 2 ultrapassar [0,45X] palavras,\n'
        '   voc√™ FALHOU na estrutura e ser√° REJEITADO!\n'
        '\n'
        'üìä SISTEMA DE MONITORAMENTO DE PROGRESSO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üö® CRITICAL: VOC√ä DEVE CONTAR PALAVRAS A CADA PAR√ÅGRAFO!\n'
        '\n'
        '‚ö†Ô∏è Durante a escrita, MONITORE constantemente onde voc√™ est√°:\n'
        '\n'
        'üìç CHECKPOINT 25% (fim do Ato 1):\n'
        '   ‚Üí Protagonista J√Å deve estar com conflito estabelecido\n'
        '   ‚Üí Exemplo: 10.000 palavras = checkpoint aos 2.500\n'
        '   ‚Üí Se ainda n√£o, ACELERE a introdu√ß√£o!\n'
        '\n'
        'üìç CHECKPOINT 40% (meio do Ato 2):\n'
        '   ‚Üí Protagonista J√Å deve estar no meio da investiga√ß√£o/prepara√ß√£o\n'
        '   ‚Üí Exemplo: 10.000 palavras = checkpoint aos 4.000\n'
        '   ‚Üí Se ainda n√£o, CORTE detalhes desnecess√°rios!\n'
        '\n'
        'üìç üõë CHECKPOINT 45% (LIMITE ABSOLUTO DO ATO 2) üõë:\n'
        '   ‚Üí Exemplo: 10.000 palavras = PARE AOS 4.500!\n'
        '   ‚Üí Protagonista DEVE ter a "arma" (prova, plano, aliados)\n'
        '   ‚Üí Se ainda n√£o tem, PULE para obten√ß√£o IMEDIATAMENTE!\n'
        '   ‚Üí ‚ö†Ô∏è SE VOC√ä PASSOU DE 45%, VOC√ä FALHOU! PARE AGORA!\n'
        '   ‚Üí üö® DAQUI EM DIANTE: Foque APENAS no Ato 3!\n'
        '   ‚Üí ‚ùå PROIBIDO: Adicionar mais desenvolvimento/complica√ß√µes\n'
        '   ‚Üí ‚úÖ OBRIGAT√ìRIO: Iniciar Parte 1 do Ato 3 (Execu√ß√£o)\n'
        '\n'
        'üìç CHECKPOINT 60% (meio do Ato 3 - Parte 1):\n'
        '   ‚Üí Exemplo: 10.000 palavras = checkpoint aos 6.000\n'
        '   ‚Üí Parte 1 (Execu√ß√£o) J√Å deve estar completa\n'
        '   ‚Üí Confronto/revela√ß√£o J√Å deve ter acontecido\n'
        '   ‚Üí Se ainda est√° no Ato 2, VOC√ä FALHOU!\n'
        '\n'
        'üìç CHECKPOINT 70% (transi√ß√£o Parte 1 ‚Üí Parte 2):\n'
        '   ‚Üí Exemplo: 10.000 palavras = checkpoint aos 7.000\n'
        '   ‚Üí Parte 2 (Queda) deve estar em andamento\n'
        '   ‚Üí Antagonistas J√Å devem estar perdendo poder/dinheiro\n'
        '   ‚Üí Se ainda est√° na Parte 1, ACELERE!\n'
        '\n'
        'üìç CHECKPOINT 80% (transi√ß√£o Parte 2 ‚Üí Parte 3):\n'
        '   ‚Üí Exemplo: 10.000 palavras = checkpoint aos 8.000\n'
        '   ‚Üí Parte 2 (Queda) J√Å deve estar completa\n'
        '   ‚Üí Antagonistas J√Å devem estar na posi√ß√£o final (pris√£o/fal√™ncia)\n'
        '   ‚Üí Iniciar Parte 3 (Resolu√ß√£o do protagonista)\n'
        '\n'
        'üìç CHECKPOINT 90-100% (Parte 3 - Resolu√ß√£o):\n'
        '   ‚Üí Exemplo: 10.000 palavras = √∫ltimas 1.000-2.000 palavras\n'
        '   ‚Üí Cena final memor√°vel\n'
        '   ‚Üí Reflex√£o do protagonista\n'
        '   ‚Üí √öltima frase impactante\n'
        '\n'
        'üéØ AUTOAVALIA√á√ÉO OBRIGAT√ìRIA A CADA 500 PALAVRAS:\n'
        '   Conte suas palavras escritas: [X] palavras\n'
        '   Calcule: [X] √∑ [meta total] = [Y]%\n'
        '   Pergunte: "Estou em [Y]%. Estou no ato certo?"\n'
        '   Se N√ÉO: AJUSTE IMEDIATAMENTE!\n'
        '\n'
        'üö® REGRA DE OURO ANTI-EXPLOS√ÉO DO ATO 2:\n'
        '   "Se voc√™ tem 1.000 palavras para desenvolver X problema,\n'
        '   e est√° pensando em usar 2.000, voc√™ est√° ERRADO!\n'
        '   Corte pela metade ou o final ser√° sacrificado!"\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üé£ GANCHOS DE RETEN√á√ÉO (OBRIGAT√ìRIOS A CADA 8-12 MINUTOS):\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è YouTube = Guerra contra o bot√£o "fechar"!\n'
        '   Sem ganchos = Ouvinte sai = Sem monetiza√ß√£o = Desperd√≠cio!\n'
        '\n'
        'üìä ONDE COLOCAR GANCHOS (f√≥rmula de canais com 10M+ views):\n'
        '\n'
        'üé£ GANCHO 1: Primeiros 30 segundos (0-2%)\n'
        '   \n'
        '   F√ìRMULA: Resultado chocante + Promessa de vingan√ßa\n'
        '   \n'
        '   Template:\n'
        '   "[VIL√ÉO] me [A√á√ÉO TERR√çVEL], me deixando com [PERDA BRUTAL].\n'
        '   \n'
        '   Mas eles n√£o sabiam de uma coisa.\n'
        '   \n'
        '   [SEGREDO/ARMA] que mudaria TUDO.\n'
        '   \n'
        '   Esta √© a hist√≥ria de como eu passei de [BAIXO] para [ALTO],\n'
        '   e eles passaram de [ALTO] para [BAIXO].\n'
        '   \n'
        '   E tudo come√ßou com [OBJETO/MOMENTO MISTERIOSO]..."\n'
        '\n'
        'üé£ GANCHO 2: Fim do Ato 1 (~12% = 8-10 min)\n'
        '   \n'
        '   T√âCNICA: Revela√ß√£o parcial + Nova pergunta\n'
        '   \n'
        '   Template:\n'
        '   "Quando [A√á√ÉO], eu pensei ter encontrado [ITEM/INFO].\n'
        '   \n'
        '   Mas [DETALHE INTRIGANTE]...\n'
        '   \n'
        '   Era [REVELA√á√ÉO PARCIAL].\n'
        '   E isso mudaria TUDO.\n'
        '   \n'
        '   Mas eu ainda n√£o sabia [NOVA PERGUNTA]..."\n'
        '\n'
        'üé£ GANCHO 3: Meio do Ato 2 (~30% = 18-20 min)\n'
        '   \n'
        '   T√âCNICA: Complica√ß√£o inesperada\n'
        '   \n'
        '   Template:\n'
        '   "Eu achava que tinha [SOLU√á√ÉO].\n'
        '   \n'
        '   Mas quando [PESSOA] [A√á√ÉO]...\n'
        '   seu rosto [REA√á√ÉO ESTRANHA].\n'
        '   \n'
        '   [FRASE MISTERIOSA]\n'
        '   \n'
        '   [PERGUNTA QUE COMPLICA TUDO]"\n'
        '\n'
        'üé£ GANCHO 4: Antes do cl√≠max (~50% = 30 min)\n'
        '   \n'
        '   T√âCNICA: Plano revelado + Contagem regressiva\n'
        '   \n'
        '   Template:\n'
        '   "Finalmente, eu tinha [ARMAS/PROVAS].\n'
        '   \n'
        '   [VIL√ïES] n√£o faziam ideia do que estava vindo.\n'
        '   \n'
        '   Em [TEMPO], eles estariam [DESTINO RUIM].\n'
        '   E eu estaria [ESTADO BOM].\n'
        '   \n'
        '   Mas primeiro... eu precisava [A√á√ÉO FINAL]."\n'
        '\n'
        'üé£ GANCHO 5: In√≠cio do cl√≠max (~65% = 39-40 min)\n'
        '   \n'
        '   T√âCNICA: Execu√ß√£o come√ßa\n'
        '   \n'
        '   Template:\n'
        '   "[A√á√ÉO DE ENTRADA NA CENA].\n'
        '   [VIL√ÉO] estava [A√á√ÉO TRANQUILA].\n'
        '   \n'
        '   Quando me viu, [REA√á√ÉO].\n'
        '   \n'
        '   [DI√ÅLOGO HOSTIL]\n'
        '   \n'
        '   [A√á√ÉO COM OBJETO/PROVA].\n'
        '   \n'
        '   palavra √∫nica, eu disse.\n'
        '   \n'
        '   [VIL√ÉO] [A√á√ÉO].\n'
        '   \n'
        '   E [RESULTADO DRAM√ÅTICO]."\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üéØ FRASES M√ÅGICAS (usar frequentemente ao longo da hist√≥ria):\n'
        '\n'
        'Mist√©rio:\n'
        '   ‚Ä¢ "Mas eu ainda n√£o sabia..."\n'
        '   ‚Ä¢ "O que eu estava prestes a descobrir..."\n'
        '   ‚Ä¢ "Naquele momento, eu n√£o imaginava que..."\n'
        '\n'
        'Antecipa√ß√£o:\n'
        '   ‚Ä¢ "Em X horas, tudo mudaria."\n'
        '   ‚Ä¢ "Eles n√£o faziam ideia do que estava vindo."\n'
        '   ‚Ä¢ "O plano estava pronto. Faltava apenas..."\n'
        '\n'
        'Tens√£o:\n'
        '   ‚Ä¢ "E ent√£o, algo inesperado aconteceu."\n'
        '   ‚Ä¢ "Foi quando percebi meu erro."\n'
        '   ‚Ä¢ "Naquele segundo, tudo clicou."\n'
        '\n'
        'Promessa de vingan√ßa:\n'
        '   ‚Ä¢ "E eles pagariam. Cada centavo. Cada humilha√ß√£o."\n'
        '   ‚Ä¢ "Eles riram de mim. Em breve, eu riria deles."\n'
        '   ‚Ä¢ "Justi√ßa estava chegando. Sem piedade."\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üìä M√âTRICA DE SUCESSO:\n'
        '\n'
        '‚úÖ A cada 10 minutos, ouvinte pensa: "E agora? O que vai acontecer?"\n'
        '‚ùå Ouvinte pensa: "T√°, j√° entendi. Vou fechar."\n'
        '\n'
        'üéØ REGRA DE OURO:\n'
        '   Se passou 15 minutos sem gancho ‚Üí ERRO FATAL!\n'
        '   Volte e adicione revela√ß√£o/complica√ß√£o/tens√£o!\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚ùå ERROS PROIBIDOS:\n'
        '   ‚Ä¢ N√ÉO use todo o espa√ßo no desenvolvimento e esque√ßa o final!\n'
        '   ‚Ä¢ N√ÉO pare a hist√≥ria no meio da investiga√ß√£o/busca!\n'
        '   ‚Ä¢ N√ÉO termine com "e ent√£o fui procurar..." sem mostrar o resultado!\n'
        '   ‚Ä¢ N√ÉO deixe o conflito principal sem resolu√ß√£o!\n'
        '   ‚Ä¢ N√ÉO termine apenas com "obtive a arma" - MOSTRE O USO DA ARMA!\n'
        '   ‚Ä¢ N√ÉO termine com "convidei para o restaurante" - MOSTRE O CONFRONTO!\n'
        '\n'
        '‚úÖ CHECKLIST DO FINAL (OBRIGAT√ìRIO):\n'
        '   Antes de terminar o roteiro, CONFIRME:\n'
        '   ‚ñ° Protagonista confrontou o antagonista/problema?\n'
        '   ‚ñ° Conflito principal foi RESOLVIDO (vit√≥ria ou derrota)?\n'
        '   ‚ñ° Protagonista conseguiu ou perdeu o que buscava?\n'
        '   ‚ñ° Hist√≥ria tem DESFECHO EMOCIONAL claro?\n'
        '   ‚ñ° Audi√™ncia sabe "como terminou" a situa√ß√£o?\n'
        '   ‚ñ° Antagonistas tiveram destino FINAL mostrado?\n'
        '   ‚ñ° N√£o h√° perguntas "e depois?" sem resposta?\n'
        '\n'
        'üìä EXEMPLO PR√ÅTICO - Tema "Heran√ßa Injusta com Reviravolta":\n'
        '\n'
        '   ‚ùå ERRADO (sem final):\n'
        '   ‚Ä¢ In√≠cio: Protagonista recebe heran√ßa m√≠nima\n'
        '   ‚Ä¢ Meio: Descobre pista de fortuna oculta\n'
        '   ‚Ä¢ "Final": Vai procurar pessoa que tem a chave... [PARA AQUI]\n'
        '   ‚Üí ‚ùå Audi√™ncia frustrada! "E a√≠? Conseguiu o dinheiro?"\n'
        '\n'
        '   ‚úÖ CORRETO (final completo):\n'
        '   ‚Ä¢ In√≠cio (25%): Protagonista recebe heran√ßa m√≠nima\n'
        '   ‚Ä¢ Meio (40%): Descobre pista, investiga, enfrenta perigos\n'
        '   ‚Ä¢ Fim (35%): Encontra fortuna oculta + DECIS√ÉO FINAL:\n'
        '     ‚Üí Pega dinheiro mas fica preso a sociedade secreta? OU\n'
        '     ‚Üí Rejeita dinheiro e escolhe liberdade? OU\n'
        '     ‚Üí Usa dinheiro para destruir a organiza√ß√£o?\n'
        '   ‚Üí ‚úÖ Audi√™ncia satisfeita: "Uau! Que final!"\n'
        '\n'
        'üéØ REGRA DE OURO:\n'
        '   Se voc√™ est√° em 65% do espa√ßo e ainda n√£o iniciou o CL√çMAX FINAL,\n'
        '   ACELERE a narrativa e V√Å DIRETO para a resolu√ß√£o!\n'
        '   √â melhor um final r√°pido que UM FINAL INEXISTENTE.\n'
        '\n'
        'üí° QUANDO RESERVAR ESPA√áO PARA O FINAL:\n'
        '   ‚Ä¢ Roteiro de 10.000 palavras? Reserve √∫ltimas 3.500 para o final (35%)\n'
        '   ‚Ä¢ Roteiro de 5.000 palavras? Reserve √∫ltimas 1.750 para o final (35%)\n'
        '   ‚Ä¢ Em QUALQUER tamanho: M√≠nimo 35% deve ser RESOLU√á√ÉO\n'
        '\n'
        'üìä TABELA DE LIMITES ABSOLUTOS POR TAMANHO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üõë USE ESTA TABELA COMO REFER√äNCIA OBRIGAT√ìRIA!\n'
        '\n'
        'Roteiro 5.000 palavras:\n'
        '   ‚Ä¢ Ato 1: 1.250 palavras (25%)\n'
        '   ‚Ä¢ Ato 2: 2.000 palavras (40%) ‚Üê M√ÅXIMO: 2.250 (45%)\n'
        '   ‚Ä¢ Ato 3: 1.750 palavras (35%) ‚Üê M√çNIMO ABSOLUTO\n'
        '   üö® Se Ato 2 > 2.250 palavras: VOC√ä FALHOU!\n'
        '\n'
        'Roteiro 8.000 palavras:\n'
        '   ‚Ä¢ Ato 1: 2.000 palavras (25%)\n'
        '   ‚Ä¢ Ato 2: 3.200 palavras (40%) ‚Üê M√ÅXIMO: 3.600 (45%)\n'
        '   ‚Ä¢ Ato 3: 2.800 palavras (35%) ‚Üê M√çNIMO ABSOLUTO\n'
        '   üö® Se Ato 2 > 3.600 palavras: VOC√ä FALHOU!\n'
        '\n'
        'Roteiro 10.000 palavras:\n'
        '   ‚Ä¢ Ato 1: 2.500 palavras (25%)\n'
        '   ‚Ä¢ Ato 2: 4.000 palavras (40%) ‚Üê M√ÅXIMO: 4.500 (45%)\n'
        '   ‚Ä¢ Ato 3: 3.500 palavras (35%) ‚Üê M√çNIMO ABSOLUTO\n'
        '   üö® Se Ato 2 > 4.500 palavras: VOC√ä FALHOU!\n'
        '\n'
        'Roteiro 12.000 palavras:\n'
        '   ‚Ä¢ Ato 1: 3.000 palavras (25%)\n'
        '   ‚Ä¢ Ato 2: 4.800 palavras (40%) ‚Üê M√ÅXIMO: 5.400 (45%)\n'
        '   ‚Ä¢ Ato 3: 4.200 palavras (35%) ‚Üê M√çNIMO ABSOLUTO\n'
        '   üö® Se Ato 2 > 5.400 palavras: VOC√ä FALHOU!\n'
        '\n'
        'üéØ COMO USAR ESTA TABELA:\n'
        '   1. Identifique meta total de palavras do roteiro\n'
        '   2. Calcule limites usando tabela acima\n'
        '   3. A CADA 500 palavras escritas, conte e verifique\n'
        '   4. Se aproximando do limite do Ato 2? PARE!\n'
        '   5. V√° DIRETO para Ato 3, mesmo que pare√ßa abrupto\n'
        '\n'
        '‚ö†Ô∏è MELHOR UM ATO 2 CURTO QUE UM ATO 3 INEXISTENTE!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö® LEMBRE-SE: Hist√≥ria sem final = Hist√≥ria INCOMPLETA\n'
        '   O p√∫blico quer saber COMO TERMINOU, n√£o apenas "o que aconteceu no meio".\n'
        '\n'
        'üìö EXEMPLO REAL: FINAL OFF-SCREEN vs FINAL COMPLETO\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ùå VERS√ÉO ERRADA (OFF-SCREEN - 500 caracteres):\n'
        '   "Chamei o advogado Fran√ßois. Ele descobriu fraudes.\n'
        '   Semanas depois, a pol√≠cia prendeu Philippe e Alain.\n'
        '   O esc√¢ndalo foi enorme. Eles perderam tudo: empresa,\n'
        '   apartamentos, reputa√ß√£o. Foram para a pris√£o.\n'
        '   Eu observei de longe, do meu caf√© com In√®s no Brasil.\n'
        '   O tesouro do meu pai n√£o era o dinheiro, mas a liberdade."\n'
        '   ‚Üí Problema: TUDO aconteceu OFF-SCREEN! ‚ùå\n'
        '   ‚Üí Leitor pergunta: "Como eles reagiram?" "Qual foi o esc√¢ndalo?"\n'
        '\n'
        '‚úÖ VERS√ÉO CORRETA (ON-SCREEN - 3500 caracteres):\n'
        '   [PARTE 2 - QUEDA DETALHADA]\n'
        '   "Na manh√£ de ter√ßa-feira, Philippe assinava um contrato\n'
        '   de 10 milh√µes quando a porta do escrit√≥rio explodiu.\n'
        '   Dez policiais entraram, armas em punho.\n'
        '\n'
        '   Philippe Beaumont, voc√™ est√° preso por fraude fiscal\n'
        '   e desvio de fundos, anunciou o delegado.\n'
        '\n'
        '   O rosto de Philippe empalideceu. Sua caneta caiu no ch√£o.\n'
        '   Os clientes na sala se afastaram como se ele tivesse peste.\n'
        '\n'
        '   Alain, na sala ao lado, tentou fugir pela janela dos fundos.\n'
        '   Dois policiais o interceptaram. Ele foi jogado no ch√£o,\n'
        '   seu terno de tr√™s mil euros rasgando no carpete.\n'
        '\n'
        '   Atrav√©s da divis√≥ria de vidro, os dois irm√£os se olharam.\n'
        '   N√£o havia cumplicidade. Apenas terror e √≥dio puro.\n'
        '\n'
        '   Foi voc√™! gritou Philippe enquanto era algemado.\n'
        '   Voc√™ contratou aquele detetive sem me consultar!\n'
        '\n'
        '   Eu?! Foi SUA ideia perseguir Mathieu! berrou Alain de volta.\n'
        '\n'
        '   As c√¢meras de TV j√° estavam na rua. Helic√≥pteros de not√≠cias\n'
        '   filmavam a cena de cima. A manchete do Jornal Nacional\n'
        '   naquela noite: IMP√âRIO BEAUMONT DESMORONA - Irm√£os acusados\n'
        '   de fraude de 15 milh√µes.\n'
        '\n'
        '   No dia seguinte, todos os 47 clientes da empresa cancelaram\n'
        '   contratos. Funcion√°rios pediram demiss√£o em massa.\n'
        '   Fornecedores bloquearam entregas. Em 72 horas,\n'
        '   a empresa estava falida.\n'
        '\n'
        '   Tr√™s meses depois, o julgamento. Philippe foi condenado\n'
        '   a oito anos. Alain, a seis. Os apartamentos de luxo?\n'
        '   Leiloados para pagar d√≠vidas. Os carros importados?\n'
        '   Vendidos. O nome Beaumont, antes sin√¥nimo de sucesso,\n'
        '   agora era sin√¥nimo de vergonha.\n'
        '\n'
        '   [CONFRONTO OBRIGAT√ìRIO]\n'
        '   Seis meses ap√≥s a condena√ß√£o, recebi uma liga√ß√£o.\n'
        '   Philippe queria me ver na pris√£o.\n'
        '\n'
        '   Entrei na sala de visitas. Ele estava irreconhec√≠vel.\n'
        '   Cabelos grisalhos, olheiras profundas, uniforme laranja\n'
        '   tr√™s tamanhos maior que seu corpo emagrecido.\n'
        '\n'
        '   Ele me encarou por longos segundos antes de falar.\n'
        '\n'
        '   Voc√™, sussurrou com a voz rouca. Foi voc√™.\n'
        '\n'
        '   Coloquei uma foto na mesa entre n√≥s. A velha brouette\n'
        '   rouill√©e do papai, na areia branca de uma praia brasileira.\n'
        '\n'
        '   Philippe entendeu tudo. Seus olhos se encheram de l√°grimas.\n'
        '   N√£o de tristeza. De raiva impotente.\n'
        '\n'
        '   O idiota da fam√≠lia, disse ele com amargura. O √∫nico\n'
        '   que o velho amava de verdade.\n'
        '\n'
        '   Me levantei para sair. Na porta, olhei para tr√°s pela\n'
        '   √∫ltima vez.\n'
        '\n'
        '   Pai escreveu na nota: O tr√©sor n√£o √© o que brilha.\n'
        '   Voc√™s brilhavam. Eu constru√≠. Essa era a diferen√ßa.\n'
        '\n'
        '   [PARTE 3 - RESOLU√á√ÉO COMPLETA]\n'
        '   Voltei ao Brasil naquela mesma noite. In√®s me esperava\n'
        '   no aeroporto, sorrindo, com um buqu√™ de flores tropicais.\n'
        '\n'
        '   Terminou? ela perguntou.\n'
        '\n'
        '   Terminei.\n'
        '\n'
        '   Tr√™s meses depois, abri um pequeno restaurante na praia.\n'
        '   N√£o usei o nome Beaumont. Chamei de La Brouette Rouill√©e.\n'
        '   A Carriola Enferrujada. Uma homenagem.\n'
        '\n'
        '   Todos os dias, servindo mesas, conversando com clientes,\n'
        '   vendo In√®s rir na cozinha, eu entendia a li√ß√£o final\n'
        '   do meu pai.\n'
        '\n'
        '   O tesouro n√£o eram os lingots d\'or. Era a chance de recome√ßar.\n'
        '   Philippe e Alain herdaram milh√µes e perderam tudo.\n'
        '   Eu herdei uma brouette e constru√≠ uma vida.\n'
        '\n'
        '   Algumas heran√ßas v√™m em caixas de ouro.\n'
        '   Outras v√™m em metal enferrujado e uma nota de amor."\n'
        '\n'
        '   ‚Üí ISSO √© final completo! Leitor sente catharsis! ‚úÖ\n'
        '   ‚Üí TODAS as perguntas foram respondidas!\n'
        '   ‚Üí Queda MOSTRADA, confronto PRESENTE, resolu√ß√£o EMOCIONAL!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö® LIMITE DE ESTRUTURA NARRATIVA - CR√çTICO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è M√ÅXIMO DE 8 ATOS/CICLOS NARRATIVOS POR HIST√ìRIA!\n'
        '\n'
        '‚ùå PROIBIDO: Criar hist√≥rias com 10+ ciclos de "problema ‚Üí solu√ß√£o ‚Üí paz ‚Üí novo problema"\n'
        '   ‚Üí Isso torna a narrativa REPETITIVA e CANSATIVA\n'
        '   ‚Üí O p√∫blico perde interesse quando o padr√£o se repete demais\n'
        '   ‚Üí Antagonista que "nunca morre" frustra o ouvinte\n'
        '\n'
        '‚úÖ ESTRUTURA IDEAL: 6-8 atos narrativos\n'
        '   ‚Ä¢ Ato 1: Apresenta√ß√£o e conflito inicial\n'
        '   ‚Ä¢ Atos 2-3: Desenvolvimento e complica√ß√µes\n'
        '   ‚Ä¢ Atos 4-6: Cl√≠max, confrontos e reviravoltas\n'
        '   ‚Ä¢ Atos 7-8: Resolu√ß√£o definitiva e conclus√£o\n'
        '\n'
        'üìä REGRA PR√ÅTICA:\n'
        '   ‚Ä¢ Se voc√™ j√° escreveu 6 ciclos de "ataque-defesa-vit√≥ria"...\n'
        '   ‚Ä¢ √â HORA DE ENCERRAR A HIST√ìRIA de forma DEFINITIVA!\n'
        '   ‚Ä¢ N√ÉO adicione "mais um √∫ltimo ataque" do vil√£o\n'
        '   ‚Ä¢ D√™ um fechamento SATISFAT√ìRIO e CONCLUSIVO\n'
        '\n'
        'üí° LEMBRE-SE: Hist√≥rias longas ‚â† Hist√≥rias repetitivas\n'
        '   ‚Ä¢ Desenvolva PROFUNDIDADE nos atos, n√£o quantidade\n'
        '   ‚Ä¢ Cada ato deve AVAN√áAR a hist√≥ria, n√£o apenas repetir o padr√£o\n'
        '   ‚Ä¢ O final deve ser DEFINITIVO, n√£o "at√© o pr√≥ximo ataque"\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚è±Ô∏è TRANSI√á√ïES TEMPORAIS CLARAS (CR√çTICO PARA √ÅUDIO):\n'
        '   ‚úÖ SEMPRE marque saltos de tempo explicitamente:\n'
        '      "Tr√™s dias depois...", "Na manh√£ seguinte...", "Semanas se passaram..."\n'
        '      "Naquela mesma noite...", "Seis meses depois...", "Ao amanhecer..."\n'
        '   ‚úÖ Use transi√ß√µes de cena: "Enquanto isso...", "Do outro lado da cidade..."\n'
        '   ‚ùå NUNCA pule no tempo sem avisar - ouvintes perdem-se facilmente\n'
        '\n'
        'üìù CONTROLE DE PAR√ÅGRAFOS (FUNDAMENTAL PARA NARRA√á√ÉO):\n'
        '   ‚ö†Ô∏è Par√°grafos muito longos (300+ palavras) cansam o narrador e ouvinte\n'
        '   ‚úÖ Quebre par√°grafos longos em 2-3 menores\n'
        '   ‚úÖ Cada par√°grafo = 1 ideia ou momento (80-150 palavras ideal)\n'
        '   ‚úÖ Deixe "respiros" naturais para pausas do narrador\n'
        '\n'
        'üö® REGRA CR√çTICA DE PAR√ÅGRAFOS - OBRIGAT√ìRIO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è NUNCA escreva par√°grafos com mais de 180 palavras!\n'
        '\n'
        '‚ùå PROIBIDO: Par√°grafos de 250-400 palavras\n'
        '   ‚Üí Causa monotonia na narra√ß√£o (2+ minutos sem pausa)\n'
        '   ‚Üí Ouvinte perde foco e aten√ß√£o\n'
        '   ‚Üí Mata dramaticidade (sem pausas = sem tens√£o)\n'
        '   ‚Üí Prejudica reten√ß√£o do YouTube (algoritmo detecta queda)\n'
        '\n'
        '‚úÖ OBRIGAT√ìRIO: M√°ximo 180 palavras por par√°grafo\n'
        '   ‚Üí Ideal: 80-150 palavras (30-60 segundos de √°udio)\n'
        '   ‚Üí Pausas entre par√°grafos = respiro mental do ouvinte\n'
        '   ‚Üí Pausas = dramaticidade e impacto emocional\n'
        '\n'
        'üìä REGRA PR√ÅTICA DE CONTAGEM:\n'
        '   ‚Ä¢ Contou 150 palavras no par√°grafo? ‚úÖ OK, pode continuar at√© 180\n'
        '   ‚Ä¢ Chegou em 180 palavras? üö® PARE! Quebre em novo par√°grafo!\n'
        '   ‚Ä¢ Passou de 200 palavras? ‚ùå ERRO GRAVE! Volte e quebre em 2!\n'
        '\n'
        'üí° COMO QUEBRAR PAR√ÅGRAFOS LONGOS:\n'
        '\n'
        '   ‚ùå ERRADO (1 par√°grafo de 320 palavras):\n'
        '   "Naquela noite, n√£o consegui dormir. A humilha√ß√£o queimava. [300 palavras seguem...]\n'
        '   Foi quando ouvi Sofia ao telefone dizendo seu plano cruel. [termina par√°grafo]"\n'
        '   ‚Üí IA l√™ por 2min15s sem pausar = monotonia total\n'
        '\n'
        '   ‚úÖ CORRETO (3 par√°grafos de 100-110 palavras cada):\n'
        '   Par√°grafo 1: "Naquela noite, n√£o consegui dormir. A humilha√ß√£o queimava. [100 palavras]"\n'
        '   [PAUSA - 0.8s de sil√™ncio = ouvinte respira]\n'
        '\n'
        '   Par√°grafo 2: "Fui at√© a cozinha. Foi quando ouvi Sofia ao telefone. [100 palavras]"\n'
        '   [PAUSA - 0.8s = aumenta tens√£o]\n'
        '\n'
        '   Par√°grafo 3: "Ela dizia seu plano cruel para me internar. [110 palavras]"\n'
        '   [PAUSA - 1.2s = impacto dram√°tico]\n'
        '   ‚Üí IA l√™ 3 blocos com pausas = dramaticidade e aten√ß√£o mantida\n'
        '\n'
        'üéØ QUANDO QUEBRAR O PAR√ÅGRAFO:\n'
        '   ‚úÖ Ao mudar de momento temporal: "Na manh√£ seguinte..." ‚Üí novo par√°grafo\n'
        '   ‚úÖ Ao mudar de local: "Fui at√© a cozinha..." ‚Üí novo par√°grafo\n'
        '   ‚úÖ Ao mudar de personagem em foco: "Lucas, por sua vez..." ‚Üí novo par√°grafo\n'
        '   ‚úÖ Ao revelar informa√ß√£o importante: "Foi ent√£o que descobri..." ‚Üí novo par√°grafo\n'
        '   ‚úÖ Ao completar 150-180 palavras: "E percebi a verdade." ‚Üí novo par√°grafo\n'
        '\n'
        '‚ö†Ô∏è CHECAGEM ANTES DE FINALIZAR CADA BLOCO:\n'
        '   1. Contei quantas palavras tem cada par√°grafo que escrevi?\n'
        '   2. Algum par√°grafo tem mais de 180 palavras?\n'
        '   3. Se SIM ‚Üí Volte e quebre em 2-3 par√°grafos menores\n'
        '   4. Se N√ÉO ‚Üí Pode prosseguir\n'
        '\n'
        'üö® LEMBRE-SE: Pausas = Dramaticidade + Aten√ß√£o + Algoritmo\n'
        '   Sem pausas = Monotonia + Abandono + YouTube n√£o promove\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üéØ VARIA√á√ÉO DE VOCABUL√ÅRIO (ANTI-REPETI√á√ÉO PARA √ÅUDIO):\n'
        '   ‚ö†Ô∏è Ouvintes notam repeti√ß√µes mais que leitores!\n'
        '   ‚úÖ Varie sin√¥nimos de palavras-chave:\n'
        '      solid√£o ‚Üí isolamento, sil√™ncio, dist√¢ncia\n'
        '      medo ‚Üí receio, pavor, apreens√£o, temor\n'
        '      olhar ‚Üí observar, fitar, contemplar, espiar\n'
        '   ‚úÖ Evite usar a mesma palavra tem√°tica 3+ vezes em 5 par√°grafos\n'
        '   ‚úÖ Use palavras concretas e visuais (ouvinte precisa "ver" mentalmente)\n'
        '\n'
        'üé≠ RITMO E PAUSAS DRAM√ÅTICAS:\n'
        '   ‚Ä¢ Momentos de tens√£o: frases curtas e diretas\n'
        '   ‚Ä¢ Momentos de reflex√£o: frases mais longas e po√©ticas\n'
        '   ‚Ä¢ Deixe espa√ßo para "sil√™ncio" (finais de par√°grafo impactantes)\n'
        '   ‚Ä¢ Evite acumular 3+ frases longas seguidas (cansa a narra√ß√£o)\n'
        '\n'
        'üîä CLAREZA AUDITIVA:\n'
        '   ‚úÖ Evite frases com 3+ v√≠rgulas (dif√≠cil de narrar)\n'
        '   ‚úÖ Prefira voz ativa: "Jo√£o viu" (n√£o "foi visto por Jo√£o")\n'
        '   ‚úÖ Nomes pr√≥prios devem ser f√°ceis de pronunciar e distinguir\n'
        '   ‚ùå Evite constru√ß√µes amb√≠guas que confundem quando ouvidas\n'
        '\n'
        'ÔøΩüìñ ESTILO DE NARRATIVA PARA V√çDEOS LONGOS:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚úÖ PERMITIDO E ENCORAJADO para roteiros longos e envolventes:\n'
        '   ‚Ä¢ Reflex√µes profundas dos personagens sobre suas emo√ß√µes e motiva√ß√µes\n'
        '   ‚Ä¢ Descri√ß√µes detalhadas de ambientes e atmosferas\n'
        '   ‚Ä¢ Mon√≥logos internos que revelam pensamentos complexos\n'
        '   ‚Ä¢ Desenvolvimento gradual de tens√£o ao longo de m√∫ltiplos par√°grafos\n'
        '   ‚Ä¢ Digress√µes narrativas que enriquecem a hist√≥ria\n'
        '   ‚Ä¢ An√°lises psicol√≥gicas dos personagens\n'
        '   ‚Ä¢ Met√°foras e simbolismos elaborados\n'
        '\n'
        'üé≠ DESENVOLVIMENTO DE CENAS:\n'
        '   ‚Ä¢ PODE descrever a mesma cena por v√°rios par√°grafos para criar imers√£o\n'
        '   ‚Ä¢ PODE alternar entre a√ß√£o e reflex√£o para variar o ritmo\n'
        '   ‚Ä¢ PODE usar descri√ß√µes longas para criar atmosfera\n'
        '   ‚Ä¢ DEVE quebrar descri√ß√µes muito longas em par√°grafos menores\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'REGRAS DE CONSIST√äNCIA:\n'
        '- Continue exatamente do ponto onde o CONTEXTO parou; n√£o reinicie a hist√≥ria.\n'
        '- N√£o repita par√°grafos, cenas, di√°logos ou cartas j√° escritos anteriormente.\n'
        '- Desenvolva a narrativa de forma rica e detalhada.\n'
        '- Use tanto A√á√ÉO quanto REFLEX√ÉO para criar uma narrativa completa e envolvente.\n'
        '- üö® CR√çTICO: Continue desenvolvendo o MESMO conflito/tema apresentado no in√≠cio!\n'
        '  N√ÉO abandone o conflito principal para criar uma hist√≥ria totalmente nova!\n'
        '  Todos os blocos devem fazer parte da MESMA hist√≥ria com o MESMO arco narrativo!\n'
        '\n'
        'üö® PRESERVA√á√ÉO DE NOMES - REGRA ABSOLUTA E INEGOCI√ÅVEL:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è OS NOMES DE PERSONAGENS J√Å ESTABELECIDOS NO CONTEXTO ACIMA S√ÉO PERMANENTES!\n'
        '‚ö†Ô∏è VOC√ä N√ÉO PODE MUDAR, ALTERAR, OU SUBSTITUIR ESSES NOMES EM HIP√ìTESE ALGUMA!\n'
        '‚ö†Ô∏è SE VOC√ä CRIAR NOVOS NOMES PARA PERSONAGENS J√Å EXISTENTES, O TEXTO SER√Å REJEITADO!\n'
        '\n'
        '‚úÖ CORRETO: "Daniela pegou o telefone" (se Daniela j√° existe no contexto)\n'
        '‚ùå ERRADO: "Sofia pegou o telefone" (mudou o nome de Daniela para Sofia - PROIBIDO!)\n'
        '‚ùå ERRADO: "A nora pegou o telefone" (usou descri√ß√£o gen√©rica em vez do nome - PROIBIDO!)\n'
        '\n'
        '‚ö†Ô∏è ATEN√á√ÉO ESPECIAL: PERSONAGENS SECUND√ÅRIOS EM BLOCOS DISTANTES:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'Se um personagem secund√°rio (advogado, amigo, vizinho, esposa de algu√©m, etc.)\n'
        'foi mencionado em blocos anteriores com um nome espec√≠fico, voc√™ DEVE usar\n'
        'EXATAMENTE o mesmo nome se esse personagem aparecer novamente, MESMO que\n'
        'seja muitos blocos depois!\n'
        '\n'
        'üìå EXEMPLOS DE ERROS QUE VOC√ä DEVE EVITAR:\n'
        '\n'
        '‚ùå ERRADO: Bloco 5 menciona "S√¥nia, a esposa do vil√£o" e no Bloco 15 voc√™ escreve\n'
        '           "Cl√°udia, a esposa do vil√£o" ‚Äî ISSO √â PROIBIDO! Use "S√¥nia" novamente!\n'
        '\n'
        '‚ùå ERRADO: Bloco 3 apresenta "Dr. Roberto, o m√©dico" e no Bloco 12 voc√™ escreve\n'
        '           "Dr. Carlos atendeu a liga√ß√£o" ‚Äî PROIBIDO! Continue usando "Dr. Roberto"!\n'
        '\n'
        '‚ùå ERRADO: Bloco 7 menciona "Ricardo, o advogado" e no Bloco 17 voc√™ apresenta\n'
        '           "Ricardo, o arquiteto" ‚Äî PROIBIDO! Use OUTRO nome para o arquiteto!\n'
        '\n'
        '‚úÖ CORRETO: Se "S√¥nia" apareceu no Bloco 5, use "S√¥nia" em TODOS os blocos seguintes\n'
        '            onde essa personagem aparecer, mesmo que seja no Bloco 15 ou 18!\n'
        '\n'
        '‚úÖ CORRETO: Se "Ricardo" j√° √© o advogado, o novo namorado deve ter OUTRO nome\n'
        '            (por exemplo: "Fernando, o arquiteto").\n'
        '\n'
        'üîç ANTES DE CRIAR UM NOVO NOME: Releia o contexto acima e verifique se esse\n'
        '   personagem j√° foi mencionado com outro nome. Se sim, USE O NOME ORIGINAL!\n'
        '\n'
        'üö® ATEN√á√ÉO CR√çTICA - MEMBROS DA MESMA FAM√çLIA:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è NUNCA, EM HIP√ìTESE ALGUMA, use o MESMO NOME para dois membros da fam√≠lia!\n'
        '\n'
        '‚ùå PROIBIDO: "M√¥nica" (protagonista) + "minha irm√£, M√¥nica" = IMPOSS√çVEL!\n'
        '‚ùå PROIBIDO: "Carlos" (pai) + "meu filho Carlos" = CONFUSO E ABSURDO!\n'
        '‚ùå PROIBIDO: "Helena" (m√£e) + "minha sogra Helena" = N√ÉO PODE!\n'
        '\n'
        '‚úÖ REGRA: CADA personagem da fam√≠lia precisa de um nome √öNICO e DIFERENTE!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n'
        'üö® NOMES DE PERSONAGENS - REGRA CR√çTICA E OBRIGAT√ìRIA:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'VOC√ä DEVE COPIAR E COLAR os nomes EXATAMENTE da lista "NOMES DISPON√çVEIS" acima.\n'
        '‚ö†Ô∏è ESTA √â UMA REGRA ABSOLUTA - N√ÉO H√Å EXCE√á√ïES!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚úÖ CORRETO - Exemplos de como usar:\n'
        '  ‚Ä¢ "Helena pegou o casaco" (Helena est√° na lista)\n'
        '  ‚Ä¢ "Lucas entrou na sala" (Lucas est√° na lista)\n'
        '  ‚Ä¢ "Sofia olhou para mim" (Sofia est√° na lista)\n'
        '\n'
        '‚ùå PROIBIDO - NUNCA fa√ßa isso:\n'
        '  ‚Ä¢ "Observei o casaco" ‚Üí "Observei" N√ÉO √© nome! Use "Marta observou"\n'
        '  ‚Ä¢ "Quero saber a verdade" ‚Üí "Quero" N√ÉO √© nome! Use "Carlos quer saber"\n'
        '  ‚Ä¢ "Pergunte a ele" ‚Üí "Pergunte" N√ÉO √© verbo! Use "Roberto perguntou"\n'
        '  ‚Ä¢ "Apenas sorriu" ‚Üí "Apenas" N√ÉO √© nome! Use "Ana apenas sorriu"\n'
        '  ‚Ä¢ "Imaginei que era tarde" ‚Üí "Imaginei" √© verbo! Use "Eu imaginei"\n'
        '\n'
        'üö® ERROS REAIS QUE VOC√ä COMETEU ANTES (NUNCA REPITA):\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ùå "L√°grimas" como nome de pessoa ‚Üí √â uma PALAVRA COMUM! Use "Marina" ou "J√∫lia"\n'
        '‚ùå "Justi√ßa" como nome de pessoa ‚Üí √â um SUBSTANTIVO! Use "Beatriz" ou "Fernanda"\n'
        '‚ùå "Vamos" como nome de pessoa ‚Üí √â um VERBO! Use "Rafael" ou "Andr√©"\n'
        '‚ùå "Aconteceu" como nome de pessoa ‚Üí √â um VERBO! Use "Carlos" ou "Miguel"\n'
        '‚ùå "Ponto" como nome de pessoa ‚Üí √â uma PALAVRA! Use "Paulo" ou "Ant√¥nio"\n'
        '‚ùå "Semanas" como nome de pessoa ‚Üí √â uma PALAVRA! Use "Pedro" ou "Jos√©"\n'
        '‚ùå "Todas" como nome de pessoa ‚Üí √â um PRONOME! Use "Manuel" ou "Lu√≠s"\n'
        '‚ùå "Ajuda" e "Consolo" como nomes de irm√£s ‚Üí S√£o SUBSTANTIVOS! Use "Rita e Clara"\n'
        '\n'
        '‚ö†Ô∏è REGRA: Se uma palavra N√ÉO est√° na lista "NOMES DISPON√çVEIS", N√ÉO √â NOME!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üìã PROCESSO OBRIGAT√ìRIO para nomear personagens:\n'
        '1. PAUSE e OLHE para a lista "NOMES DISPON√çVEIS" acima\n'
        '2. IDENTIFIQUE: personagem √© masculino ou feminino? Jovem, maduro ou idoso?\n'
        '3. ESCOLHA um nome da categoria apropriada\n'
        '4. COPIE o nome EXATAMENTE como est√° escrito na lista\n'
        '5. VERIFIQUE: este nome j√° foi usado para OUTRO personagem? Se SIM, escolha outro!\n'
        '\n'
        '‚ö†Ô∏è REGRA CR√çTICA: NUNCA use o mesmo nome para dois personagens diferentes!\n'
        '   ‚ùå ERRADO: "Ricardo, o advogado" (bloco 3) e depois "Ricardo, o namorado" (bloco 17)\n'
        '   ‚úÖ CORRETO: "Ricardo, o advogado" (bloco 3) e depois "Fernando, o namorado" (bloco 17)\n'
        '\n'
        'üö® REGRA ESPECIAL - PERSONAGENS DA MESMA FAM√çLIA:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è ATEN√á√ÉO M√ÅXIMA: Membros da mesma fam√≠lia NUNCA podem ter o mesmo nome!\n'
        '\n'
        '‚ùå ERRADO: "M√¥nica" (protagonista) + "minha irm√£, M√¥nica" = IMPOSS√çVEL!\n'
        '   ‚Üí Se a narradora √© M√¥nica, a irm√£ deve ser "S√≠lvia", "Clara" ou "Maria"\n'
        '\n'
        '‚ùå ERRADO: "Carlos" (pai) + "meu filho Carlos" = CONFUSO!\n'
        '   ‚Üí Se o pai √© Carlos, o filho deve ser "Andr√©", "Pedro" ou "Lucas"\n'
        '\n'
        '‚ùå ERRADO: "Helena" (av√≥) + "minha neta Helena" = N√ÉO FAZ SENTIDO!\n'
        '   ‚Üí Se a av√≥ √© Helena, a neta deve ser "Sofia", "Laura" ou "Julia"\n'
        '\n'
        '‚úÖ REGRA: Em uma mesma hist√≥ria, CADA PERSONAGEM precisa de um nome √öNICO!\n'
        '   Isso vale ESPECIALMENTE para familiares: pais, filhos, irm√£os, tios, av√≥s.\n'
        '\n'
        'üö® ERROS GRAV√çSSIMOS DE DUPLICA√á√ÉO QUE VOC√ä J√Å COMETEU:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ùå "Ricardo" usado para DOIS personagens: cobrador + gangster = PROIBIDO!\n'
        '   ‚Üí Se Ricardo j√° √© o cobrador, o gangster deve ser "Marcos" ou "Fernando"\n'
        '\n'
        '‚ùå "S√©rgio" usado para DOIS personagens: policial + criminoso = ABSURDO!\n'
        '   ‚Üí Se S√©rgio √© o policial gentil, o criminoso deve ser "Carlos" ou "Renato"\n'
        '\n'
        '‚ùå "Roberto" usado para DOIS personagens: taxista + m√©dico = IMPOSS√çVEL!\n'
        '   ‚Üí Se Roberto √© o taxista, o m√©dico deve ser "Dr. Alberto" ou "Dr. Henrique"\n'
        '\n'
        'üî• ERRO NOVO DETECTADO - CONFUS√ÉO DE NOMES ENTRE PERSONAGENS:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ùå Bloco 7: Introduziu "Daniela" como estudante universit√°ria\n'
        '‚ùå Bloco 13: Introduziu "Larissa" como ex-noiva de Theo\n'
        '‚ùå Bloco 14: Chamou a ex-noiva de "Daniela" (ERRADO! √â "Larissa")\n'
        '‚ùå Bloco 18: Reutilizou "Larissa" para uma crian√ßa (J√Å USADO!)\n'
        '\n'
        '‚úÖ SOLU√á√ÉO CORRETA:\n'
        '   ‚Ä¢ Daniela = sempre estudante universit√°ria (nunca mudar!)\n'
        '   ‚Ä¢ Larissa = sempre ex-noiva de Theo (nunca mudar!)\n'
        '   ‚Ä¢ Crian√ßa do bloco 18 = usar "Mariana" ou "Isabela" (nome NOVO!)\n'
        '\n'
        '‚ö†Ô∏è REGRA DE OURO: Cada nome pertence a UM personagem ESPEC√çFICO!\n'
        '   Se voc√™ introduziu "Larissa" como ex-noiva no bloco 13,\n'
        '   ela SEMPRE ser√° a ex-noiva. NUNCA chame outro personagem de "Larissa"!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚úÖ SOLU√á√ÉO GERAL: Antes de dar um nome a um personagem novo, RELEIA o contexto\n'
        '   e verifique se esse nome J√Å FOI USADO. Se sim, escolha OUTRO nome!\n'
        '   E NUNCA confunda qual nome pertence a qual personagem!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö® PROTOCOLO OBRIGAT√ìRIO ANTES DE CRIAR NOVO PERSONAGEM:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è ATEN√á√ÉO CR√çTICA: Antes de introduzir qualquer personagem novo:\n'
        '\n'
        '1Ô∏è‚É£ PAUSE e RELEIA o CONTEXTO ACIMA completamente\n'
        '2Ô∏è‚É£ FA√áA UMA LISTA MENTAL de TODOS os nomes j√° mencionados\n'
        '3Ô∏è‚É£ VERIFIQUE: O nome que voc√™ quer usar J√Å APARECEU?\n'
        '4Ô∏è‚É£ SE SIM ‚Üí Escolha OUTRO nome da lista "NOMES DISPON√çVEIS"\n'
        '5Ô∏è‚É£ SE N√ÉO ‚Üí Pode usar, mas MEMORIZE este novo nome!\n'
        '\n'
        'üî• EXEMPLOS DE ERROS QUE VOC√ä **DEVE EVITAR A TODO CUSTO**:\n'
        '\n'
        '‚ùå ERRO GRAV√çSSIMO #1:\n'
        '   Bloco 3: Introduziu "Marco" como credor que procura Sofia\n'
        '   Bloco 12: Introduziu "Marco" como filho pequeno da vizinha Julia\n'
        '   ‚Üí PROIBIDO! S√£o DOIS personagens diferentes com o MESMO nome!\n'
        '   ‚úÖ CORRETO: Bloco 3 = "Marco" (credor), Bloco 12 = "Pedro" (filho de Julia)\n'
        '\n'
        '‚ùå ERRO GRAV√çSSIMO #2:\n'
        '   Bloco 1: Mencionou "Julia" como bibliotec√°ria que ajudou na pesquisa\n'
        '   Bloco 10: Introduziu "Julia" como nova vizinha com filho pequeno\n'
        '   ‚Üí PROIBIDO! S√£o DUAS Julias diferentes!\n'
        '   ‚úÖ CORRETO: Bloco 1 = "Julia" (bibliotec√°ria), Bloco 10 = "Helena" (vizinha)\n'
        '\n'
        '‚ùå ERRO GRAV√çSSIMO #3:\n'
        '   Bloco 2: Apresentou "Roberto" como homem que procura Sofia por d√≠vida\n'
        '   Bloco 15: Mencionou "Roberto" como marido da vizinha Julia\n'
        '   ‚Üí PROIBIDO! S√£o DOIS Robertos diferentes!\n'
        '   ‚úÖ CORRETO: Bloco 2 = "Roberto" (credor), Bloco 15 = "Daniel" (marido de Julia)\n'
        '\n'
        'üìã REGRA ABSOLUTA DE VERIFICA√á√ÉO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è Antes de escrever qualquer nome de personagem, voc√™ DEVE:\n'
        '\n'
        'üîç BUSCAR no contexto acima: "Este nome J√Å foi usado antes?"\n'
        '   ‚Ä¢ Procure por "Marco" ‚Üí Encontrou? N√£o pode usar de novo!\n'
        '   ‚Ä¢ Procure por "Julia" ‚Üí Encontrou? N√£o pode usar de novo!\n'
        '   ‚Ä¢ Procure por "Roberto" ‚Üí Encontrou? N√£o pode usar de novo!\n'
        '   ‚Ä¢ Procure por QUALQUER nome ‚Üí Se j√° apareceu, est√° BLOQUEADO!\n'
        '\n'
        '‚úÖ SE O NOME J√Å FOI USADO:\n'
        '   ‚Üí Escolha OUTRO nome da lista "NOMES DISPON√çVEIS"\n'
        '   ‚Üí Verifique que o novo nome tamb√©m n√£o foi usado\n'
        '   ‚Üí Continue at√© achar um nome √öNICO\n'
        '\n'
        '‚ùå NUNCA ASSUMA que pode reutilizar um nome!\n'
        '‚ùå NUNCA pense "esse personagem era secund√°rio, posso reusar o nome"!\n'
        '‚ùå NUNCA use o mesmo nome para pap√©is diferentes (m√©dico + taxista = PROIBIDO)!\n'
        '\n'
        'üéØ ESTRAT√âGIA PR√ÅTICA:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'Ao criar personagem novo, MENTALIZE:\n'
        '\n'
        '1. "Qual nome vou usar? Ex: Marco"\n'
        '2. "Marco j√° apareceu no contexto?" ‚Üí PROCURE!\n'
        '3. SE SIM: "Preciso de OUTRO nome. Que tal... Pedro? J√° foi usado? N√ÉO? OK!"\n'
        '4. SE N√ÉO: "√ìtimo! Marco est√° livre. Vou usar Marco."\n'
        '\n'
        '‚ö†Ô∏è ESTA VERIFICA√á√ÉO √â **OBRIGAT√ìRIA** PARA **CADA** PERSONAGEM NOVO!\n'
        '‚ö†Ô∏è PERSONAGENS SECUND√ÅRIOS TAMB√âM CONTAM!\n'
        '\n'
        'üö®üö®üö® ERRO CR√çTICO MAIS COMUM - PRESTE MUITA ATEN√á√ÉO! üö®üö®üö®\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ùå NUNCA use o mesmo nome para PAP√âIS/PROFISS√ïES DIFERENTES!\n'
        '\n'
        'üî¥ EXEMPLO REAL DE ERRO QUE ACONTECEU:\n'
        '   Bloco 2: "Procurei um advogado, um homem chamado S√©rgio..."\n'
        '   Bloco 9: "Um homem chamado S√©rgio veio falar mal do Francisco..."\n'
        '   Bloco 15: "O autor do livro, S√©rgio, havia sido manipulado..."\n'
        '   ‚Üí ERRO GRAV√çSSIMO! TR√äS personagens diferentes com nome "S√©rgio"!\n'
        '\n'
        '‚úÖ EXEMPLO CORRETO:\n'
        '   Bloco 2: "Procurei um advogado, um homem chamado Artur..."\n'
        '   Bloco 9: "Um homem chamado Rog√©rio veio falar mal do Francisco..."\n'
        '   Bloco 15: "O autor do livro, S√©rgio, havia sido manipulado..."\n'
        '   ‚Üí CERTO! Tr√™s profissionais diferentes = tr√™s nomes diferentes!\n'
        '\n'
        'üìã REGRA DE OURO ABSOLUTA:\n'
        '   ‚Ä¢ Um nome = Um personagem = Um papel CONSISTENTE!\n'
        '   ‚Ä¢ Se "Artur" √© advogado ‚Üí ele SEMPRE ser√° advogado\n'
        '   ‚Ä¢ Se "Rog√©rio" √© manipulado ‚Üí ele SEMPRE ser√° aquele homem\n'
        '   ‚Ä¢ Se "S√©rgio" √© autor ‚Üí ele SEMPRE ser√° o autor\n'
        '   ‚Ä¢ NUNCA transforme um personagem em outro!\n'
        '   ‚Ä¢ NUNCA reutilize nomes para pap√©is diferentes!\n'
        '\n'
        'üî• ANTES DE DAR NOME A QUALQUER PERSONAGEM:\n'
        '   1. Leia TODO o contexto anterior\n'
        '   2. Fa√ßa uma lista mental: "Quais nomes j√° usei?"\n'
        '   3. Verifique: "O nome que quero usar est√° na lista?"\n'
        '   4. SE SIM ‚Üí Escolha OUTRO nome (h√° centenas dispon√≠veis!)\n'
        '   5. SE N√ÉO ‚Üí Use e ADICIONE √† sua lista mental\n'
        '\n'
        '‚ö†Ô∏è ESTA √â A REGRA MAIS IMPORTANTE DE TODAS!\n'
        '‚ö†Ô∏è VIOLE-A E A HIST√ìRIA FICAR√Å CONFUSA E REJEITADA!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö® ERRO CR√çTICO ADICIONAL - N√ÉO CONFUNDIR PAP√âIS:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ùå NUNCA use o mesmo nome para PAP√âIS/PROFISS√ïES DIFERENTES!\n'
        '\n'
        '‚ùå EXEMPLO ERRADO:\n'
        '   "Ricardo era o investigador particular que contratei."\n'
        '   [10 par√°grafos depois...]\n'
        '   "Ricardo, meu advogado, apresentou o caso no tribunal."\n'
        '   ‚Üí ERRO! Ricardo √© investigador OU advogado, n√£o os dois!\n'
        '\n'
        '‚úÖ EXEMPLO CORRETO:\n'
        '   "Ricardo era o investigador particular que contratei."\n'
        '   [10 par√°grafos depois...]\n'
        '   "Rog√©rio, meu advogado, apresentou o caso no tribunal."\n'
        '   ‚Üí CERTO! Dois profissionais diferentes = dois nomes diferentes!\n'
        '\n'
        'üìã REGRA: Um nome = Um personagem = Um papel consistente!\n'
        '   ‚Ä¢ Se "Ricardo" √© investigador ‚Üí ele SEMPRE ser√° investigador\n'
        '   ‚Ä¢ Se "Rog√©rio" √© advogado ‚Üí ele SEMPRE ser√° advogado\n'
        '   ‚Ä¢ NUNCA transforme um personagem em outro ou reutilize nomes!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è MESMO PERSONAGENS QUE APARECEM UMA VEZ S√ì BLOQUEIAM O NOME!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö®üö®üö® CHECKLIST OBRIGAT√ìRIO ANTES DE NOMEAR PERSONAGEM üö®üö®üö®\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üî• ANTES DE DAR NOME A **QUALQUER** PERSONAGEM (principal ou secund√°rio):\n'
        '\n'
        '‚úã PARE! N√ÉO ESCREVA O NOME AINDA!\n'
        '\n'
        'üìù SIGA ESTE PROTOCOLO OBRIGAT√ìRIO:\n'
        '\n'
        '1Ô∏è‚É£ PAUSE e RELEIA os √∫ltimos 5-10 par√°grafos que voc√™ escreveu\n'
        '2Ô∏è‚É£ LISTE mentalmente TODOS os nomes j√° usados (principais + secund√°rios)\n'
        '3Ô∏è‚É£ PERGUNTE: "O nome que quero usar (ex: Alberto) J√Å apareceu?"\n'
        '4Ô∏è‚É£ SE SIM ‚Üí ESCOLHA OUTRO NOME IMEDIATAMENTE!\n'
        '5Ô∏è‚É£ SE N√ÉO ‚Üí Pode usar, mas ADICIONE √† sua lista mental\n'
        '\n'
        'üî¥ ERRO REAL QUE VOC√ä COMETEU NO √öLTIMO ROTEIRO:\n'
        '   Bloco 5: "Contratamos um advogado, Alberto, que nos orientou..."\n'
        '   Bloco 9: "Nos encontramos com Alberto. Ele era um s√≥cio de Carlos..."\n'
        '   ‚Üí ERRO GRAV√çSSIMO! DOIS "Albertos" com pap√©is DIFERENTES!\n'
        '   ‚Üí Alberto 1 = Advogado de d√≠vidas\n'
        '   ‚Üí Alberto 2 = S√≥cio empresarial\n'
        '\n'
        '‚úÖ SOLU√á√ÉO CORRETA:\n'
        '   Bloco 5: "Contratamos um advogado, Alberto, que nos orientou..."\n'
        '   Bloco 9: "Nos encontramos com Fernando. Ele era um s√≥cio de Carlos..."\n'
        '   ‚Üí PERFEITO! Dois profissionais diferentes = dois nomes diferentes!\n'
        '\n'
        '‚ö†Ô∏è LEMBRE-SE:\n'
        '   ‚Ä¢ H√° 510+ nomes portugueses dispon√≠veis no banco de dados\n'
        '   ‚Ä¢ N√ÉO h√° desculpa para reutilizar nomes\n'
        '   ‚Ä¢ Cada personagem merece identidade √öNICA\n'
        '   ‚Ä¢ Confus√£o de nomes = Hist√≥ria rejeitada!\n'
        '\n'
        'üéØ DICA PR√ÅTICA:\n'
        '   Quando for criar personagem secund√°rio:\n'
        '   - Pense: "Vou usar Alberto"\n'
        '   - PARE: "Alberto j√° apareceu? DEIXE-ME VERIFICAR..."\n'
        '   - Releia contexto anterior\n'
        '   - Se encontrou "Alberto": "OK, preciso de outro. Que tal Fernando? Marcelo? Gustavo?"\n'
        '   - Se n√£o encontrou: "√ìtimo! Alberto est√° livre!"\n'
        '\n'
        'üö® ESTA VERIFICA√á√ÉO √â OBRIGAT√ìRIA PARA **CADA NOVO PERSONAGEM**!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö® ERRO CR√çTICO DETECTADO - REPETI√á√ÉO LITERAL DE PAR√ÅGRAFOS:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üî• ATEN√á√ÉO M√ÅXIMA: Antes de escrever QUALQUER par√°grafo, verifique:\n'
        '   "Eu J√Å escrevi algo parecido ou igual no contexto anterior?"\n'
        '   Se a resposta for SIM ‚Üí MUDE COMPLETAMENTE as palavras e estrutura!\n'
        '\n'
        '‚ùå NUNCA copie par√°grafos inteiros do contexto anterior!\n'
        '‚ùå NUNCA repita frases ou descri√ß√µes que j√° foram escritas!\n'
        '‚ùå NUNCA use "Os dias/meses/semanas que se seguiram" se j√° usou antes!\n'
        '‚ùå NUNCA repita descri√ß√µes de emo√ß√µes ou a√ß√µes j√° narradas!\n'
        '\n'
        'üìã EXEMPLOS DE REPETI√á√ïES PROIBIDAS:\n'
        '‚ùå ERRADO: Copiar "Depois que Ian se foi, o quarto ficou mergulhado..."\n'
        '           palavra por palavra de um bloco anterior\n'
        '‚úÖ CORRETO: Parafrasear com palavras DIFERENTES:\n'
        '           "Ian havia partido. Agora, apenas o sil√™ncio preenchia..."\n'
        '\n'
        '‚ùå ERRADO: Repetir reflex√µes j√° feitas:\n'
        '           "O carrinho era s√≥lido, real..." (se j√° escreveu isso antes)\n'
        '‚úÖ CORRETO: Avan√ßar a narrativa com NOVOS eventos:\n'
        '           "Guardei o carrinho na gaveta e fui preparar o jantar..."\n'
        '\n'
        '‚ùå ERRADO: Repetir par√°grafos de transi√ß√£o temporal:\n'
        '           "Os meses que se seguiram foram..." ‚Üí J√Å USADO? N√ÉO REPITA!\n'
        '           "Os dias que se seguiram foram..." ‚Üí J√Å USADO? N√ÉO REPITA!\n'
        '           "As semanas que se seguiram..." ‚Üí J√Å USADO? N√ÉO REPITA!\n'
        '           "Pedro mal falava. Ele se movia..." ‚Üí J√Å USADO? N√ÉO REPITA!\n'
        '           QUALQUER par√°grafo que voc√™ J√Å escreveu antes ‚Üí NUNCA COPIE!\n'
        '‚úÖ CORRETO: Use uma nova forma de transi√ß√£o:\n'
        '           "Aquele inverno foi diferente dos anteriores..."\n'
        '           "Um ano depois, a rotina tinha mudado completamente..."\n'
        '           "A primavera trouxe mudan√ßas inesperadas..."\n'
        '\n'
        '‚ö†Ô∏è REGRA ABSOLUTA: Cada bloco deve ter conte√∫do 100% NOVO!\n'
        '   ‚Ä¢ Se j√° descreveu um objeto ‚Üí N√£o descreva novamente\n'
        '   ‚Ä¢ Se j√° fez uma reflex√£o ‚Üí Avance para a pr√≥xima cena\n'
        '   ‚Ä¢ Se j√° narrou um evento ‚Üí Conte o que aconteceu DEPOIS\n'
        '\n'
        '‚úÖ T√âCNICAS PARA EVITAR REPETI√á√ÉO:\n'
        '   1. Ler o contexto e RESUMIR mentalmente o que j√° foi dito\n'
        '   2. Perguntar: "Este par√°grafo avan√ßa a hist√≥ria?"\n'
        '   3. Usar sin√¥nimos e estruturas de frase DIFERENTES\n'
        '   4. Focar em A√á√ÉO e DI√ÅLOGO, n√£o apenas reflex√µes\n'
        '   5. Introduzir novos elementos: personagens, locais, eventos\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚ö†Ô∏è TESTE ANTES DE ESCREVER:\n'
        'Antes de usar qualquer palavra como nome, pergunte:\n'
        '"Esta palavra est√° na lista NOMES DISPON√çVEIS acima?"\n'
        'Se a resposta √© N√ÉO ‚Üí N√ÉO USE como nome!\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n'
        '${_getPerspectiveInstruction(c.perspective, c)}\n\n'
        '‚ö†Ô∏è LINGUAGEM ACESS√çVEL PARA TODAS AS IDADES (OBRIGAT√ìRIO):\n'
        'üéØ P√öBLICO-ALVO: Pessoas de 60+ anos, n√≠vel ensino fundamental\n'
        'Use APENAS vocabul√°rio que seus AV√ìS entendem facilmente!\n'
        '\n'
        'üìå REGRA DE OURO:\n'
        'Se voc√™ n√£o usaria essa palavra conversando com sua AV√ì de 70 anos ‚Üí N√ÉO USE!\n'
        '\n'
        'üö´ PALAVRAS PROIBIDAS (substitua por alternativas simples):\n'
        '- "embargada" ‚Üí "tr√™mula", "falhando"\n'
        '- "cenogr√°fica" ‚Üí "teatral", "fingida"\n'
        '- "fulminante" ‚Üí "fatal", "mortal"\n'
        '- "filantropo" ‚Üí "pessoa que ajuda os outros"\n'
        '- "p√°ria" ‚Üí "rejeitado", "exclu√≠do"\n'
        '- "intima√ß√£o" ‚Üí "aviso", "chamado"\n'
        '- "insinuar" ‚Üí "sugerir", "dar a entender"\n'
        '- "paranoico" ‚Üí "desconfiado", "com medo"\n'
        '- "sibilar" ‚Üí "sussurrar com raiva"\n'
        '- "carnificina" ‚Üí "destrui√ß√£o", "massacre"\n'
        '- "estrid√™ncia" ‚Üí "barulho alto", "grito agudo"\n'
        '- "metodologia" ‚Üí "jeito de fazer", "m√©todo"\n'
        '- "esp√©cime" ‚Üí "exemplo", "caso"\n'
        '- "catalisador" ‚Üí "causa", "motivo"\n'
        '- "tit√£" ‚Üí "gigante", "pessoa poderosa"\n'
        '- "fissura" ‚Üí "rachadura", "brecha"\n'
        '\n'
        '‚úÖ REGRAS DE SIMPLICIDADE (SEMPRE):\n'
        '1. FRASES CURTAS: M√°ximo 20-25 palavras por frase (mais f√°cil de acompanhar)\n'
        '2. VOCABUL√ÅRIO DO DIA A DIA: Palavras de conversa com fam√≠lia, n√£o de livro\n'
        '3. VERBOS SIMPLES: "eu fiz", "ele disse", "n√≥s vimos" (sem complica√ß√£o)\n'
        '4. SEM TERMOS T√âCNICOS: Explique tudo com palavras comuns\n'
        '5. TESTE MENTAL: "Minha av√≥ de 70 anos entenderia facilmente?"\n'
        '6. EVITE: Palavras liter√°rias, filos√≥ficas, po√©ticas demais\n'
        '\n'
        'üìù EXEMPLOS DE SIMPLIFICA√á√ÉO:\n'
        '‚ùå "A confiss√£o foi proferida com uma solenidade que beirava o absurdo"\n'
        '‚úÖ "Ele confessou de um jeito quase rid√≠culo de t√£o s√©rio"\n'
        '\n'
        '‚ùå "Ela sibilou uma resposta embargada pela emo√ß√£o"\n'
        '‚úÖ "Ela sussurrou com raiva, a voz tremendo de emo√ß√£o"\n'
        '\n'
        '‚ùå "Minha metodologia era simples e met√≥dica"\n'
        '‚úÖ "Comecei devagar, do jeito que aprendi no arquivo"\n'
        '\n'
        '‚ùå "A dor foi engolida por uma clareza fria e assustadora"\n'
        '‚úÖ "Doeu muito. Mas logo virou raiva. Uma raiva gelada"\n'
        '\n'
        '‚ùå "√âramos curadores de um museu particular de dor"\n'
        '‚úÖ "N√≥s dois viv√≠amos presos naquela dor, cada um no seu canto"\n'
        '\n'
        '‚ùå "Todo tit√£ tem fissuras em sua armadura"\n'
        '‚úÖ "Todo mundo tem um ponto fraco. Eu s√≥ precisava achar o dele"\n'
        '\n'
        '‚≠ê IMPORTANTE: Desenvolva a narrativa com riqueza de detalhes, di√°logos, descri√ß√µes e desenvolvimento de personagens para atingir EXATAMENTE o n√∫mero de ${c.measureType} solicitado. SEMPRE use frases curtas (m√°ximo 20-25 palavras), palavras simples que seus av√≥s entendem, e linguagem de conversa natural familiar.\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üö® REGRA ESTRUTURAL ABSOLUTA - UMA √öNICA HIST√ìRIA COMPLETA:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚ö†Ô∏è CR√çTICO: Voc√™ deve criar UMA √öNICA HIST√ìRIA com UM CONFLITO CENTRAL\n'
        '   que se desenvolve do IN√çCIO ao FIM.\n'
        '\n'
        '‚ùå PROIBIDO: Criar v√°rias hist√≥rias diferentes dentro do mesmo roteiro!\n'
        '‚ùå PROIBIDO: Resolver um conflito e depois come√ßar OUTRO conflito n√£o relacionado!\n'
        '‚ùå PROIBIDO: Abandonar o conflito principal para criar nova trama!\n'
        '\n'
        'ÔøΩ LIMITE ESTRUTURAL OBRIGAT√ìRIO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üö® M√ÅXIMO: 10-12 ATOS PRINCIPAIS\n'
        '‚ö†Ô∏è Se voc√™ criar mais de 12 atos, a hist√≥ria ficar√° ARRASTADA e CANSATIVA!\n'
        '\n'
        '‚ùå ERRO COMUM:\n'
        '   ‚Ä¢ Resolver conflito ‚Üí "Ressuscitar" inimigo ‚Üí Resolver de novo ‚Üí Repetir\n'
        '   ‚Ä¢ Resultado: 20+ atos, hist√≥ria zumbi que n√£o morre\n'
        '\n'
        '‚úÖ CORRETO:\n'
        '   ‚Ä¢ Introdu√ß√£o do conflito (1-2 atos)\n'
        '   ‚Ä¢ Desenvolvimento/complica√ß√µes (6-8 atos)\n'
        '   ‚Ä¢ Resolu√ß√£o final (1-2 atos)\n'
        '   ‚Ä¢ Total: 8-12 atos = IDEAL!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'ÔøΩüìã ESTRUTURA OBRIGAT√ìRIA DE ARCO NARRATIVO:\n'
        '\n'
        '1Ô∏è‚É£ IN√çCIO (primeiros 20-30% do roteiro):\n'
        '   ‚Ä¢ Apresente o CONFLITO PRINCIPAL (um problema, uma injusti√ßa, um desafio)\n'
        '   ‚Ä¢ Esse conflito deve ser o TEMA CENTRAL de TODA a hist√≥ria\n'
        '   ‚Ä¢ Exemplo: "Minha nora me acusou e exp√¥s publicamente"\n'
        '\n'
        '2Ô∏è‚É£ MEIO (60-70% do roteiro):\n'
        '   ‚Ä¢ DESENVOLVA o conflito principal com complica√ß√µes, tentativas, obst√°culos\n'
        '   ‚Ä¢ Todos os eventos DEVEM estar conectados ao conflito inicial\n'
        '   ‚Ä¢ PODE ter subtramas, mas SEMPRE ligadas ao tema central\n'
        '   ‚Ä¢ Exemplo: "Descobri evid√™ncias, planejei resposta, enfrentei consequ√™ncias"\n'
        '\n'
        '3Ô∏è‚É£ FIM (√∫ltimos 10-20% do roteiro):\n'
        '   ‚Ä¢ RESOLVA o conflito principal de forma CLARA e SATISFAT√ìRIA\n'
        '   ‚Ä¢ Mostre as consequ√™ncias da resolu√ß√£o\n'
        '   ‚Ä¢ D√™ fechamento emocional ao narrador\n'
        '   ‚Ä¢ Exemplo: "A verdade veio √† tona, justi√ßa foi feita, encontrei paz"\n'
        '\n'
        'üö® ERROS GRAV√çSSIMOS QUE VOC√ä DEVE EVITAR:\n'
        '\n'
        '‚ùå ERRO 1: M√∫ltiplos Conflitos Independentes\n'
        '   Hist√≥ria sobre nora ‚Üí RESOLVE em 20 minutos ‚Üí Nova hist√≥ria sobre s√≥cio do marido falecido\n'
        '   ‚Üí S√£o DUAS HIST√ìRIAS! P√∫blico fica confuso e abandona o v√≠deo!\n'
        '\n'
        '‚ùå ERRO 2: Abandonar Conflito Principal\n'
        '   "Minha nora me traiu" (conflito inicial) ‚Üí Resolve r√°pido ‚Üí "Descobri trai√ß√£o do s√≥cio"\n'
        '   ‚Üí Voc√™ ESQUECEU da nora e come√ßou hist√≥ria nova! PROIBIDO!\n'
        '\n'
        '‚ùå ERRO 3: Hist√≥ria Sem Final\n'
        '   Cria conflito ‚Üí Desenvolve ‚Üí Termina no MEIO da a√ß√£o sem resolver\n'
        '   ‚Üí P√∫blico se sente ENGANADO! SEMPRE termine a hist√≥ria!\n'
        '\n'
        '‚ùå ERRO 4: "Ressurrei√ß√µes" do Conflito (NOVO!)\n'
        '   Resolve conflito ‚Üí Inimigo volta ‚Üí Resolve ‚Üí Inimigo volta de novo ‚Üí etc\n'
        '   ‚Üí Hist√≥ria "zumbi" que n√£o termina nunca! M√ÅXIMO 2 reviravoltas!\n'
        '\n'
        '‚úÖ SOLU√á√ÉO: UMA HIST√ìRIA, UM ARCO, UM FINAL\n'
        '\n'
        '   CORRETO - Hist√≥ria sobre NORA (exemplo):\n'
        '   ‚Ä¢ In√≠cio: Nora me acusa publicamente\n'
        '   ‚Ä¢ Meio: Descubro trai√ß√£o dela, plano resposta, executo plano\n'
        '   ‚Ä¢ Fim: Confronto final, verdade revelada, nora sai, filho se cura, encontro paz\n'
        '   ‚Üí TUDO conectado ao conflito inicial da NORA!\n'
        '\n'
        '   ERRADO - Duas hist√≥rias misturadas:\n'
        '   ‚Ä¢ In√≠cio: Nora me acusa (Hist√≥ria A)\n'
        '   ‚Ä¢ Meio Parte 1: Resolvo problema da nora (fim da Hist√≥ria A)\n'
        '   ‚Ä¢ Meio Parte 2: Descobro trai√ß√£o de s√≥cio do marido falecido (Hist√≥ria B)\n'
        '   ‚Ä¢ Fim: Vingan√ßa contra s√≥cio (Hist√≥ria B continua mas n√£o termina)\n'
        '   ‚Üí DUAS HIST√ìRIAS DIFERENTES! P√öBLICO CONFUSO! PROIBIDO!\n'
        '\n'
        'üìä TESTE DE COER√äNCIA (fa√ßa antes de cada bloco):\n'
        '   ‚ùì "Este bloco avan√ßa o CONFLITO PRINCIPAL apresentado no in√≠cio?"\n'
        '   ‚ùì "Todos os personagens/eventos est√£o conectados ao tema inicial?"\n'
        '   ‚ùì "Estou resolvendo o problema inicial ou criando problema NOVO?"\n'
        '   ‚ùì "J√° passei de 10 atos? Se SIM, preciso FINALIZAR logo!"\n'
        '\n'
        '   Se voc√™ est√° criando NOVO problema n√£o relacionado ‚Üí PARE! ERRO!\n'
        '\n'
        'üéØ REGRA DE OURO:\n'
        '   O CONFLITO que voc√™ apresenta nos PRIMEIROS 20% do roteiro\n'
        '   DEVE SER o mesmo conflito que voc√™ RESOLVE nos √öLTIMOS 20%.\n'
        '\n'
        '   Se voc√™ mudou de conflito no meio ‚Üí Voc√™ criou DUAS HIST√ìRIAS ‚Üí FALHOU!\n'
        '\n'
        '‚ö†Ô∏è EXCE√á√ÉO PERMITIDA: Subtramas Conectadas\n'
        '\n'
        '   ‚úÖ CORRETO: Hist√≥ria sobre nora + descobrir que ELA estava trabalhando com rival\n'
        '   ‚Üí Subtrama est√° CONECTADA ao conflito principal (a nora)\n'
        '\n'
        '   ‚ùå ERRADO: Hist√≥ria sobre nora + descobrir que s√≥cio do marido falecido traiu 20 anos atr√°s\n'
        '   ‚Üí S√£o conflitos SEPARADOS, de √©pocas DIFERENTES, sem conex√£o\n'
        '\n'
        'üí° RESUMO PR√ÅTICO:\n'
        '   ‚Ä¢ Um protagonista\n'
        '   ‚Ä¢ Um problema/conflito central\n'
        '   ‚Ä¢ Uma jornada do in√≠cio ao fim (8-12 atos)\n'
        '   ‚Ä¢ Uma resolu√ß√£o clara\n'
        '   ‚Ä¢ Tudo conectado ao MESMO TEMA\n'
        '\n'
        'üö® SE VOC√ä CRIAR DUAS HIST√ìRIAS SEPARADAS, O ROTEIRO SER√Å REJEITADO!\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üé≠ REGRAS PARA TWISTS E REVELA√á√ïES (CR√çTICO PARA YOUTUBE):\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚ö†Ô∏è ATEN√á√ÉO: P√∫blico do YouTube precisa de CLAREZA, n√£o ambiguidade filos√≥fica!\n'
        '\n'
        '‚úÖ SE VOC√ä INCLUIR UM TWIST (revela√ß√£o surpreendente):\n'
        '\n'
        '1Ô∏è‚É£ PREPARE O TERRENO (Foreshadowing):\n'
        '   ‚ùå ERRADO: Revelar do nada no final que "tudo era mentira"\n'
        '   ‚úÖ CORRETO: Plantar 2-3 pistas sutis nos blocos anteriores\n'
        '   \n'
        '   Exemplo de pista sutil:\n'
        '   - "Ele parecia nervoso ultimamente, mas eu ignorei"\n'
        '   - "Encontrei um recibo estranho, mas n√£o dei import√¢ncia"\n'
        '   - "Seus amigos novos me pareciam suspeitos"\n'
        '\n'
        '2Ô∏è‚É£ D√ä POSI√á√ÉO CLARA AO NARRADOR:\n'
        '   ‚ùå ERRADO: "Eu n√£o sei mais o que pensar... talvez ele fosse culpado... ou n√£o..."\n'
        '   ‚úÖ CORRETO: "Agora eu sei a verdade. Ele errou, mas isso n√£o justifica o que fizeram"\n'
        '   \n'
        '   O narrador DEVE ter uma conclus√£o clara, mesmo que dolorosa:\n'
        '   - "Mesmo sabendo disso, minha dor continua v√°lida"\n'
        '   - "A verdade mudou como vejo, mas n√£o mudou meu amor"\n'
        '   - "Ambos eram culpados, cada um √† sua maneira"\n'
        '\n'
        '3Ô∏è‚É£ RESOLU√á√ÉO EMOCIONAL OBRIGAT√ìRIA:\n'
        '   ‚ùå ERRADO: Terminar com "...e eu fiquei pensando nisso" [fim abrupto]\n'
        '   ‚úÖ CORRETO: "Aprendi que a verdade n√£o √© simples, mas encontrei minha paz"\n'
        '   \n'
        '   O espectador PRECISA saber:\n'
        '   - Como o narrador se sente AGORA sobre tudo\n'
        '   - Qual li√ß√£o foi aprendida (mesmo que dolorosa)\n'
        '   - Se h√° paz, aceita√ß√£o, ou continua√ß√£o da luta\n'
        '\n'
        '4Ô∏è‚É£ EVITE CONTRADI√á√ïES COM O IN√çCIO:\n'
        '   ‚ùå ERRADO: \n'
        '   - Blocos 1-6: "Ele era inocente, vou vingar!"\n'
        '   - Bloco 7: "Na verdade ele era culpado e mereceu"\n'
        '   [Espectador se sente ENGANADO]\n'
        '   \n'
        '   ‚úÖ CORRETO:\n'
        '   - Blocos 1-6: "Ele era inocente... ou eu pensava isso"\n'
        '   - Bloco 7: "Descobri que havia mais na hist√≥ria"\n'
        '   [Espectador se sente INTRIGADO, n√£o tra√≠do]\n'
        '\n'
        '5Ô∏è‚É£ TESTE DO "ESPECTADOR SATISFEITO":\n'
        '   Antes de finalizar, pergunte:\n'
        '   - ‚úÖ "O espectador entende CLARAMENTE o que aconteceu?"\n'
        '   - ‚úÖ "O narrador tem uma POSI√á√ÉO DEFINIDA sobre os eventos?"\n'
        '   - ‚úÖ "H√° um FECHAMENTO EMOCIONAL (paz, aceita√ß√£o, ou decis√£o clara)?"\n'
        '   - ‚úÖ "A jornada do in√≠cio ao fim faz SENTIDO COMPLETO?"\n'
        '   \n'
        '   Se QUALQUER resposta for N√ÉO ‚Üí Reescreva o final!\n'
        '\n'
        'üìå REGRA DE OURO PARA YOUTUBE:\n'
        'Complexidade moral √© BEM-VINDA, mas AMBIGUIDADE SEM RESOLU√á√ÉO √© PROIBIDA!\n'
        'O espectador pode aceitar "a verdade era complicada", mas N√ÉO aceita "n√£o sei o que pensar".\n'
        '\n'
        '‚úÖ EXEMPLO BOM de final com twist:\n'
        '"Descobri que meu filho tinha culpa tamb√©m. Isso n√£o apaga minha dor,\n'
        'mas mudou minha raiva. Ele errou, mas n√£o merecia morrer. E ela,\n'
        'mesmo tendo raz√µes, escolheu o pior caminho. Ambos pagaram o pre√ßo\n'
        'de suas escolhas. Eu aprendi que a verdade raramente √© simples,\n'
        'mas isso n√£o significa que devo viver na d√∫vida. Fiz as pazes com\n'
        'a mem√≥ria imperfeita do meu filho. E essa √© a minha paz."\n'
        '\n'
        '‚ùå EXEMPLO RUIM de final amb√≠guo:\n'
        '"Agora n√£o sei mais o que pensar. Talvez ele fosse culpado, talvez n√£o.\n'
        'Talvez ela fosse v√≠tima, talvez n√£o. Fico aqui pensando nisso."\n'
        '[ESPECTADOR FRUSTRANDO - N√ÉO FA√áA ISSO!]\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö®üö®üö® REVIRAVOLTAS DEVEM TER RESOLU√á√ÉO - CR√çTICO! üö®üö®üö®\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚ö†Ô∏è ATEN√á√ÉO M√ÅXIMA: Se o tema/t√≠tulo menciona "REVIRAVOLTA", voc√™ DEVE:\n'
        '\n'
        '1Ô∏è‚É£ IDENTIFICAR A REVIRAVOLTA:\n'
        '   Exemplos de reviravoltas prometidas:\n'
        '   ‚Ä¢ "Heran√ßa Injusta com Reviravolta Milion√°ria" ‚Üí Protagonista DEVE conseguir dinheiro!\n'
        '   ‚Ä¢ "O Pobre Que Virou Bilion√°rio" ‚Üí DEVE mostrar ele rico no final!\n'
        '   ‚Ä¢ "A Trai√ß√£o Que Mudou Tudo" ‚Üí DEVE mostrar o QUE mudou!\n'
        '   ‚Ä¢ "Vingan√ßa Perfeita" ‚Üí DEVE mostrar a vingan√ßa acontecendo!\n'
        '\n'
        '2Ô∏è‚É£ ESTRUTURA OBRIGAT√ìRIA PARA REVIRAVOLTAS:\n'
        '\n'
        '   üìä DISTRIBUI√á√ÉO:\n'
        '   ‚Ä¢ 20-30%: Setup (situa√ß√£o inicial injusta/ruim)\n'
        '   ‚Ä¢ 30-40%: Descoberta/Pista (protagonista descobre oportunidade)\n'
        '   ‚Ä¢ 30-40%: EXECU√á√ÉO DA REVIRAVOLTA (protagonista age e CONSEGUE!)\n'
        '\n'
        '   ‚ùå PROIBIDO:\n'
        '   ‚Ä¢ Usar 80% no setup e descoberta\n'
        '   ‚Ä¢ Terminar na BUSCA sem mostrar o RESULTADO\n'
        '   ‚Ä¢ Parar quando protagonista "est√° prestes a conseguir"\n'
        '\n'
        '3Ô∏è‚É£ EXEMPLOS DETALHADOS:\n'
        '\n'
        '   üìå TEMA: "Heran√ßa Injusta com Reviravolta Milion√°ria"\n'
        '\n'
        '   ‚ùå ESTRUTURA ERRADA (70% setup + 30% busca, 0% resolu√ß√£o):\n'
        '   ‚Ä¢ 0-30%: Protagonista recebe quase nada, irm√£os pegam 75M\n'
        '   ‚Ä¢ 30-60%: Descobre pista de fortuna secreta\n'
        '   ‚Ä¢ 60-90%: Investiga, encontra pistas, enfrenta obst√°culos\n'
        '   ‚Ä¢ 90-100%: Vai procurar pessoa-chave... [PARA AQUI]\n'
        '   ‚Üí ‚ùå AUDI√äNCIA FRUSTRADA: "E a√≠? Conseguiu o dinheiro ou n√£o?!"\n'
        '\n'
        '   ‚úÖ ESTRUTURA CORRETA (30% setup + 30% busca + 40% RESOLU√á√ÉO):\n'
        '   ‚Ä¢ 0-25%: Protagonista recebe quase nada, descobre pista\n'
        '   ‚Ä¢ 25-50%: Investiga rapidamente (comprima isso!)\n'
        '   ‚Ä¢ 50-70%: ENCONTRA a fortuna/conta/chave\n'
        '   ‚Ä¢ 70-90%: DECIS√ÉO: Pegar ou n√£o? Consequ√™ncias?\n'
        '   ‚Ä¢ 90-100%: DESFECHO: Conseguiu? Como est√° AGORA?\n'
        '   ‚Üí ‚úÖ AUDI√äNCIA SATISFEITA: "Uau! Que jornada completa!"\n'
        '\n'
        '   üìå TEMA: "O Mendigo Que Humilhou o Milion√°rio"\n'
        '\n'
        '   ‚ùå ERRADO:\n'
        '   ‚Ä¢ Setup: Mendigo humilhado por milion√°rio\n'
        '   ‚Ä¢ Meio: Descobre segredo do milion√°rio\n'
        '   ‚Ä¢ "Final": Planeja revelar... [PARA SEM MOSTRAR]\n'
        '\n'
        '   ‚úÖ CORRETO:\n'
        '   ‚Ä¢ Setup: Mendigo humilhado\n'
        '   ‚Ä¢ Meio: Descobre segredo (R√ÅPIDO!)\n'
        '   ‚Ä¢ Final: CONFRONTO! Revela segredo, milion√°rio perde tudo, mendigo triunfa\n'
        '\n'
        '4Ô∏è‚É£ REGRAS PR√ÅTICAS:\n'
        '\n'
        '   üéØ QUANDO COMPRIMIR O MEIO:\n'
        '   Se voc√™ est√° em 60% do roteiro e a reviravolta ainda n√£o ACONTECEU:\n'
        '   ‚Üí ACELERE! Corte cenas secund√°rias!\n'
        '   ‚Üí V√° DIRETO para o momento da reviravolta!\n'
        '   ‚Üí Reserve pelo menos 30% para mostrar O RESULTADO!\n'
        '\n'
        '   üí∞ PARA TEMAS DE DINHEIRO/FORTUNA:\n'
        '   O protagonista DEVE:\n'
        '   ‚ñ° Encontrar o dinheiro/heran√ßa/fortuna\n'
        '   ‚ñ° DECIDIR o que fazer (pegar, rejeitar, usar)\n'
        '   ‚ñ° EXECUTAR a decis√£o\n'
        '   ‚ñ° MOSTRAR consequ√™ncia (est√° rico? livre? preso?)\n'
        '\n'
        '   ‚öñÔ∏è PARA TEMAS DE VINGAN√áA/JUSTI√áA:\n'
        '   O protagonista DEVE:\n'
        '   ‚ñ° EXECUTAR a vingan√ßa/justi√ßa (n√£o apenas planejar!)\n'
        '   ‚ñ° Vil√£o sofrer consequ√™ncia vis√≠vel\n'
        '   ‚ñ° Protagonista ver resultado de sua a√ß√£o\n'
        '   ‚ñ° Reflex√£o sobre se valeu a pena\n'
        '\n'
        '   üîÑ PARA TEMAS DE MUDAN√áA DE STATUS:\n'
        '   O protagonista DEVE:\n'
        '   ‚ñ° ALCAN√áAR o novo status (rico, poderoso, famoso)\n'
        '   ‚ñ° Mostrar vida DEPOIS da mudan√ßa\n'
        '   ‚ñ° Consequ√™ncias (boas e ruins)\n'
        '   ‚ñ° Estado emocional final\n'
        '\n'
        '5Ô∏è‚É£ CHECKLIST ANTES DE FINALIZAR:\n'
        '\n'
        '   Se seu tema tem REVIRAVOLTA, confirme:\n'
        '   ‚ñ° A reviravolta ACONTECEU (n√£o apenas foi descoberta)?\n'
        '   ‚ñ° O protagonista AGIU e teve resultado concreto?\n'
        '   ‚ñ° A audi√™ncia sabe COMO TERMINOU a situa√ß√£o?\n'
        '   ‚ñ° H√° pelo menos 30% do roteiro AP√ìS a reviravolta acontecer?\n'
        '\n'
        '   ‚ùå Se qualquer resposta for N√ÉO ‚Üí Voc√™ esqueceu o final!\n'
        '   ‚úÖ Se todas s√£o SIM ‚Üí Parab√©ns, hist√≥ria completa!\n'
        '\n'
        'üí° REGRA DE OURO:\n'
        '   "Reviravolta" n√£o √© apenas DESCOBRIR algo incr√≠vel.\n'
        '   "Reviravolta" √© CONSEGUIR algo incr√≠vel e MOSTRAR o resultado!\n'
        '\n'
        'üö® LEMBRE-SE:\n'
        '   O t√≠tulo promete uma jornada COMPLETA.\n'
        '   "Heran√ßa Injusta com Reviravolta Milion√°ria" = promessa de RESOLU√á√ÉO!\n'
        '   N√ÉO deixe o espectador na d√∫vida de "conseguiu ou n√£o"!\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö® LEMBRETE FINAL ANTES DE COME√áAR A ESCREVER:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚ö†Ô∏è PERGUNTE A SI MESMO AGORA:\n'
        '\n'
        '1Ô∏è‚É£ "Qual √© o CONFLITO PRINCIPAL desta hist√≥ria?"\n'
        '   ‚Üí Deve ser o MESMO conflito do in√≠cio ao fim!\n'
        '\n'
        '2Ô∏è‚É£ "Este bloco est√° avan√ßando ESSE conflito espec√≠fico?"\n'
        '   ‚Üí Se n√£o, voc√™ est√° criando hist√≥ria NOVA (PROIBIDO!)\n'
        '\n'
        '3Ô∏è‚É£ "Estou resolvendo o problema inicial ou criando problema DIFERENTE?"\n'
        '   ‚Üí Subtramas OK se conectadas; Hist√≥rias separadas PROIBIDO!\n'
        '\n'
        '4Ô∏è‚É£ "Ao final do roteiro, esse conflito ter√° RESOLU√á√ÉO CLARA?"\n'
        '   ‚Üí Hist√≥ria sem final = REJEITADO!\n'
        '\n'
        '5Ô∏è‚É£ "Cada par√°grafo tem MENOS de 180 palavras?"\n'
        '   ‚Üí Par√°grafos longos = monotonia = abandono = REJEITADO!\n'
        '   ‚Üí Conte as palavras DURANTE a escrita!\n'
        '   ‚Üí Ao atingir 150-180 palavras ‚Üí QUEBRE EM NOVO PAR√ÅGRAFO!\n'
        '\n'
        '6Ô∏è‚É£ "TODOS os nomes que vou usar j√° foram verificados no contexto?"\n'
        '   ‚Üí ANTES de escrever qualquer nome, procure no CONTEXTO ACIMA!\n'
        '   ‚Üí Se o nome J√Å APARECEU antes = N√ÉO POSSO REUTILIZAR!\n'
        '   ‚Üí Exemplos: Marco (j√° usado?) ‚Üí SIM? Escolha outro = Pedro!\n'
        '   ‚Üí Julia (j√° usada?) ‚Üí SIM? Escolha outra = Helena!\n'
        '   ‚Üí Roberto (j√° usado?) ‚Üí SIM? Escolha outro = Daniel!\n'
        '   ‚Üí CADA PERSONAGEM NOVO = VERIFICA√á√ÉO OBRIGAT√ìRIA!\n'
        '\n'
        '‚úÖ SE TODAS AS RESPOSTAS EST√ÉO CERTAS ‚Üí PROSSIGA COM A ESCRITA!\n'
        '‚ùå SE QUALQUER RESPOSTA EST√Å ERRADA ‚Üí REVISE SEU PLANO!\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üé¨ INSTRU√á√ïES ESPECIAIS PARA NARRATIVA DE YOUTUBE (1H+):\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        '‚ö†Ô∏è IMPORTANTE: Este roteiro ser√° narrado por IA em v√≠deo longo (1h+).\n'
        '   Ajuste o estilo para M√ÅXIMA RETEN√á√ÉO e ENVOLVIMENTO!\n'
        '\n'
        '‚úÖ OBRIGAT√ìRIO - ADICIONE MAIS ELEMENTOS:\n'
        '\n'
        '1Ô∏è‚É£ DI√ÅLOGOS DIRETOS (aumentar em 30%):\n'
        '   ‚ùå EVITE: "Ele disse que estava cansado"\n'
        '   ‚úÖ USE: "Estou exausto", ele disse, passando a m√£o no rosto.\n'
        '\n'
        '   Di√°logos tornam a narra√ß√£o VIVA e DRAM√ÅTICA!\n'
        '   ‚Ä¢ M√≠nimo: 3-5 di√°logos por grande cena\n'
        '   ‚Ä¢ Use aspas ("") para fala direta\n'
        '   ‚Ä¢ Adicione a√ß√µes durante a fala: gesticulou, suspirou, gritou\n'
        '\n'
        '2Ô∏è‚É£ MOTIVA√á√ïES CLARAS DE PERSONAGENS:\n'
        '   ‚ùå EVITE: "Luz traiu Matheus" (sem explica√ß√£o)\n'
        '   ‚úÖ USE: "Luz traiu Matheus porque C√©sar ofereceu pagar seu aluguel\n'
        '            atrasado e amea√ßou denunci√°-la √† assist√™ncia social se\n'
        '            ela recusasse. Era uma m√£e desesperada, n√£o uma vil√£."\n'
        '\n'
        '   TODA a√ß√£o importante PRECISA de motiva√ß√£o!\n'
        '   Personagens secund√°rios tamb√©m t√™m raz√µes!\n'
        '\n'
        '3Ô∏è‚É£ CLOSURE DE PERSONAGENS SECUND√ÅRIOS:\n'
        '   ‚ùå EVITE: Personagens desaparecerem sem explica√ß√£o\n'
        '   ‚úÖ USE: "Ricardo foi condenado a 5 anos. Cristiane testemunhou\n'
        '            no julgamento e depois voltou para sua cidade natal,\n'
        '            finalmente em paz ap√≥s anos de sil√™ncio."\n'
        '\n'
        '   CADA personagem importante merece um destino claro!\n'
        '   ‚Ä¢ Antagonistas: O que aconteceu? (pris√£o, ex√≠lio, reden√ß√£o)\n'
        '   ‚Ä¢ Aliados: Como ajudaram no final? Onde est√£o agora?\n'
        '   ‚Ä¢ V√≠timas: Conseguiram justi√ßa/paz?\n'
        '\n'
        '4Ô∏è‚É£ DESCRI√á√ïES SENSORIAIS (visual, auditivo, t√°til):\n'
        '   ‚ùå EVITE: "Ele estava nervoso"\n'
        '   ‚úÖ USE: "Suas m√£os tremiam. O suor escorria pela testa. Sua voz\n'
        '            falhava a cada palavra."\n'
        '\n'
        '   Narra√ß√£o de IA precisa de IMAGENS MENTAIS para o ouvinte!\n'
        '   ‚Ä¢ Descreva ambientes (cheiros, sons, temperaturas)\n'
        '   ‚Ä¢ Mostre emo√ß√µes atrav√©s de A√á√ïES f√≠sicas\n'
        '   ‚Ä¢ Crie atmosfera (sil√™ncio tenso, multid√£o barulhenta)\n'
        '\n'
        '5Ô∏è‚É£ PAUSAS DRAM√ÅTICAS E RITMO:\n'
        '   ‚úÖ VARIE O RITMO:\n'
        '   ‚Ä¢ Momentos tensos: Frases curtas. Staccato. Impacto.\n'
        '   ‚Ä¢ Reflex√µes: Frases mais longas, fluindo como pensamento.\n'
        '   ‚Ä¢ A√ß√£o: Verbos fortes. Movimento. Urg√™ncia.\n'
        '\n'
        '   ‚úÖ USE QUEBRAS ESTRAT√âGICAS:\n'
        '   "Abri a porta. E l√° estava ele. O homem que destruiu minha vida."\n'
        '   [Quebra = pausa dram√°tica na narra√ß√£o = tens√£o!]\n'
        '\n'
        '6Ô∏è‚É£ CONFLITO INTERNO E EXTERNO:\n'
        '   ‚úÖ MOSTRE O DILEMA:\n'
        '   "Parte de mim queria vingan√ßa. Outra parte s√≥ queria paz.\n'
        '    Eu estava dividida entre destru√≠-lo ou simplesmente seguir em frente."\n'
        '\n'
        '   Conflito interno = profundidade = audi√™ncia conectada!\n'
        '\n'
        'üéØ F√ìRMULA DE OURO PARA YOUTUBE:\n'
        '   Di√°logo (30%) + A√ß√£o (40%) + Reflex√£o (20%) + Descri√ß√£o (10%)\n'
        '\n'
        'üö´ NUNCA:\n'
        '   ‚Ä¢ Deixar personagem sem destino final\n'
        '   ‚Ä¢ Trair sem motivo claro\n'
        '   ‚Ä¢ Narrar sem mostrar (tell vs show)\n'
        '   ‚Ä¢ Esquecer de adicionar di√°logos\n'
        '\n'
        '‚úÖ SEMPRE:\n'
        '   ‚Ä¢ Dar closure a TODOS os personagens importantes\n'
        '   ‚Ä¢ Explicar motiva√ß√µes (especialmente trai√ß√µes/conflitos)\n'
        '   ‚Ä¢ Usar di√°logos para dramatizar\n'
        '   ‚Ä¢ Variar ritmo narrativo\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö®üö®üö® PROIBIDO - FINAIS "DEUS EX MACHINA" üö®üö®üö®\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '‚ö†Ô∏è ERRO CR√çTICO QUE VOC√ä COMETE FREQUENTEMENTE:\n'
        '\n'
        '‚ùå PROIBIDO - PROTAGONISTA PERDE O PROTAGONISMO NO FINAL:\n'
        '\n'
        'üî¥ EXEMPLO ERRADO (O QUE VOC√ä FEZ NO √öLTIMO ROTEIRO):\n'
        '   ‚Ä¢ Blocos 1-12: Marta luta, investiga, contrata advogado, coleta provas\n'
        '   ‚Ä¢ Bloco 13: Descobre que marido devia para criminosos\n'
        '   ‚Ä¢ Bloco 14: "O investigador ligou. Eles desapareceram. Problema resolvido."\n'
        '   ‚Üí ERRO GRAV√çSSIMO! Marta virou ESPECTADORA do pr√≥prio final!\n'
        '   ‚Üí Criminosos resolveram o problema DELA sem ela fazer NADA!\n'
        '   ‚Üí A protagonista perdeu o controle da pr√≥pria hist√≥ria!\n'
        '\n'
        '‚ùå OUTROS EXEMPLOS DE FINAIS PROIBIDOS:\n'
        '   ‚Ä¢ "A pol√≠cia prendeu todos e eu finalmente tive paz" (pol√≠cia resolve)\n'
        '   ‚Ä¢ "Ele sofreu um acidente e morreu, justi√ßa foi feita" (acaso resolve)\n'
        '   ‚Ä¢ "Um familiar rico apareceu e pagou todas as d√≠vidas" (salvador externo)\n'
        '   ‚Ä¢ "Ele foi transferido para longe e nunca mais o vi" (problema some)\n'
        '   ‚Ä¢ "Ela adoeceu gravemente e teve que desistir de tudo" (doen√ßa resolve)\n'
        '\n'
        '‚úÖ REGRA ABSOLUTA - PROTAGONISTA DEVE AGIR AT√â O FIM:\n'
        '\n'
        'üéØ O QUE VOC√ä DEVE FAZER NO LUGAR:\n'
        '\n'
        '1Ô∏è‚É£ PROTAGONISTA CONFRONTA DIRETAMENTE:\n'
        '   ‚úÖ "Marta reuniu todas as provas e foi at√© a delegacia PESSOALMENTE.\n'
        '       Ela testemunhou no tribunal. Olhou nos olhos de Ademir enquanto\n'
        '       o juiz lia a senten√ßa de 8 anos de pris√£o por fraude."\n'
        '   ‚Üí Marta age, Marta decide, Marta v√™ o resultado!\n'
        '\n'
        '2Ô∏è‚É£ PROTAGONISTA FAZ ESCOLHAS MORAIS DIF√çCEIS:\n'
        '   ‚úÖ "Os criminosos ofereceram fazer o trabalho sujo por ela.\n'
        '       Marta hesitou. Seria f√°cil deix√°-los resolver. Mas ela\n'
        '       escolheu a lei. Entregou Ademir √† pol√≠cia, n√£o aos mafiosos.\n'
        '       Foi mais dif√≠cil, mas era o certo."\n'
        '   ‚Üí Protagonista enfrenta dilema e DECIDE!\n'
        '\n'
        '3Ô∏è‚É£ PROTAGONISTA NEGOCIA/MANIPULA O RESULTADO:\n'
        '   ‚úÖ "Marta descobriu que La√©rcio queria o dinheiro, n√£o vingan√ßa.\n'
        '       Ela negociou: entregaria Ademir E as contas offshore dele.\n'
        '       Em troca, La√©rcio deixaria ela em paz. Foi um pacto sombrio,\n'
        '       mas ELA controlou o desfecho."\n'
        '   ‚Üí Protagonista age como estrategista!\n'
        '\n'
        '4Ô∏è‚É£ PROTAGONISTA EXECUTA O PLANO FINAL:\n'
        '   ‚úÖ "Marta armou uma cilada. Marcou encontro com Ademir, gravou\n'
        '       confiss√£o dele, e ent√£o a pol√≠cia invadiu. Ela orquestrou\n'
        '       cada passo. A pris√£o foi SUA vit√≥ria."\n'
        '   ‚Üí Protagonista como mestre de xadrez!\n'
        '\n'
        'üö´ NUNCA FA√áA ISSO:\n'
        '   ‚ùå "Um acidente resolveu o problema"\n'
        '   ‚ùå "A pol√≠cia descobriu sozinha e prendeu"\n'
        '   ‚ùå "Terceiros fizeram justi√ßa por ela"\n'
        '   ‚ùå "O vil√£o simplesmente sumiu/morreu"\n'
        '   ‚ùå "Algu√©m externo salvou o dia"\n'
        '   ‚ùå "O investigador/advogado resolveu tudo sozinho"\n'
        '\n'
        '‚úÖ SEMPRE FA√áA ISSO:\n'
        '   ‚úÖ Protagonista toma a DECIS√ÉO final\n'
        '   ‚úÖ Protagonista EXECUTA o confronto\n'
        '   ‚úÖ Protagonista est√° PRESENTE na resolu√ß√£o\n'
        '   ‚úÖ Protagonista faz ESCOLHAS morais dif√≠ceis\n'
        '   ‚úÖ Vit√≥ria √© resultado da A√á√ÉO dela, n√£o do acaso\n'
        '\n'
        'üí° TESTE DO PROTAGONISMO:\n'
        '   Pergunte-se ao escrever o final:\n'
        '   ‚Ä¢ "A protagonista est√° AGINDO ou apenas ASSISTINDO?"\n'
        '   ‚Ä¢ "Se eu tirar ela da cena final, a hist√≥ria muda?"\n'
        '   ‚Ä¢ "Ela fez ESCOLHAS ou apenas recebeu NOT√çCIAS?"\n'
        '\n'
        '   Se ela s√≥ assiste/recebe not√≠cias ‚Üí REESCREVA O FINAL!\n'
        '\n'
        'üéØ F√ìRMULA DO FINAL PERFEITO:\n'
        '   1. Protagonista toma DECIS√ÉO dif√≠cil (escolha moral)\n'
        '   2. Protagonista EXECUTA o plano (a√ß√£o direta)\n'
        '   3. Protagonista CONFRONTA o antagonista (cara a cara quando poss√≠vel)\n'
        '   4. Protagonista V√ä o resultado (presente na vit√≥ria)\n'
        '   5. Protagonista REFLETE sobre a jornada (closure emocional)\n'
        '\n'
        'üî• LEMBRE-SE:\n'
        '   A hist√≥ria √© da PROTAGONISTA, n√£o dos coadjuvantes!\n'
        '   O ouvinte est√° acompanhando a JORNADA DELA!\n'
        '   Se terceiros resolvem = o ouvinte se sente ROUBADO!\n'
        '\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üö® CR√çTICO - CONCLUS√ÉO DO ROTEIRO COMPLETO:\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        'üìä PROGRESSO DA GERA√á√ÉO:\n'
        '   ‚Ä¢ Total de blocos planejados: $totalBlocks blocos\n'
        '   ‚Ä¢ Bloco atual: bloco n√∫mero $blockNumber de $totalBlocks\n'
        '   ${blockNumber < totalBlocks ? '‚Ä¢ Status: CONTINUA√á√ÉO - Este N√ÉO √© o √∫ltimo bloco!' : '‚Ä¢ Status: BLOCO FINAL - Conclua a hist√≥ria agora!'}\n'
        '\n'
        '${blockNumber < totalBlocks ? '‚ùå PROIBIDO NESTE BLOCO:\n   ‚Ä¢ N√ÉO finalize a hist√≥ria ainda!\n   ‚Ä¢ N√ÉO escreva "THE END" ou equivalente\n   ‚Ä¢ N√ÉO crie uma resolu√ß√£o completa e definitiva\n   ‚Ä¢ N√ÉO conclua todos os arcos narrativos\n   \n‚úÖ OBRIGAT√ìRIO NESTE BLOCO:\n   ‚Ä¢ CONTINUE desenvolvendo a trama\n   ‚Ä¢ Mantenha tens√£o e progress√£o narrativa\n   ‚Ä¢ Deixe ganchos para os pr√≥ximos blocos\n   ‚Ä¢ A hist√≥ria DEVE ter continua√ß√£o nos blocos seguintes\n   ‚Ä¢ Apenas desenvolva, N√ÉO conclua!\n' : '‚úÖ OBRIGAT√ìRIO NESTE BLOCO FINAL:\n   ‚Ä¢ AGORA SIM finalize completamente a hist√≥ria\n   ‚Ä¢ Resolva TODOS os conflitos pendentes\n   ‚Ä¢ D√™ fechamento a TODOS os personagens\n   ‚Ä¢ Este √© o √öLTIMO bloco - conclus√£o definitiva!\n'}\n'
        'üí° ATEN√á√ÉO ESPECIAL:\n'
        '   ‚Ä¢ Hist√≥rias longas precisam de TODOS os blocos planejados\n'
        '   ‚Ä¢ N√ÉO termine prematuramente s√≥ porque "parece completo"\n'
        '   ‚Ä¢ Cada bloco √© parte de um roteiro maior - respeite o planejamento\n'
        '   ‚Ä¢ Finais prematuros PREJUDICAM a qualidade e a experi√™ncia do ouvinte\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n'
        '\n'
        'üéØ REGRA ABSOLUTA:\n'
        '   UMA HIST√ìRIA = UM CONFLITO CENTRAL = UM ARCO COMPLETO = UMA RESOLU√á√ÉO\n'
        '   PAR√ÅGRAFOS CURTOS = PAUSAS = DRAMATICIDADE = RETEN√á√ÉO ALTA\n'
        '   UM NOME = UM PERSONAGEM = NUNCA REUTILIZAR = VERIFICAR SEMPRE\n'
        '   DI√ÅLOGOS + MOTIVA√á√ïES + CLOSURE = HIST√ìRIA COMPLETA E SATISFAT√ìRIA\n'
        '\n'
        'üö´ NUNCA crie duas hist√≥rias separadas dentro do mesmo roteiro!\n'
        'üö´ NUNCA escreva par√°grafos com mais de 180 palavras!\n'
        'üö´ NUNCA reutilize nomes de personagens j√° mencionados!\n'
        'üö´ NUNCA deixe personagens importantes sem destino final!\n'
        'üö´ NUNCA fa√ßa trai√ß√µes/conflitos sem motiva√ß√£o clara!\n'
        '${blockNumber < totalBlocks ? 'üö´ NUNCA finalize a hist√≥ria antes do bloco final ($totalBlocks)!\n' : ''}'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';

    if (kDebugMode) {
      debugPrint(
        '[$_instanceId] Gerando bloco balanceado: $limitedNeeded ${c.measureType}',
      );
    }

    try {
      // üöÄ GEMINI 2.5 PRO: Suporta at√© 65.535 tokens de sa√≠da!
      // Aumentado para 50.000 tokens (76% da capacidade) para idiomas cir√≠licos

      // üåê AJUSTE: Idiomas n√£o-latinos (cir√≠lico, etc.) consomem mais tokens
      final languageNormalized = c.language.toLowerCase().trim();
      final isCyrillic =
          languageNormalized.contains('russo') ||
          languageNormalized.contains('b√∫lgar') ||
          languageNormalized.contains('bulgar') ||
          languageNormalized == 'ru' ||
          languageNormalized == 'bg';
      final isTurkish =
          languageNormalized.contains('turco') || languageNormalized == 'tr';

      // Cir√≠lico e turco precisam de 5x mais tokens por caractere (aumentado de 4x)
      // Idiomas latinos mant√™m 2.5x (aumentado de 2x) para mais margem
      final tokenMultiplier = c.measureType == 'caracteres'
          ? (isCyrillic || isTurkish ? 5.0 : 2.5)
          : 12.0; // Aumentado de 10.0 para 12.0 para palavras

      final maxTokensCalculated = (needed * tokenMultiplier).ceil();
      final maxTokensLimit = 50000; // Aumentado de 32.768 para 50.000 tokens
      final finalMaxTokens = maxTokensCalculated > maxTokensLimit
          ? maxTokensLimit
          : maxTokensCalculated;

      // ü§ñ SELE√á√ÉO DE MODELO BASEADA EM qualityMode
      final selectedModel = c.qualityMode == 'flash'
          ? 'gemini-2.5-flash'
          : 'gemini-2.5-pro';

      final data = await _makeApiRequest(
        apiKey: c.apiKey,
        model: selectedModel,
        prompt: prompt,
        maxTokens: finalMaxTokens,
      );
      final text = data ?? '';
      final filtered = text.isNotEmpty
          ? await _filterDuplicateParagraphs(previous, text)
          : '';

      // üî• VALIDA√á√ÉO DE TAMANHO: Rejeitar blocos que ultrapassem muito o limite
      // Aplic√°vel a TODOS os idiomas, n√£o s√≥ espanhol
      if (filtered.isNotEmpty && languageMultiplier != 1.0) {
        final wordCount = _countWords(filtered);
        // üîß CORRE√á√ÉO: Comparar com adjustedTarget (COM multiplicador), n√£o limitedNeeded (SEM multiplicador)
        final overage = wordCount - adjustedTarget;
        final overagePercent = (overage / adjustedTarget) * 100;

        // üî• FIX: Aumentado de 10% ‚Üí 35% porque API Gemini frequentemente excede 20-30%
        // Rejeitar se ultrapassar mais de 35% do limite AJUSTADO
        if (overagePercent > 35) {
          if (kDebugMode) {
            debugPrint(
              '‚ùå BLOCO $blockNumber REJEITADO (${c.language.toUpperCase()}):',
            );
            debugPrint('   Multiplicador do idioma: ${languageMultiplier}x');
            debugPrint(
              '   Pedido: $adjustedTarget palavras (limite m√°ximo ajustado)',
            );
            debugPrint(
              '   Recebido: $wordCount palavras (+${overagePercent.toStringAsFixed(1)}%)',
            );
            debugPrint('   üîÑ Retornando vazio para for√ßar regenera√ß√£o...');
          }
          return ''; // For√ßar regenera√ß√£o
        }

        if (kDebugMode && overage > 0) {
          debugPrint(
            '‚úÖ BLOCO $blockNumber ACEITO (${c.language.toUpperCase()}):',
          );
          debugPrint(
            '   Multiplicador: ${languageMultiplier}x | Pedido: $adjustedTarget palavras',
          );
          debugPrint(
            '   Recebido: $wordCount palavras (+${overagePercent.toStringAsFixed(1)}%)',
          );
        }
      }

      // üî• LOGGING: Detectar quando bloco retorna vazio
      if (filtered.isEmpty) {
        if (kDebugMode) {
          debugPrint('‚ö†Ô∏è BLOCO $blockNumber VAZIO DETECTADO!');
          if (data == null) {
            debugPrint(
              '   Causa: API retornou null (bloqueio de conte√∫do ou erro)',
            );
          } else if (text.isEmpty) {
            debugPrint('   Causa: Resposta da API estava vazia');
          } else {
            debugPrint('   Causa: Conte√∫do filtrado como duplicado');
            debugPrint('   Texto original: ${text.length} chars');
          }
        }
      }

      return filtered.isNotEmpty ? '\n$filtered' : '';
    } catch (e) {
      if (kDebugMode) {
        debugPrint('‚ùå ERRO no bloco $blockNumber: $e');
      }
      return '';
    }
  }

  Future<String?> _makeApiRequest({
    required String apiKey,
    required String model,
    required String prompt,
    required int maxTokens,
  }) async {
    // üöÄ Gemini 2.5 Pro suporta at√© 65.535 tokens de sa√≠da
    // Usando limite generoso para aproveitar capacidade total
    final adjustedMaxTokens = maxTokens < 8192
        ? 8192
        : min(maxTokens * 2, 32768);

    final resp = await _dio.post(
      'https://generativelanguage.googleapis.com/v1beta/models/$model:generateContent',
      queryParameters: {'key': apiKey},
      data: {
        'contents': [
          {
            'parts': [
              {'text': prompt},
            ],
          },
        ],
        'generationConfig': {
          'temperature': 0.8,
          'topK': 40,
          'topP': 0.95,
          'maxOutputTokens': adjustedMaxTokens,
        },
      },
    );

    // Debug completo da resposta
    debugPrint('GeminiService: Status Code: ${resp.statusCode}');
    debugPrint('GeminiService: Response Data: ${resp.data}');

    // Verificar se h√° erro na resposta
    if (resp.data['error'] != null) {
      debugPrint('GeminiService: API Error: ${resp.data['error']}');
      throw Exception('API Error: ${resp.data['error']['message']}');
    }

    // üö® VERIFICAR BLOQUEIO DE CONTE√öDO
    final promptFeedback = resp.data['promptFeedback'];
    if (promptFeedback != null && promptFeedback['blockReason'] != null) {
      final blockReason = promptFeedback['blockReason'];
      debugPrint('üö´ GeminiService: CONTE√öDO BLOQUEADO - Raz√£o: $blockReason');
      debugPrint(
        '‚ö†Ô∏è GeminiService: Contexto cont√©m conte√∫do sens√≠vel detectado pela API',
      );
      // Retornar null para que o sistema continue sem este bloco
      // O sistema vai tentar continuar com contexto reduzido
      return null;
    }

    // Verificar finish reason
    final finishReason = resp.data['candidates']?[0]?['finishReason'];
    if (finishReason == 'MAX_TOKENS') {
      debugPrint(
        'GeminiService: Aviso - Resposta cortada por limite de tokens',
      );
    }

    // Tentar extrair o texto da estrutura de resposta
    String? result;
    final candidate = resp.data['candidates']?[0];

    if (candidate != null) {
      // Primeiro tentar a estrutura padr√£o com parts
      result = candidate['content']?['parts']?[0]?['text'] as String?;

      // Se n√£o encontrou, tentar outras estruturas poss√≠veis
      if (result == null || result.isEmpty) {
        result = candidate['content']?['text'] as String?;
      }

      // Se ainda n√£o encontrou, tentar diretamente no candidate
      if (result == null || result.isEmpty) {
        result = candidate['text'] as String?;
      }
    }

    debugPrint('GeminiService: Extracted text: ${result?.length ?? 0} chars');
    debugPrint('GeminiService: Finish reason: $finishReason');

    // Limpar o texto de marca√ß√µes indesejadas
    if (result != null) {
      result = _cleanGeneratedText(result);
    }

    return result;
  }

  // Limpar texto de marca√ß√µes indesejadas
  String _cleanGeneratedText(String text) {
    return text
        // Remove "CONTINUA√á√ÉO:" no in√≠cio ou meio do texto
        .replaceAll(RegExp(r'CONTINUA√á√ÉO:\s*', caseSensitive: false), '')
        // Remove "CONTEXTO FINAL:" se aparecer
        .replaceAll(RegExp(r'CONTEXTO FINAL:\s*', caseSensitive: false), '')
        // Remove linhas vazias duplas
        .replaceAll(RegExp(r'\n\n\n+'), '\n\n')
        // Remove espa√ßos desnecess√°rios no in√≠cio
        .trim();
  }

  // üÜï SISTEMA DE RASTREAMENTO DE NOMES - v4 (SOLU√á√ÉO T√âCNICA)
  /// Extrai nomes pr√≥prios capitalizados do texto gerado
  /// Retorna Set de nomes encontrados (n√£o duplicados)
  Set<String> _extractNamesFromText(String text) {
    final names = <String>{};

    // üéØ REGEX para detectar nomes pr√≥prios:
    // - Palavra capitalizada (primeira letra mai√∫scula)
    // - 2-15 letras
    // - N√£o √© in√≠cio de frase (tem palavra antes)
    // - N√£o s√£o palavras comuns (artigos, preposi√ß√µes)
    final namePattern = RegExp(
      r'(?<![.!?]\s)(?<!\n)(?<!^)\b([A-Z√Ä-√ú][a-z√†-√ø]{1,14})\b',
      multiLine: true,
    );

    final matches = namePattern.allMatches(text);

    for (final match in matches) {
      final potentialName = match.group(1);
      if (potentialName != null) {
        // üî• FILTRO: Remover palavras comuns que n√£o s√£o nomes
        final commonWords = {
          'Ent√£o',
          'Quando',
          'Depois',
          'Antes',
          'Agora',
          'Hoje',
          'Naquela',
          'Aquela',
          'Aquele',
          'Naquele',
          'Enquanto',
          'Durante',
          'Embora',
          'Por√©m',
          'Portanto',
          'Assim',
          'Nunca',
          'Sempre',
          'Talvez',
          'Quase',
          'Apenas',
          'Mesmo',
          'Tamb√©m',
          'Muito',
          'Pouco',
          'Tanto',
        };

        if (!commonWords.contains(potentialName)) {
          names.add(potentialName);
        }
      }
    }

    return names;
  }

  /// Valida se h√° nomes duplicados em pap√©is diferentes
  /// Retorna lista de nomes duplicados encontrados
  List<String> _validateNamesInText(
    String newBlock,
    Set<String> previousNames,
  ) {
    final duplicates = <String>[];
    final newNames = _extractNamesFromText(newBlock);

    for (final name in newNames) {
      if (previousNames.contains(name)) {
        // üö® Nome j√° usado anteriormente!
        if (!duplicates.contains(name)) {
          duplicates.add(name);
        }
      }
    }

    return duplicates;
  }

  /// Adiciona nomes novos ao rastreador global
  void _addNamesToTracker(String text) {
    final names = _extractNamesFromText(text);
    _namesUsedInCurrentStory.addAll(names);

    if (kDebugMode && names.isNotEmpty) {
      debugPrint('üìù Nomes extra√≠dos do bloco: ${names.join(", ")}');
      debugPrint(
        'üìä Total de nomes √∫nicos na hist√≥ria: ${_namesUsedInCurrentStory.length}',
      );
    }
  }

  /// Reseta o rastreador de nomes (in√≠cio de nova hist√≥ria)
  void _resetNameTracker() {
    _namesUsedInCurrentStory.clear();
    if (kDebugMode) {
      debugPrint('üîÑ Rastreador de nomes resetado para nova hist√≥ria');
    }
  }

  // M√©todo p√∫blico para uso nos providers - OTIMIZADO PARA CONTEXTO
  Future<String> generateTextWithApiKey({
    required String prompt,
    required String apiKey,
    String model = 'gemini-2.5-pro',
    int maxTokens =
        16384, // AUMENTADO: Era 8192, agora 16384 para contextos mais ricos
  }) async {
    // CORRE√á√ÉO: Reset de estado para evitar conflitos com gera√ß√£o de scripts
    if (_isCancelled) _isCancelled = false;

    return await _retryOnRateLimit(() async {
      try {
        debugPrint('GeminiService: Iniciando requisi√ß√£o para modelo $model');
        final result = await _makeApiRequest(
          apiKey: apiKey,
          model: model,
          prompt: prompt,
          maxTokens: maxTokens,
        );
        debugPrint(
          'GeminiService: Resposta recebida - ${result != null ? 'Success' : 'Null'}',
        );
        if (result != null) {
          debugPrint('GeminiService: Length: ${result.length}');
        }

        // Aplicar limpeza adicional se necess√°rio
        final cleanResult = result != null ? _cleanGeneratedText(result) : '';
        return cleanResult;
      } catch (e) {
        debugPrint('GeminiService: Erro ao gerar texto: $e');
        throw Exception('Erro ao gerar texto: ${e.toString()}');
      }
    });
  }

  // ===================== SISTEMA ANTI-REPETI√á√ÉO =====================

  /// Verifica se h√° duplica√ß√£o LITERAL de blocos inteiros (c√≥pia exata)
  /// Retorna true se encontrar blocos de 200+ palavras duplicados
  /// üî• FORTALECIDO: Detecta duplica√ß√µes literais com m√∫ltiplas camadas
  bool _hasLiteralDuplication(String newBlock, String previousContent) {
    if (previousContent.isEmpty || newBlock.isEmpty) return false;
    if (previousContent.length < 500) {
      return false; // üî• REDUZIDO: Era impl√≠cito, agora 500
    }

    // üÜï CAMADA 1: Verificar par√°grafos completos duplicados
    final newParagraphs = newBlock
        .split('\n\n')
        .where(
          (p) =>
              p.trim().isNotEmpty && p.trim().split(RegExp(r'\s+')).length > 30,
        )
        .map((p) => p.trim().toLowerCase())
        .toList();

    final prevParagraphs = previousContent
        .split('\n\n')
        .where(
          (p) =>
              p.trim().isNotEmpty && p.trim().split(RegExp(r'\s+')).length > 30,
        )
        .map((p) => p.trim().toLowerCase())
        .toList();

    // üî• CR√çTICO: Detectar par√°grafos id√™nticos
    for (final newPara in newParagraphs) {
      for (final prevPara in prevParagraphs) {
        if (newPara == prevPara) {
          if (kDebugMode) {
            debugPrint('üö® PAR√ÅGRAFO DUPLICADO EXATO DETECTADO!');
            debugPrint(
              '   Preview: ${newPara.substring(0, min(100, newPara.length))}...',
            );
          }
          return true; // Par√°grafo duplicado exato
        }

        // üÜï Verificar in√≠cio id√™ntico (primeiras 50 palavras)
        final newWords = newPara.split(RegExp(r'\s+'));
        final prevWords = prevPara.split(RegExp(r'\s+'));

        if (newWords.length > 50 && prevWords.length > 50) {
          final newStart = newWords.take(50).join(' ');
          final prevStart = prevWords.take(50).join(' ');

          if (newStart == prevStart) {
            if (kDebugMode) {
              debugPrint('üö® IN√çCIO DE PAR√ÅGRAFO DUPLICADO DETECTADO!');
              debugPrint('   Primeiras 50 palavras s√£o id√™nticas');
            }
            return true;
          }
        }
      }
    }

    // üÜï CAMADA 2: Verificar sequ√™ncias de palavras (original, mas fortalecido)
    final newWords = newBlock.trim().split(RegExp(r'\s+'));
    final prevWords = previousContent.trim().split(RegExp(r'\s+'));

    if (newWords.length < 150 || prevWords.length < 150) {
      return false; // üî• REDUZIDO: Era 200
    }

    // üî• OTIMIZADO: Verificar sequ√™ncias menores (150 palavras)
    for (int i = 0; i <= newWords.length - 150; i++) {
      final newSequence = newWords.sublist(i, i + 150).join(' ').toLowerCase();

      for (int j = 0; j <= prevWords.length - 150; j++) {
        final prevSequence = prevWords
            .sublist(j, j + 150)
            .join(' ')
            .toLowerCase();

        if (newSequence == prevSequence) {
          if (kDebugMode) {
            debugPrint('üö® DUPLICA√á√ÉO LITERAL DE 150 PALAVRAS DETECTADA!');
            debugPrint(
              '   Preview: ${newSequence.substring(0, min(100, newSequence.length))}...',
            );
          }
          return true;
        }
      }
    }

    return false;
  }

  /// Calcula similaridade entre dois textos usando n-grams
  /// Retorna valor entre 0.0 (totalmente diferente) e 1.0 (id√™ntico)
  double _calculateSimilarity(String text1, String text2) {
    if (text1.isEmpty || text2.isEmpty) return 0.0;

    // Normalizar textos (remover espa√ßos extras, lowercase)
    final normalized1 = text1.toLowerCase().trim().replaceAll(
      RegExp(r'\s+'),
      ' ',
    );
    final normalized2 = text2.toLowerCase().trim().replaceAll(
      RegExp(r'\s+'),
      ' ',
    );

    if (normalized1 == normalized2) return 1.0; // Id√™nticos

    // Criar n-grams (sequ√™ncias de N palavras)
    const nGramSize =
        8; // üî• AUMENTADO: Era 5, agora 8 para detectar blocos maiores
    final words1 = normalized1.split(' ');
    final words2 = normalized2.split(' ');

    if (words1.length < nGramSize || words2.length < nGramSize) {
      // Textos muito curtos, comparar palavra por palavra
      final commonWords = words1.toSet().intersection(words2.toSet()).length;
      return commonWords / max(words1.length, words2.length);
    }

    // Gerar n-grams
    final ngrams1 = <String>{};
    for (int i = 0; i <= words1.length - nGramSize; i++) {
      ngrams1.add(words1.sublist(i, i + nGramSize).join(' '));
    }

    final ngrams2 = <String>{};
    for (int i = 0; i <= words2.length - nGramSize; i++) {
      ngrams2.add(words2.sublist(i, i + nGramSize).join(' '));
    }

    // Calcular interse√ß√£o (n-grams em comum)
    final intersection = ngrams1.intersection(ngrams2).length;
    final union = ngrams1.union(ngrams2).length;

    return union > 0 ? intersection / union : 0.0;
  }

  /// Verifica se novo bloco √© muito similar aos blocos anteriores
  /// Retorna true se similaridade > threshold (padr√£o 85%) OU se h√° duplica√ß√£o literal
  bool _isTooSimilar(
    String newBlock,
    String previousContent, {
    double threshold = 0.85,
  }) {
    if (previousContent.isEmpty) return false;

    // üî• PRIORIDADE 1: Verificar duplica√ß√£o literal de blocos grandes (c√≥pia exata)
    if (_hasLiteralDuplication(newBlock, previousContent)) {
      if (kDebugMode) {
        debugPrint(
          'üö® BLOQUEIO CR√çTICO: Duplica√ß√£o literal de bloco inteiro detectada!',
        );
      }
      return true; // Bloquear imediatamente
    }

    // üöÄ OTIMIZA√á√ÉO: Limitar contexto anterior para compara√ß√£o
    // üö® CR√çTICO: 20k caracteres ainda causava timeout nos blocos finais
    // Reduzido para 12k caracteres (~2k palavras) - suficiente para detectar repeti√ß√µes
    final limitedPrevious = previousContent.length > 12000
        ? previousContent.substring(previousContent.length - 12000)
        : previousContent;

    // Dividir conte√∫do anterior em par√°grafos
    final paragraphs = limitedPrevious
        .split('\n\n')
        .where((p) => p.trim().isNotEmpty)
        .toList();

    // üöÄ OTIMIZA√á√ÉO CR√çTICA: Limitar a 10 √∫ltimos par√°grafos (era 20)
    // Reduzido para eliminar travamentos "n√£o respondendo"
    final recentParagraphs = paragraphs.length > 10
        ? paragraphs.sublist(paragraphs.length - 10)
        : paragraphs;

    // Dividir novo bloco em par√°grafos
    final newParagraphs = newBlock
        .split('\n\n')
        .where((p) => p.trim().isNotEmpty)
        .toList();

    // Verificar cada par√°grafo novo contra os RECENTES (n√£o todos)
    int highSimilarityCount = 0;

    for (final newPara in newParagraphs) {
      if (newPara.trim().length < 100) {
        continue; // Ignorar par√°grafos muito curtos
      }

      // üöÄ OTIMIZA√á√ÉO: Parar se j√° encontrou repeti√ß√£o suficiente
      if (highSimilarityCount >= 2) break;

      for (final oldPara in recentParagraphs) {
        if (oldPara.trim().length < 100) continue;

        final similarity = _calculateSimilarity(newPara, oldPara);

        if (similarity >= threshold) {
          highSimilarityCount++;
          if (kDebugMode) {
            debugPrint(
              '‚ö†Ô∏è REPETI√á√ÉO DETECTADA (par√°grafo $highSimilarityCount)!',
            );
            debugPrint(
              '   Similaridade: ${(similarity * 100).toStringAsFixed(1)}% (threshold: ${(threshold * 100).toInt()}%)',
            );
          }

          // üî• Se encontrar 2+ par√°grafos muito similares = bloco repetido
          if (highSimilarityCount >= 2) {
            if (kDebugMode) {
              debugPrint(
                'üö® BLOQUEIO: $highSimilarityCount par√°grafos com alta similaridade!',
              );
            }
            return true;
          }
          break; // N√£o precisa comparar esse par√°grafo com outros
        }
      }
    }

    return false;
  }

  // Cache para evitar reprocessamento em contagens frequentes
  final Map<int, int> _wordCountCache = {};

  int _countWords(String text) {
    if (text.isEmpty) return 0;

    // Cache baseado no hash do texto (economiza mem√≥ria vs armazenar string completa)
    final hash = text.hashCode;
    if (_wordCountCache.containsKey(hash)) {
      return _wordCountCache[hash]!;
    }

    // Otimiza√ß√£o: trim() uma √∫nica vez
    final trimmed = text.trim();
    if (trimmed.isEmpty) return 0;

    // Conta palavras usando split otimizado
    final count = trimmed.split(RegExp(r'\s+')).length;

    // Limita cache a 100 entradas (previne vazamento de mem√≥ria)
    if (_wordCountCache.length > 100) {
      _wordCountCache.clear();
    }
    _wordCountCache[hash] = count;

    return count;
  }

  // M√©todo est√°tico para compatibilidade
  static void setApiTier(String tier) {
    // Implementa√ß√£o vazia para compatibilidade
  }

  // ===================== M√âTODOS CTA E FERRAMENTAS AUXILIARES =====================

  Future<Map<String, String>> generateCtasForScript({
    required String scriptContent,
    required String apiKey,
    required List<String> ctaTypes,
    String? customTheme,
    String language = 'Portugu√™s',
    String perspective =
        'terceira_pessoa', // PERSPECTIVA CONFIGURADA PELO USU√ÅRIO
  }) async {
    try {
      // Usar idioma e perspectiva configurados pelo usu√°rio (n√£o detectar)
      final finalLanguage = language;

      // Analisar contexto da hist√≥ria
      final scriptContext = await _analyzeScriptContext(
        scriptContent,
        apiKey,
        finalLanguage,
      );

      // Gerar CTAs contextualizados COM A PERSPECTIVA CONFIGURADA
      final prompt = _buildAdvancedCtaPrompt(
        scriptContent,
        ctaTypes,
        customTheme,
        finalLanguage,
        scriptContext,
        perspective, // USAR PERSPECTIVA DO CONFIG
      );

      final result = await generateTextWithApiKey(
        prompt: prompt,
        apiKey: apiKey,
        model:
            'gemini-2.5-flash-lite', // Flash-lite √© mais r√°pido e OBEDECE melhor a instru√ß√µes de perspectiva
        maxTokens: 3072,
      );

      if (result.isEmpty) {
        throw Exception('Resposta vazia do Gemini');
      }

      return _parseCtaResponse(result, ctaTypes);
    } catch (e) {
      if (kDebugMode) debugPrint('Erro generateCtasForScript: $e');
      return {};
    }
  }

  Future<String> _analyzeScriptContext(
    String scriptContent,
    String apiKey,
    String language,
  ) async {
    final prompt =
        '''
Analise rapidamente este roteiro em $language e identifique:
1. Tema principal (1-2 palavras)
2. P√∫blico-alvo (ex: jovens, adultos, fam√≠lias)
3. Tom (ex: motivacional, informativo, dram√°tico)

Responda em formato simples: "Tema: X, P√∫blico: Y, Tom: Z"

ROTEIRO:
${scriptContent.substring(0, scriptContent.length > 1000 ? 1000 : scriptContent.length)}
''';

    try {
      final result = await generateTextWithApiKey(
        prompt: prompt,
        apiKey: apiKey,
        model: 'gemini-2.5-flash-lite', // Ultra r√°pido para an√°lise simples
        maxTokens: 100,
      );
      return result.trim();
    } catch (e) {
      return '';
    }
  }

  String _buildAdvancedCtaPrompt(
    String scriptContent,
    List<String> ctaTypes,
    String? customTheme,
    String language,
    String scriptContext,
    String perspective, // PERSPECTIVA CONFIGURADA PELO USU√ÅRIO
  ) {
    final ctaDescriptions = _getCtaTypeDescriptions(language);
    final requestedTypes = ctaTypes
        .map(
          (type) =>
              '"$type": ${ctaDescriptions[type] ?? "Call-to-action personalizado"}',
        )
        .join('\n');

    // ‚ö° USAR PERSPECTIVA CONFIGURADA PELO USU√ÅRIO (n√£o detectar)
    final isPrimeiraPessoa = perspective.contains('primeira_pessoa');

    if (kDebugMode) {
      debugPrint('üéØ Perspectiva Configurada pelo Usu√°rio: $perspective');
      debugPrint(
        '   ‚Üí ${isPrimeiraPessoa ? "PRIMEIRA PESSOA" : "TERCEIRA PESSOA"}',
      );
    }

    final perspectiveInstruction = isPrimeiraPessoa
        ? '''
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë ‚ö†Ô∏è OBRIGAT√ìRIO: PRIMEIRA PESSOA - NARRADOR = PROTAGONISTA     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

O NARRADOR √â O PROTAGONISTA CONTANDO SUA PR√ìPRIA HIST√ìRIA.

üö® REGRA ABSOLUTA: CTAs devem falar como se o PERSONAGEM estivesse pedindo apoio.

‚úÖ CAPITALIZA√á√ÉO CORRETA:
- "eu", "meu/minha" (MIN√öSCULAS no meio da frase!)
- "Eu" (Mai√∫scula APENAS no in√≠cio da frase)
- ‚ùå ERRADO: "EU pensei", "MEU filho", "MINHA casa"
- ‚úÖ CERTO: "Eu pensei", "meu filho", "minha casa"

‚úÖ PALAVRAS OBRIGAT√ìRIAS:
- "eu", "meu/minha", "minha hist√≥ria", "meu relato", "comigo", "me"

‚úÖ EXEMPLOS CORRETOS (Primeira Pessoa):
‚Ä¢ CTA IN√çCIO: "Eu estava sem-teto e herdei 47 milh√µes. Mas a fortuna veio com um di√°rio de vingan√ßa. Inscreva-se e deixe seu like para ver onde isso me levou."
‚Ä¢ CTA IN√çCIO: "Um estranho na rua mudou minha vida em um segundo. Quer saber o que ele me ofereceu? Inscreva-se e deixe seu like!"
‚Ä¢ CTA MEIO: "O que voc√™ faria no meu lugar? Descobri que meu tio foi tra√≠do pelo pr√≥prio irm√£o. Comente o que voc√™ acha e compartilhe."
‚Ä¢ CTA FINAL: "Minha jornada da rua √† reden√ß√£o acabou. O que voc√™ achou dessa reviravolta? Inscreva-se para mais hist√≥rias intensas como esta."

‚ùå PROIBIDO (quebra a perspectiva):
‚Ä¢ Falar sobre "o protagonista", "ele/ela", "a hist√≥ria dele/dela"
‚Ä¢ Usar "esta hist√≥ria" ‚Üí Use "minha hist√≥ria"
‚Ä¢ Usar nomes pr√≥prios em 3¬™ pessoa ‚Üí Use "eu/meu"
‚Ä¢ Capitalizar tudo: "EU/MEU/MINHA" ‚Üí Use "eu/meu/minha"
‚Ä¢ üö® NUNCA use "Se essa reviravolta ME atingiu" ‚Üí O narrador EST√Å vivendo a hist√≥ria, n√£o assistindo!
‚Ä¢ üö® NUNCA use "Se isso TE impactou..." sem contexto espec√≠fico ‚Üí Muito gen√©rico!
'''
        : '''
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë ‚ö†Ô∏è OBRIGAT√ìRIO: TERCEIRA PESSOA - NARRADOR EXTERNO ENVOLVENTE ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

O NARRADOR √â UM OBSERVADOR EXTERNO contando a hist√≥ria de outras pessoas.

üö® REGRA ABSOLUTA: CTAs devem falar dos PERSONAGENS de forma externa, MAS mantendo a INTENSIDADE EMOCIONAL do roteiro!

‚úÖ CAPITALIZA√á√ÉO CORRETA:
- "esta/esse/essa" (min√∫sculas no meio da frase!)
- "Esta/Este/Essa" (Mai√∫scula APENAS no in√≠cio da frase)
- Nomes pr√≥prios sempre com inicial mai√∫scula: "K√°tia", "William"

‚úÖ PALAVRAS OBRIGAT√ìRIAS:
- Nomes dos personagens (K√°tia, William, etc.)
- "ela/dele", "esta hist√≥ria"
- Tom DRAM√ÅTICO, n√£o jornal√≠stico!

‚úÖ EXEMPLOS CORRETOS (Terceira Pessoa ENVOLVENTE):
‚Ä¢ "K√°tia descobriu que seu pr√≥prio filho transformou sua casa em uma arma. Se esta trai√ß√£o te chocou, inscreva-se e deixe seu like"
‚Ä¢ "William escondeu segredos nas paredes por anos. O que voc√™ faria no lugar de K√°tia? Comente o que est√° achando"
‚Ä¢ "A hist√≥ria de K√°tia chegou ao fim com um desfecho poderoso. O que voc√™ achou? Inscreva-se para mais hist√≥rias como esta"
‚Ä¢ "Esta fam√≠lia foi destro√ßada pela vingan√ßa. Compartilhe com quem entende dor de verdade"

‚ùå EXEMPLOS RUINS (muito formais/distantes):
‚Ä¢ "A jornada de [personagem] revelou..." ‚Üí Parece document√°rio chato
‚Ä¢ "Narrativas que exploram..." ‚Üí Parece cr√≠tica liter√°ria
‚Ä¢ "Compartilhe esta hist√≥ria com quem aprecia..." ‚Üí Muito gen√©rico

‚ùå PROIBIDO (quebra a perspectiva):
‚Ä¢ Usar "eu", "meu/minha", "comigo" ‚Üí Isso √© primeira pessoa!
‚Ä¢ "Se minha hist√≥ria te tocou" ‚Üí Use "Se a hist√≥ria de [personagem] te tocou"
‚Ä¢ "O que voc√™ faria no meu lugar?" ‚Üí Use "no lugar de [personagem]"

üî• REGRA DE OURO: Use DETALHES ESPEC√çFICOS DO ROTEIRO nos CTAs!
- N√£o diga "segredo chocante" ‚Üí Diga "dispositivo de metal corrosivo nas paredes"
- N√£o diga "decis√£o dif√≠cil" ‚Üí Diga "expulsar o pr√≥prio filho de casa"
- N√£o diga "jornada emocional" ‚Üí Diga "descobrir que seu filho √© um vingador"
''';

    return '''
‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ATEN√á√ÉO CR√çTICA: PERSPECTIVA NARRATIVA √â A REGRA #1 ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

$perspectiveInstruction

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Gere CTAs (calls-to-action) personalizados em $language para este roteiro.

CONTEXTO DO ROTEIRO: $scriptContext
TEMA PERSONALIZADO: ${customTheme ?? 'N√£o especificado'}

ROTEIRO (trecho inicial):
${scriptContent.substring(0, scriptContent.length > 2000 ? 2000 : scriptContent.length)}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéØ PROP√ìSITO ESPEC√çFICO DE CADA TIPO DE CTA:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìå "subscription" (CTA DE IN√çCIO):
   ‚Ä¢ Objetivo: Pedir INSCRI√á√ÉO no canal + LIKE
   ‚Ä¢ Momento: Logo no IN√çCIO da hist√≥ria, ap√≥s o gancho inicial
   
   üö® ERRO COMUM A EVITAR:
   ‚ùå "Se essa reviravolta ME atingiu..." ‚Üí Narrador falando de si mesmo em 3¬™ pessoa (ERRADO!)
   ‚ùå "Se essa reviravolta TE atingiu..." ‚Üí Muito gen√©rico, sem gancho espec√≠fico
   ‚ùå "No meu anivers√°rio, meu marido levou tudo..." ‚Üí N√ÉO REPITA A PRIMEIRA FRASE DO ROTEIRO! (ERRO FATAL!)
   
   üö® REGRA CR√çTICA - EXTRAIR DETALHES DO ROTEIRO:
   ‚ùå PROIBIDO copiar ou parafrasear a primeira frase do roteiro
   ‚ùå PROIBIDO usar frases gen√©ricas desconectadas do conte√∫do
   ‚úÖ OBRIGAT√ìRIO ler os primeiros 3-5 par√°grafos e extrair:
      ‚Ä¢ Objetos espec√≠ficos mencionados (bolo, tapete persa, envelope, carro, etc.)
      ‚Ä¢ A√ß√µes concretas (ele saiu, ela encontrou, queimaram, esconderam)
      ‚Ä¢ Nomes de personagens secund√°rios que aparecem logo no in√≠cio
      ‚Ä¢ Loca√ß√µes espec√≠ficas (sala vazia, escrit√≥rio, rua X)
   ‚úÖ Use ESSES detalhes para criar o gancho (n√£o invente detalhes!)
   
   üí° M√âTODO CORRETO - AN√ÅLISE DO IN√çCIO DO ROTEIRO:
   1. Leia os primeiros 3-5 par√°grafos do roteiro
   2. Liste mentalmente: Quais objetos? Quais a√ß√µes? Quais nomes?
   3. Escolha 2-3 detalhes MARCANTES (n√£o a primeira frase)
   4. Monte o CTA usando ESSES detalhes espec√≠ficos
   
   ‚Ä¢ Exemplo ERRADO (gen√©rico, desconectado):
     ‚ùå "Minha vida virou do avesso. Inscreva-se para ver o que aconteceu."
   
   ‚Ä¢ Exemplo CERTO (detalhes reais do roteiro):
     ‚úÖ "Eles levaram tudo, at√© o tapete persa que herdei. Mas esqueceram meu celular com a grava√ß√£o. Inscreva-se e deixe seu like para ver minha vingan√ßa."
     ‚úÖ "Um bolo de 45 velinhas intacto, uma casa vazia e um envelope pardo. Inscreva-se para descobrir como transformei essa trai√ß√£o em justi√ßa."
   
   ‚úÖ ESTRUTURA CORRETA:
   [2-3 detalhes espec√≠ficos DO ROTEIRO] + [Promessa de reviravolta/vingan√ßa] + "Inscreva-se e deixe seu like"
   
   ‚Ä¢ Exemplo (1¬™ pessoa): "Encontrei documentos escondidos no s√≥t√£o e uma chave que n√£o reconheci. Inscreva-se e deixe seu like para descobrir o que eles revelaram."
   ‚Ä¢ Exemplo (3¬™ pessoa): "K√°tia descobriu um dispositivo nos canos instalado pelo pr√≥prio filho. Inscreva-se para ver sua vingan√ßa."

üìå "engagement" (CTA DE MEIO):
   ‚Ä¢ Objetivo: Pedir COMENT√ÅRIOS sobre o que est√£o achando + COMPARTILHAMENTOS
   ‚Ä¢ Momento: No MEIO da hist√≥ria, ap√≥s uma reviravolta importante
   ‚Ä¢ Estrutura: Pergunta direta sobre opini√£o + "comente o que est√° achando" + "compartilhe"
   ‚Ä¢ Exemplo (1¬™ pessoa): "O que voc√™ faria no meu lugar? Comente o que est√° achando dessa situa√ß√£o e compartilhe com quem entenderia."
   ‚Ä¢ Exemplo (3¬™ pessoa): "O que voc√™ acha da decis√£o de K√°tia? Comente o que est√° achando e compartilhe com amigos."

üìå "final" (CTA DE CONCLUS√ÉO):
   ‚Ä¢ Objetivo: CTA CONCLUSIVO - hist√≥ria acabou, pedir FEEDBACK + INSCRI√á√ÉO para mais hist√≥rias
   ‚Ä¢ Momento: No FINAL da hist√≥ria, ap√≥s a resolu√ß√£o
   
   üö®üö®üö® ERRO CR√çTICO QUE VOC√ä COMETE SEMPRE:
   ‚ùå "Levaram tudo... O que voc√™ achou dessa frieza?" ‚Üí Fala como se protagonista ainda estivesse PERDENDO!
   ‚ùå "Eles me destru√≠ram... Inscreva-se..." ‚Üí Ignora que a hist√≥ria J√Å TEVE RESOLU√á√ÉO!
   ‚ùå Focar na TRAG√âDIA INICIAL em vez do DESFECHO REAL!
   
   üö® REGRA ABSOLUTA - CTA DEVE REFLETIR O FINAL REAL:
   ‚úÖ OBRIGAT√ìRIO ler os √∫ltimos 3-5 par√°grafos do roteiro
   ‚úÖ Identificar o DESFECHO REAL:
      ‚Ä¢ Protagonista venceu? ‚Üí CTA de VIT√ìRIA
      ‚Ä¢ Protagonista perdeu? ‚Üí CTA de DERROTA
      ‚Ä¢ Final amb√≠guo? ‚Üí CTA de REFLEX√ÉO
   ‚úÖ Mencionar COMO a hist√≥ria terminou (pris√£o do vil√£o, vingan√ßa conclu√≠da, fuga, morte, reconcilia√ß√£o)
   
   üí° M√âTODO CORRETO - AN√ÅLISE DO FINAL:
   1. Leia os √∫ltimos 3-5 par√°grafos
   2. Pergunte: "Como a protagonista est√° AGORA?"
      ‚Ä¢ Vencedora? ‚Üí "Consegui fazer justi√ßa"
      ‚Ä¢ Destru√≠da? ‚Üí "Perdi tudo"
      ‚Ä¢ Reconstruindo? ‚Üí "Estou come√ßando de novo"
   3. O CTA deve COMBINAR com esse estado final!
   
   ‚ùå EXEMPLO ERRADO (final de vit√≥ria com CTA de derrota):
   Final do roteiro: "Marcos foi preso. Recuperei meu dinheiro. Era justi√ßa."
   CTA ERRADO: "Levaram tudo e me deixaram sem nada. O que voc√™ achou?" ‚ùå
   
   ‚úÖ EXEMPLO CERTO (final de vit√≥ria com CTA de vit√≥ria):
   Final do roteiro: "Marcos foi preso. Recuperei meu dinheiro. Era justi√ßa."
   CTA CERTO: "Da casa vazia √† pris√£o dele. Recuperei tudo e o coloquei atr√°s das grades. O que voc√™ achou da minha vingan√ßa? Inscreva-se para mais hist√≥rias de justi√ßa como esta." ‚úÖ
   
   ‚úÖ ESTRUTURA CORRETA:
   [Resumo do DESFECHO REAL] + [Mencionar resultado final] + "O que voc√™ achou?" + "Inscreva-se para mais hist√≥rias"
   
   ‚Ä¢ Exemplo (final de vit√≥ria - 1¬™ pessoa): 
     ‚úÖ "De v√≠tima a vencedora. Ele est√° preso, eu recuperei o que era meu. O que voc√™ achou dessa virada? Inscreva-se para mais hist√≥rias de vingan√ßa como esta."
   
   ‚Ä¢ Exemplo (final de derrota - 1¬™ pessoa):
     ‚úÖ "Perdi tudo, mas ganhei minha liberdade. √Äs vezes, recome√ßar √© a √∫nica vit√≥ria poss√≠vel. O que voc√™ achou? Inscreva-se para mais hist√≥rias intensas."
   
   ‚Ä¢ Exemplo (final amb√≠guo - 3¬™ pessoa):
     ‚úÖ "K√°tia expulsou o filho, mas a casa ficou vazia. Ser√° que valeu a pena? O que voc√™ acha? Inscreva-se para mais dilemas como este."
   
   üî• CHECKLIST DO CTA FINAL:
   ‚ñ° Li os √∫ltimos 3-5 par√°grafos?
   ‚ñ° Identifiquei se protagonista venceu/perdeu/ficou no meio-termo?
   ‚ñ° Meu CTA reflete esse desfecho REAL?
   ‚ñ° Mencionei o resultado concreto (pris√£o, vit√≥ria, perda, fuga)?
   ‚ñ° N√£o estou falando da trag√©dia inicial quando a hist√≥ria j√° teve resolu√ß√£o?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

GERE OS SEGUINTES TIPOS DE CTA:
$requestedTypes

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

FORMATO DE RESPOSTA (JSON):
{
  "subscription": "texto do CTA aqui",
  "engagement": "texto do CTA aqui",
  "pre_conclusion": "texto do CTA aqui",
  "final": "texto do CTA aqui"
}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

REQUISITOS OBRIGAT√ìRIOS:
1. ‚ö†Ô∏è PERSPECTIVA NARRATIVA √â PRIORIDADE #1 - RELEIA AS INSTRU√á√ïES NO TOPO AGORA!
2. ‚ö†Ô∏è CAPITALIZA√á√ÉO CORRETA - "eu/meu/minha" em MIN√öSCULAS (n√£o "EU/MEU/MINHA")!
3. üéØ CADA CTA TEM UM PROP√ìSITO ESPEC√çFICO - Releia a se√ß√£o "PROP√ìSITO ESPEC√çFICO" acima!
   ‚Ä¢ subscription = inscri√ß√£o + like
   ‚Ä¢ engagement = coment√°rios + compartilhamento
   ‚Ä¢ final = feedback + inscri√ß√£o para mais hist√≥rias
4. üî• CTA DE IN√çCIO: Extraia detalhes REAIS dos primeiros 3-5 par√°grafos (objetos, a√ß√µes, nomes)
5. üî• CTA FINAL: Leia os √∫ltimos 3-5 par√°grafos e reflita o DESFECHO REAL (vit√≥ria/derrota/recome√ßo)
6. üö´ PROIBIDO usar palavras gen√©ricas: "jornada", "narrativa", "explorar", "revelar"
7. ‚úÖ OBRIGAT√ìRIO mencionar ELEMENTOS CHOCANTES: nomes, objetos, a√ß√µes espec√≠ficas
8. Cada CTA: 25-45 palavras (DIRETO E IMPACTANTE, com espa√ßo para CTAs completos)
9. Linguagem VISCERAL e DRAM√ÅTICA em $language (n√£o formal/acad√™mica)
10. Tom emocional IGUAL ao do roteiro (se √© intenso, CTA √© intenso; se √© suave, CTA √© suave)
11. Se protagonista tomou DECIS√ÉO EXTREMA (expulsar filho, confrontar vil√£o), mencione isso!
12. N√ÉO prometa eventos futuros que j√° aconteceram no roteiro
13. Retorne JSON v√°lido apenas

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CHECKLIST FINAL - RESPONDA ANTES DE GERAR: ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
‚ñ° Reli as instru√ß√µes de PERSPECTIVA NARRATIVA no topo?
‚ñ° ${isPrimeiraPessoa ? "Vou usar 'eu/meu/minha' em MIN√öSCULAS (n√£o EU/MEU/MINHA)?" : "Vou usar nomes pr√≥prios/ela/ele/esta hist√≥ria?"}
‚ñ° Cada CTA segue seu PROP√ìSITO ESPEC√çFICO?
  ‚Ä¢ subscription = inscri√ß√£o + like?
  ‚Ä¢ engagement = coment√°rios + compartilhamento?
  ‚Ä¢ final = feedback + inscri√ß√£o para mais hist√≥rias?
‚ñ° No CTA DE IN√çCIO: Extra√≠ detalhes REAIS dos primeiros par√°grafos (objetos, a√ß√µes, nomes)?
‚ñ° No CTA DE IN√çCIO: N√ÉO repeti/parafraseei a primeira frase do roteiro?
‚ñ° No CTA FINAL: Li os √∫ltimos 3-5 par√°grafos e identifiquei o DESFECHO REAL?
‚ñ° No CTA FINAL: Meu CTA reflete se protagonista venceu/perdeu/est√° recome√ßando?
‚ñ° Mencionei DETALHES ESPEC√çFICOS do roteiro (nomes, objetos-chave, a√ß√µes concretas)?
‚ñ° EVITEI palavras gen√©ricas ("jornada", "narrativa", "revelar", "explorar")?
‚ñ° O tom do CTA est√° T√ÉO INTENSO quanto o roteiro?
‚ñ° Formato JSON est√° correto?

üö® ERROS FATAIS A EVITAR NO CTA DE IN√çCIO:
‚ùå "Se essa reviravolta ME atingiu, inscreva-se..." ‚Üí Narrador falando de si em 3¬™ pessoa!
‚ùå "Se essa hist√≥ria TE impactou..." ‚Üí Muito gen√©rico, sem gancho!
‚ùå "No meu anivers√°rio, meu marido levou tudo..." ‚Üí NUNCA REPITA A PRIMEIRA FRASE DO ROTEIRO! (ERRO CR√çTICO!)
‚ùå Copiar ou parafrasear a frase de abertura do roteiro ‚Üí Use OUTROS detalhes espec√≠ficos!
‚ùå Frases gen√©ricas desconectadas do texto ‚Üí Leia os primeiros par√°grafos e extraia objetos/a√ß√µes REAIS!
‚úÖ CORRETO: Extrair 2-3 detalhes espec√≠ficos dos primeiros par√°grafos + promessa de reviravolta
‚úÖ Exemplo: "Eles levaram at√© o tapete persa. Mas esqueceram meu celular com a grava√ß√£o. Inscreva-se para ver minha vingan√ßa."
‚úÖ Exemplo: "45 velinhas, um bolo intacto e documentos escondidos no s√≥t√£o. Inscreva-se para descobrir o que eles revelaram."

üö® ERROS FATAIS A EVITAR NO CTA FINAL:
‚ùå "Levaram tudo... O que voc√™ achou dessa frieza?" ‚Üí Fala do in√≠cio quando hist√≥ria j√° teve resolu√ß√£o!
‚ùå Ignorar o desfecho real e focar na trag√©dia inicial ‚Üí Leia os √∫ltimos par√°grafos!
‚ùå CTA de v√≠tima quando protagonista VENCEU ‚Üí Desonesto com a hist√≥ria!
‚ùå CTA de vit√≥ria quando protagonista PERDEU ‚Üí Tamb√©m desonesto!
‚úÖ CORRETO: Resumir o DESFECHO REAL (pris√£o, vingan√ßa conclu√≠da, perda, recome√ßo)
‚úÖ Exemplo (vit√≥ria): "Da casa vazia √† pris√£o dele. Recuperei tudo e o coloquei atr√°s das grades. O que voc√™ achou?"
‚úÖ Exemplo (derrota): "Perdi tudo, mas ganhei liberdade. Recome√ßar √© a √∫nica vit√≥ria. O que voc√™ achou?"

üö® SE VOC√ä USAR LINGUAGEM GEN√âRICA, CAPITALIZA√á√ÉO ERRADA OU QUEBRAR A PERSPECTIVA, O CTA SER√Å REJEITADO! üö®

EXEMPLOS DE DETALHES ESPEC√çFICOS (use este n√≠vel de concretude):
‚ùå RUIM: "A protagonista descobriu um segredo"
‚úÖ BOM: "K√°tia encontrou um dispositivo corrosivo escondido nos canos por William"

‚ùå RUIM: "Uma decis√£o dif√≠cil foi tomada"
‚úÖ BOM: "K√°tia expulsou o pr√≥prio filho de casa ap√≥s descobrir sua vingan√ßa"

‚ùå RUIM: "Se esta hist√≥ria te impactou"
‚úÖ BOM: "Se a trai√ß√£o de William dentro das paredes te chocou"
''';
  }

  Map<String, String> _getCtaTypeDescriptions(String language) {
    return {
      'subscription': 'CTA para inscri√ß√£o no canal',
      'engagement': 'CTA para intera√ß√£o (like, coment√°rio)',
      'pre_conclusion': 'CTA antes da conclus√£o',
      'final': 'CTA de fechamento',
    };
  }

  Map<String, String> _parseCtaResponse(
    String response,
    List<String> ctaTypes,
  ) {
    try {
      if (kDebugMode) {
        debugPrint(
          'üéØ CTA Response original: ${response.substring(0, response.length > 200 ? 200 : response.length)}...',
        );
      }

      // Remover markdown code blocks (```json ... ```)
      String cleanedResponse = response;
      cleanedResponse = cleanedResponse.replaceAll(RegExp(r'```json\s*'), '');
      cleanedResponse = cleanedResponse.replaceAll(RegExp(r'```\s*'), '');
      cleanedResponse = cleanedResponse.trim();

      if (kDebugMode) {
        debugPrint(
          'üéØ CTA Response limpa: ${cleanedResponse.substring(0, cleanedResponse.length > 200 ? 200 : cleanedResponse.length)}...',
        );
      }

      // Tentar extrair JSON da resposta
      final jsonStart = cleanedResponse.indexOf('{');
      final jsonEnd = cleanedResponse.lastIndexOf('}');

      if (jsonStart == -1 || jsonEnd == -1) {
        throw Exception('Formato JSON n√£o encontrado na resposta');
      }

      final jsonString = cleanedResponse.substring(jsonStart, jsonEnd + 1);
      if (kDebugMode) {
        debugPrint('üéØ JSON extra√≠do: ${jsonString.length} chars');
      }

      final Map<String, String> ctas = {};
      for (final type in ctaTypes) {
        // Parse multiline: permite quebras de linha e espa√ßos dentro do valor
        // Captura tudo entre as aspas, incluindo quebras de linha
        final pattern = '"$type"\\s*:\\s*"([^"]*(?:\\\\.[^"]*)*)"';
        final regex = RegExp(pattern, multiLine: true, dotAll: true);
        final match = regex.firstMatch(jsonString);
        if (match != null) {
          String ctaText = match.group(1) ?? '';
          // Limpar quebras de linha escapadas e espa√ßos extras
          ctaText = ctaText.replaceAll(RegExp(r'\s+'), ' ').trim();
          ctas[type] = ctaText;
          if (kDebugMode) {
            debugPrint(
              '‚úÖ CTA extra√≠do [$type]: ${ctaText.substring(0, ctaText.length > 50 ? 50 : ctaText.length)}...',
            );
          }
        } else {
          if (kDebugMode) debugPrint('‚ö†Ô∏è CTA n√£o encontrado para tipo: $type');
        }
      }

      if (kDebugMode) {
        debugPrint(
          'üéØ Total de CTAs extra√≠dos: ${ctas.length}/${ctaTypes.length}',
        );
      }
      return ctas;
    } catch (e, stack) {
      if (kDebugMode) {
        debugPrint('‚ùå Erro ao fazer parse dos CTAs: $e');
        debugPrint('Stack trace: $stack');
      }
      return {};
    }
  }
}

// üî• SOLU√á√ÉO 3: Tracker GLOBAL para manter personagens entre blocos
/// üìù Classe para armazenar uma nota sobre um personagem em um bloco espec√≠fico
class _CharacterNote {
  final int blockNumber;
  final String observation;
  final DateTime timestamp;

  _CharacterNote(this.blockNumber, this.observation)
    : timestamp = DateTime.now();

  @override
  String toString() => '[Bloco $blockNumber] $observation';
}

/// üìö Classe para armazenar o hist√≥rico completo de um personagem
class _CharacterHistory {
  final String name;
  final List<_CharacterNote> timeline = [];

  _CharacterHistory(this.name);

  /// Adiciona uma nova observa√ß√£o sobre o personagem
  void addNote(int blockNumber, String observation) {
    if (observation.isEmpty) return;
    timeline.add(_CharacterNote(blockNumber, observation));
    if (kDebugMode) {
      debugPrint('üìù Nota adicionada: "$name" ‚Üí [B$blockNumber] $observation');
    }
  }

  /// Retorna o hist√≥rico completo formatado
  String getFullHistory() {
    if (timeline.isEmpty) return '';
    return timeline.map((e) => e.toString()).join('\n   ');
  }

  /// Verifica se uma nova observa√ß√£o contradiz o hist√≥rico
  bool contradicts(String newObservation) {
    if (timeline.isEmpty) return false;

    // Extrair palavras-chave da nova observa√ß√£o
    final newKeywords = _extractRelationshipKeywords(newObservation);

    // Verificar se contradiz alguma nota anterior
    for (final note in timeline) {
      final existingKeywords = _extractRelationshipKeywords(note.observation);

      // Se ambos t√™m palavras de relacionamento, verificar contradi√ß√£o
      if (newKeywords.isNotEmpty && existingKeywords.isNotEmpty) {
        // Relacionamentos diferentes para o mesmo tipo = contradi√ß√£o
        if (_areContradictoryRelationships(existingKeywords, newKeywords)) {
          return true;
        }
      }
    }

    return false;
  }

  /// Extrai palavras-chave de relacionamento de uma observa√ß√£o
  Set<String> _extractRelationshipKeywords(String text) {
    final keywords = <String>{};
    final lowerText = text.toLowerCase();

    // Padr√µes de relacionamento
    final patterns = {
      'irm√£': r'irm√£\s+de\s+(\w+)',
      'irm√£o': r'irm√£o\s+de\s+(\w+)',
      'filho': r'filh[oa]\s+de\s+(\w+)',
      'pai': r'pai\s+de\s+(\w+)',
      'm√£e': r'm√£e\s+de\s+(\w+)',
      'esposa': r'esposa\s+de\s+(\w+)',
      'marido': r'marido\s+de\s+(\w+)',
      'neto': r'net[oa]\s+de\s+(\w+)',
      'tio': r'ti[oa]\s+de\s+(\w+)',
      'primo': r'prim[oa]\s+de\s+(\w+)',
      'av√¥': r'av[√¥√≥]\s+de\s+(\w+)',
    };

    for (final entry in patterns.entries) {
      final regex = RegExp(entry.value, caseSensitive: false);
      final match = regex.firstMatch(lowerText);
      if (match != null) {
        keywords.add('${entry.key}_${match.group(1)}');
      }
    }

    return keywords;
  }

  /// Verifica se dois conjuntos de relacionamentos s√£o contradit√≥rios
  bool _areContradictoryRelationships(Set<String> existing, Set<String> new_) {
    for (final existingRel in existing) {
      final existingType = existingRel.split('_')[0];

      for (final newRel in new_) {
        final newType = newRel.split('_')[0];

        // Mesmo tipo de relacionamento mas com pessoas diferentes = contradi√ß√£o
        if (existingType == newType && existingRel != newRel) {
          if (kDebugMode) {
            debugPrint('üö® CONTRADI√á√ÉO DETECTADA:');
            debugPrint('   Existente: $existingRel');
            debugPrint('   Nova: $newRel');
          }
          return true;
        }
      }
    }

    return false;
  }

  /// Retorna a primeira nota (papel inicial do personagem)
  String? get initialRole {
    return timeline.isEmpty ? null : timeline.first.observation;
  }

  /// Retorna n√∫mero de apari√ß√µes do personagem
  int get appearanceCount => timeline.length;
}

class _CharacterTracker {
  final Set<String> _confirmedNames = {};
  // üî• NOVO: Mapear cada nome ao seu papel para prevenir confus√£o e reuso
  final Map<String, String> _characterRoles = {};
  // ÔøΩ v1.7 NOVO: MAPEAMENTO REVERSO papel ‚Üí nome (detecta nomes m√∫ltiplos por papel)
  final Map<String, String> _roleToName = {};
  // ÔøΩüìö SISTEMA DE NOTAS: Hist√≥rico completo de cada personagem
  final Map<String, _CharacterHistory> _characterHistories = {};

  void addName(String name, {String? role, int? blockNumber}) {
    if (name.isEmpty || name.length <= 2) return;

    // üîí VALIDA√á√ÉO CR√çTICA: Bloquear reuso de nomes
    if (_confirmedNames.contains(name)) {
      if (kDebugMode) {
        final existingRole = _characterRoles[name] ?? 'desconhecido';
        debugPrint(
          '‚ùå BLOQUEIO DE REUSO: "$name" j√° usado como "$existingRole"!',
        );
        if (role != null && role != existingRole) {
          debugPrint(
            '   ‚ö†Ô∏è Tentativa de reusar "$name" como "$role" ‚Üí REJEITADO!',
          );
        }
      }
      return; // Bloqueia adi√ß√£o
    }

    // üö® v1.7: VALIDA√á√ÉO REVERSA - Um papel pode ter apenas UM nome
    if (role != null && role.isNotEmpty && role != 'indefinido') {
      // Normalizar papel (remover detalhes espec√≠ficos para compara√ß√£o)
      final normalizedRole = _normalizeRole(role);

      if (_roleToName.containsKey(normalizedRole)) {
        final existingName = _roleToName[normalizedRole]!;

        if (existingName != name) {
          // üö® ERRO CR√çTICO: Mesmo papel com nomes diferentes!
          if (kDebugMode) {
            debugPrint(
              'üö®üö®üö® ERRO CR√çTICO v1.7: M√öLTIPLOS NOMES PARA MESMO PAPEL üö®üö®üö®',
            );
            debugPrint('   ‚ùå Papel: "$normalizedRole"');
            debugPrint('   ‚ùå Nome original: "$existingName"');
            debugPrint('   ‚ùå Nome novo (CONFLITANTE): "$name"');
            debugPrint(
              '   üí° EXEMPLO DO BUG: "filho" sendo Marco em um bloco e Martin em outro!',
            );
            debugPrint(
              '   ‚ö†Ô∏è BLOQUEANDO adi√ß√£o de "$name" - usar apenas "$existingName"!',
            );
            debugPrint('üö®üö®üö® FIM DO ALERTA üö®üö®üö®');
          }
          return; // BLOQUEIA nome conflitante
        }
      } else {
        // Primeiro nome para este papel - registrar no mapeamento reverso
        _roleToName[normalizedRole] = name;
        if (kDebugMode) {
          debugPrint('üîó MAPEAMENTO REVERSO: "$normalizedRole" ‚Üí "$name"');
        }
      }
    }

    _confirmedNames.add(name);
    if (role != null && role.isNotEmpty) {
      _characterRoles[name] = role;
      if (kDebugMode) {
        debugPrint('‚úÖ MAPEAMENTO: "$name" = "$role"');
      }

      // üìö SISTEMA DE NOTAS: Adicionar ao hist√≥rico
      if (blockNumber != null) {
        addNoteToCharacter(name, blockNumber, role);
      }
    }
  }

  /// üîß v1.7: Normaliza papel para compara√ß√£o (remove detalhes espec√≠ficos)
  /// Exemplo: "irm√£ de Ana" ‚Üí "irm√£", "filho de Maria" ‚Üí "filho"
  String _normalizeRole(String role) {
    // Remover " de [nome]" do final
    final normalized = role.replaceAll(
      RegExp(r'\s+de\s+[A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß]+.*$'),
      '',
    );
    return normalized.trim().toLowerCase();
  }

  /// üìù Adiciona uma nota sobre um personagem
  void addNoteToCharacter(String name, int blockNumber, String observation) {
    if (!_characterHistories.containsKey(name)) {
      _characterHistories[name] = _CharacterHistory(name);
    }

    // Verificar se a nova observa√ß√£o contradiz o hist√≥rico
    final history = _characterHistories[name]!;
    if (history.contradicts(observation)) {
      if (kDebugMode) {
        debugPrint('üö®üö®üö® CONTRADI√á√ÉO NO HIST√ìRICO DE "$name" üö®üö®üö®');
        debugPrint('   üìö Hist√≥rico existente:');
        debugPrint('   ${history.getFullHistory()}');
        debugPrint('   ‚ö†Ô∏è Nova observa√ß√£o contradit√≥ria: $observation');
        debugPrint('   üí° Esta observa√ß√£o N√ÉO ser√° adicionada!');
        debugPrint('üö®üö®üö® FIM DO ALERTA üö®üö®üö®');
      }
      return; // Bloqueia adi√ß√£o de observa√ß√£o contradit√≥ria
    }

    history.addNote(blockNumber, observation);
  }

  /// üìñ Obt√©m o hist√≥rico completo de um personagem
  String? getCharacterHistory(String name) {
    final history = _characterHistories[name];
    return history?.getFullHistory();
  }

  /// üìä Obt√©m estat√≠sticas de um personagem
  Map<String, dynamic> getCharacterStats(String name) {
    final history = _characterHistories[name];
    if (history == null) return {};

    return {
      'name': name,
      'initial_role': history.initialRole,
      'appearances': history.appearanceCount,
      'full_history': history.getFullHistory(),
    };
  }

  void addNames(List<String> names) {
    for (final name in names) {
      addName(name);
    }
  }

  Set<String> get confirmedNames => Set.unmodifiable(_confirmedNames);

  bool hasName(String name) => _confirmedNames.contains(name);

  String? getRole(String name) => _characterRoles[name];

  /// üîç v1.7: Obt√©m o nome associado a um papel (mapeamento reverso)
  String? getNameForRole(String role) {
    final normalizedRole = _normalizeRole(role);
    return _roleToName[normalizedRole];
  }

  /// üîç v1.7: Verifica se um papel j√° tem nome definido
  bool roleHasName(String role) {
    final normalizedRole = _normalizeRole(role);
    return _roleToName.containsKey(normalizedRole);
  }

  // üî• NOVO: Obter mapeamento completo de personagens com hist√≥rico
  String getCharacterMapping() {
    if (_characterRoles.isEmpty && _characterHistories.isEmpty) return '';

    final buffer = StringBuffer('\nüé≠ PERSONAGENS J√Å DEFINIDOS:\n');

    // v1.7: Mostrar mapeamento reverso (papel ‚Üí nome) para refor√ßar consist√™ncia
    if (_roleToName.isNotEmpty) {
      buffer.writeln(
        '\nüìã MAPEAMENTO PAPEL ‚Üí NOME (use SEMPRE os mesmos nomes):',
      );
      for (final entry in _roleToName.entries) {
        buffer.writeln(
          '   "${entry.key}" = "${entry.value}" ‚ö†Ô∏è NUNCA mude este nome!',
        );
      }
      buffer.writeln();
    }

    // Para cada personagem, mostrar hist√≥rico completo se dispon√≠vel
    for (final name in _confirmedNames) {
      final history = _characterHistories[name];

      if (history != null && history.timeline.isNotEmpty) {
        // Mostrar hist√≥rico completo
        buffer.writeln('\nüë§ $name:');
        buffer.writeln('   ${history.getFullHistory()}');
        buffer.writeln(
          '   ‚ö†Ô∏è NUNCA mude este personagem! Use outro nome para novos personagens.',
        );
      } else {
        // Mostrar apenas papel b√°sico
        final role = _characterRoles[name] ?? 'personagem';
        buffer.writeln('   "$name" = $role');
      }
    }

    return buffer.toString();
  }

  void clear() {
    _confirmedNames.clear();
    _characterRoles.clear();
    _roleToName.clear(); // v1.7: Limpar mapeamento reverso
    _characterHistories.clear();
  }
}
