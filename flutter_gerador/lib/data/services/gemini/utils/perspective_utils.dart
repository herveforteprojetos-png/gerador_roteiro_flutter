import 'package:flutter_gerador/data/models/script_config.dart';

class PerspectiveUtils {
  static String perspectiveLabel(String perspective) {
    final perspectiveLower = perspective.toLowerCase();

    // ?? FIX: Detectar primeira pessoa em qualquer formato
    if (perspectiveLower.contains('primeira_pessoa') ||
        perspectiveLower == 'first') {
      if (perspectiveLower.contains('mulher_idosa')) {
        return 'Primeira pessoa - Mulher Idosa (50+)';
      }
      if (perspectiveLower.contains('mulher_madura')) {
        return 'Primeira pessoa - Mulher Madura (35-50)';
      }
      if (perspectiveLower.contains('mulher_jovem')) {
        return 'Primeira pessoa - Mulher Jovem (20-35)';
      }
      if (perspectiveLower.contains('homem_idoso')) {
        return 'Primeira pessoa - Homem Idoso (50+)';
      }
      if (perspectiveLower.contains('homem_maduro')) {
        return 'Primeira pessoa - Homem Maduro (35-50)';
      }
      if (perspectiveLower.contains('homem_jovem')) {
        return 'Primeira pessoa - Homem Jovem (20-35)';
      }
      return 'Primeira pessoa';
    }

    // Terceira pessoa (padrão)
    return 'Terceira pessoa';
  }

  // ?? CORRIGIDO: Instrução CLARA de perspectiva com contexto do protagonista
  static String getPerspectiveInstruction(String perspective, ScriptConfig config) {
    final protagonistInfo = config.protagonistName.trim().isNotEmpty
        ? ' O protagonista é "${config.protagonistName}".'
        : '';

    // ?? FIX: Aceitar valores reais da interface (primeira_pessoa_*, terceira_pessoa)
    final perspectiveLower = perspective.toLowerCase();

    // ?? DETECTAR GÊNERO DO NARRADOR BASEADO NA PERSPECTIVA
    if (perspectiveLower.contains('mulher')) {
      // FEMININO (ela)
    } else if (perspectiveLower.contains('homem')) {
      // MASCULINO (ele)
    }

    // Detectar primeira pessoa (qualquer variação)
    if (perspectiveLower.contains('primeira_pessoa') ||
        perspectiveLower == 'first') {
      // Definir pronomes baseado no tipo de primeira pessoa
      String pronomes = 'EU, MEU, MINHA, COMIGO';
      String exemplos =
          '"EU vendi a casa...", "MEU coração batia forte...", "COMIGO ela nunca foi honesta..."';
      String nomeInstrucao = '';

      if (perspectiveLower.contains('mulher')) {
        exemplos =
            '"EU vendi a casa...", "MINHA nora me traiu...", "COMIGO ela nunca foi honesta..."';

        // ?? DETECTAR FAIXA ETÁRIA E ADICIONAR INSTRUÇÕES ESPECÍFICAS
        String idadeInstrucao = '';
        if (perspectiveLower.contains('jovem')) {
          idadeInstrucao = '''
????????????????????????????????????????????????????????????????????????
?? FAIXA ETÁRIA OBRIGATÓRIA: MULHER JOVEM (20-35 ANOS)
????????????????????????????????????????????????????????????????????????

? IDADE CORRETA: Entre 20 e 35 anos
? PERFIL: Mulher adulta jovem, início/meio da carreira, possivelmente casada/solteira, energética
? CONTEXTO: Pode ter filhos pequenos, focada em crescimento profissional/pessoal
? VOCABULÁRIO: Moderno, atual, referências contemporâneas

? PROIBIDO: Mencionar aposentadoria, netos, memórias de décadas atrás
????????????????????????????????????????????????????????????????????????
''';
        } else if (perspectiveLower.contains('madura')) {
          idadeInstrucao = '''
????????????????????????????????????????????????????????????????????????
?? FAIXA ETÁRIA OBRIGATÓRIA: MULHER MADURA (35-50 ANOS)
????????????????????????????????????????????????????????????????????????

? IDADE CORRETA: Entre 35 e 50 anos
? PERFIL: Mulher experiente, consolidada profissionalmente, possivelmente com filhos adolescentes
? CONTEXTO: Pode ter divórcio, segundo casamento, filhos crescidos, auge da carreira
? VOCABULÁRIO: Equilibrado, maduro, experiente mas ainda contemporâneo

? PROIBIDO: Mencionar aposentadoria, netos adultos, velhice
????????????????????????????????????????????????????????????????????????
''';
        } else if (perspectiveLower.contains('idosa')) {
          idadeInstrucao = '''
????????????????????????????????????????????????????????????????????????
?? FAIXA ETÁRIA OBRIGATÓRIA: MULHER IDOSA (50+ ANOS)
????????????????????????????????????????????????????????????????????????

? IDADE CORRETA: Acima de 50 anos
? PERFIL: Mulher com muita experiência de vida, possivelmente aposentada ou perto
? CONTEXTO: Pode ter netos, viuvez, legado familiar, reflexões sobre a vida
? VOCABULÁRIO: Sábio, reflexivo, com histórias de décadas atrás

? PROIBIDO: Agir como jovem, usar gírias recentes inadequadas à idade
????????????????????????????????????????????????????????????????????????
''';
        }

        nomeInstrucao =
            '''
+------------------------------------------------------------------------------+
 ?????? GÊNERO OBRIGATÓRIO: FEMININO (MULHER) - CONFIGURAÇÃO DO USUÁRIO ?????? 
+------------------------------------------------------------------------------+

?????? REGRA ABSOLUTA - NÃO NEGOCIÁVEL ??????

O USUÁRIO CONFIGUROU EXPLICITAMENTE: "Primeira Pessoa MULHER"
VOCÊ DEVE, OBRIGATORIAMENTE, GERAR UM PROTAGONISTA FEMININO!

?? VALIDAÇÃO ANTES DE ESCREVER A PRIMEIRA FRASE:
? "O protagonista que vou criar é MULHER?" 
   ? Se SIM = Prossiga
   ? Se NÃO = PARE! Você está DESOBEDECENDO a configuração do usuário!

????????????????????????????????????????????????????????????????????????

?? REGRAS DE NOMES:

1?? SE O TÍTULO MENCIONAR UM NOME ESPECÍFICO (ex: "Você é Maria?"):
   ? USE ESTE NOME para a protagonista
   ? Exemplo: Se título diz "Maria", protagonista é "Maria"

2?? SE O TÍTULO NÃO MENCIONAR NENHUM NOME (ex: "Un milliardaire m'a donné..."):
   ? VOCÊ DEVE CRIAR um nome FEMININO apropriado para o idioma
   
   ?? Nomes femininos por idioma:
    Français: Sophie, Marie, Amélie, Claire, Camille, Emma, Louise, Chloé
    Português: Maria, Ana, Sofia, Helena, Clara, Beatriz, Julia, Laura
    English: Emma, Sarah, Jennifer, Emily, Jessica, Ashley, Michelle, Amanda
    Español: María, Carmen, Laura, Ana, Isabel, Rosa, Elena, Sofia
    ??? (Korean): Kim Ji-young, Park Soo-yeon, Lee Min-ji, Choi Hye-jin, Jung Yoo-na
     ?? COREANO: SEMPRE use SOBRENOME + NOME (ex: "Kim Ji-young", NÃO "Ji-young")
   
   ? PROIBIDO: João, Pedro, Carlos, Michael, Roberto, Pierre, Jean, Marc
   ? JAMAIS use nomes MASCULINOS quando o narrador é MULHER!

$idadeInstrucao

?? SE VOCÊ CRIAR UM PROTAGONISTA MASCULINO, O ROTEIRO SERÁ REJEITADO!
????????????????????????????????????????????????????????????????????????

''';
      } else if (perspectiveLower.contains('homem')) {
        exemplos =
            '"EU construí esse negócio...", "MEU filho me abandonou...", "COMIGO ele sempre foi desleal..."';

        // ?? DETECTAR FAIXA ETÁRIA E ADICIONAR INSTRUÇÕES ESPECÍFICAS
        String idadeInstrucao = '';
        if (perspectiveLower.contains('jovem')) {
          idadeInstrucao = '''
????????????????????????????????????????????????????????????????????????
?? FAIXA ETÁRIA OBRIGATÓRIA: HOMEM JOVEM (20-35 ANOS)
????????????????????????????????????????????????????????????????????????

? IDADE CORRETA: Entre 20 e 35 anos
? PERFIL: Homem adulto jovem, início/meio da carreira, possivelmente casado/solteiro, energético
? CONTEXTO: Pode ter filhos pequenos, focado em crescimento profissional/pessoal
? VOCABULÁRIO: Moderno, atual, referências contemporâneas

? PROIBIDO: Mencionar aposentadoria, netos, memórias de décadas atrás
????????????????????????????????????????????????????????????????????????
''';
        } else if (perspectiveLower.contains('maduro')) {
          idadeInstrucao = '''
????????????????????????????????????????????????????????????????????????
?? FAIXA ETÁRIA OBRIGATÓRIA: HOMEM MADURO (35-50 ANOS)
????????????????????????????????????????????????????????????????????????

? IDADE CORRETA: Entre 35 e 50 anos
? PERFIL: Homem experiente, consolidado profissionalmente, possivelmente com filhos adolescentes
? CONTEXTO: Pode ter divórcio, segundo casamento, filhos crescidos, auge da carreira
? VOCABULÁRIO: Equilibrado, maduro, experiente mas ainda contemporâneo

? PROIBIDO: Mencionar aposentadoria, netos adultos, velhice
????????????????????????????????????????????????????????????????????????
''';
        } else if (perspectiveLower.contains('idoso')) {
          idadeInstrucao = '''
????????????????????????????????????????????????????????????????????????
?? FAIXA ETÁRIA OBRIGATÓRIA: HOMEM IDOSO (50+ ANOS)
????????????????????????????????????????????????????????????????????????

? IDADE CORRETA: Acima de 50 anos
? PERFIL: Homem com muita experiência de vida, possivelmente aposentado ou perto
? CONTEXTO: Pode ter netos, viuvez, legado familiar, reflexões sobre a vida
? VOCABULÁRIO: Sábio, reflexivo, com histórias de décadas atrás

? PROIBIDO: Agir como jovem, usar gírias recentes inadequadas à idade
????????????????????????????????????????????????????????????????????????
''';
        }

        nomeInstrucao =
            '''
+------------------------------------------------------------------------------+
 ?????? GÊNERO OBRIGATÓRIO: MASCULINO (HOMEM) - CONFIGURAÇÃO DO USUÁRIO ?????? 
+------------------------------------------------------------------------------+

?????? REGRA ABSOLUTA - NÃO NEGOCIÁVEL ??????

O USUÁRIO CONFIGUROU EXPLICITAMENTE: "Primeira Pessoa HOMEM"
VOCÊ DEVE, OBRIGATORIAMENTE, GERAR UM PROTAGONISTA MASCULINO!

?? VALIDAÇÃO ANTES DE ESCREVER A PRIMEIRA FRASE:
? "O protagonista que vou criar é HOMEM?" 
   ? Se SIM = Prossiga
   ? Se NÃO = PARE! Você está DESOBEDECENDO a configuração do usuário!

????????????????????????????????????????????????????????????????????????

?? REGRAS DE NOMES:

1?? SE O TÍTULO MENCIONAR UM NOME ESPECÍFICO (ex: "Você é Michael?"):
   ? USE ESTE NOME para o protagonista
   ? Exemplo: Se título diz "Michael", protagonista é "Michael"

2?? SE O TÍTULO NÃO MENCIONAR NENHUM NOME (ex: "Un milliardaire m'a donné..."):
   ? VOCÊ DEVE CRIAR um nome MASCULINO apropriado para o idioma
   
   ?? Nomes masculinos por idioma:
    Français: Pierre, Jean, Marc, Luc, Antoine, Thomas, Nicolas, Julien
    Português: João, Pedro, Carlos, Roberto, Alberto, Paulo, Fernando, Ricardo
    English: John, Michael, David, James, Robert, William, Richard, Thomas
    Español: Juan, Pedro, Carlos, José, Luis, Miguel, Antonio, Francisco
    ??? (Korean): Kim Seon-woo, Park Jae-hyun, Lee Min-ho, Choi Dong-wook, Jung Tae-hyun
     ?? COREANO: SEMPRE use SOBRENOME + NOME (ex: "Kim Seon-woo", NÃO "Seon-woo")
   
   ? PROIBIDO: Maria, Ana, Sofia, Sophie, Mónica, Clara, Helena, Emma
   ? JAMAIS use nomes FEMININOS quando o narrador é HOMEM!

$idadeInstrucao

?? SE VOCÊ CRIAR UM PROTAGONISTA FEMININO, O ROTEIRO SERÁ REJEITADO!
????????????????????????????????????????????????????????????????????????

''';
      }

      return '''PERSPECTIVA NARRATIVA: PRIMEIRA PESSOA$protagonistInfo
$nomeInstrucao
?? CRÍTICO: O PROTAGONISTA conta SUA PRÓPRIA HISTÓRIA usando "$pronomes".
?? PROIBIDO usar "ELE", "ELA", "DELE", "DELA" para o protagonista!
? CORRETO: $exemplos
O protagonista é o narrador. Ele/Ela está contando os eventos da SUA perspectiva em primeira pessoa.''';
    }

    // Terceira pessoa (padrão)
    return '''PERSPECTIVA NARRATIVA: TERCEIRA PESSOA$protagonistInfo
?? IMPORTANTE: Um NARRADOR EXTERNO conta a história do protagonista usando "ELE", "ELA", "DELE", "DELA".
Exemplo: "ELA vendeu a casa...", "O coração DELE batia forte...", "COM ELA, ninguém foi honesto...".
O narrador observa e conta, mas NÃO é o protagonista.''';
  }
}
